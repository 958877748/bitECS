import{observe as Z,onAdd as Ce,onRemove as Se,query as he,addComponent as ze,hasComponent as xe,removeComponent as We}from"bitecs";import{addComponent as M,removeComponent as H,addEntity as me,removeEntity as fe,observe as F,onAdd as Q,onRemove as j,entityExists as Ae,isRelation as be,getRelationTargets as de,Wildcard as J}from"bitecs";var g=Symbol.for("bitecs-u8"),h=Symbol.for("bitecs-i8"),C=Symbol.for("bitecs-u16"),z=Symbol.for("bitecs-i16"),A=Symbol.for("bitecs-u32"),x=Symbol.for("bitecs-i32"),S=Symbol.for("bitecs-f32"),R=Symbol.for("bitecs-f64"),O=Symbol.for("bitecs-arr"),U=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),_=U(g),ee=U(h),re=U(C),te=U(z),ne=U(A),oe=U(x),ie=U(S),ae=U(R),ye=new Map([[_,g],[ee,h],[re,C],[te,z],[ne,A],[oe,x],[ie,S],[ae,R]]),T={[g]:(e,r,t)=>(e.setUint8(r,t),1),[h]:(e,r,t)=>(e.setInt8(r,t),1),[C]:(e,r,t)=>(e.setUint16(r,t),2),[z]:(e,r,t)=>(e.setInt16(r,t),2),[A]:(e,r,t)=>(e.setUint32(r,t),4),[x]:(e,r,t)=>(e.setInt32(r,t),4),[S]:(e,r,t)=>(e.setFloat32(r,t),4),[R]:(e,r,t)=>(e.setFloat64(r,t),8)},I={[g]:(e,r)=>({value:e.getUint8(r),size:1}),[h]:(e,r)=>({value:e.getInt8(r),size:1}),[C]:(e,r)=>({value:e.getUint16(r),size:2}),[z]:(e,r)=>({value:e.getInt16(r),size:2}),[A]:(e,r)=>({value:e.getUint32(r),size:4}),[x]:(e,r)=>({value:e.getInt32(r),size:4}),[S]:(e,r)=>({value:e.getFloat32(r),size:4}),[R]:(e,r)=>({value:e.getFloat64(r),size:8})};function P(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let r=ye.get(e);if(r)return r;throw new Error(`Unknown type function: ${e}`)}return W(e)?P(e[O]):S}function k(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function $(e){if(W(e))return P(e[O]);for(let r of[g,h,C,z,A,x,S,R])if(r in e)return r;return e instanceof Int8Array?h:e instanceof Uint8Array?g:e instanceof Int16Array?z:e instanceof Uint16Array?C:e instanceof Int32Array?x:e instanceof Uint32Array?A:e instanceof Float32Array?S:R}function W(e){return Array.isArray(e)&&O in e}function D(e){return e[O]}function V(e,r,t,n){let y=0,s=Array.isArray(r)?1:0;if(y+=T[g](t,n,s),!s)return y;y+=T[A](t,n+y,r.length);for(let o=0;o<r.length;o++){let a=r[o];if(W(e))y+=V(D(e),a,t,n+y);else{let i=P(e);y+=T[i](t,n+y,a)}}return y}function E(e,r,t){let n=0,y=I[g](r,t+n);if(n+=y.size,!y.value)return{size:n};let s=I[A](r,t+n);n+=s.size;let o=new Array(s.value);for(let a=0;a<o.length;a++)if(W(e)){let{value:i,size:p}=E(D(e),r,t+n);n+=p,Array.isArray(i)&&(o[a]=i)}else{let i=P(e),{value:p,size:u}=I[i](r,t+n);n+=u,o[a]=p}return{value:o,size:n}}var se=e=>{let r=$(e);return r===S||r===R},pe=(e,r)=>se(e)?r:0,ue=(e,r)=>{let t=e.get(r);return t||(ArrayBuffer.isView(r)?t=new r.constructor(r.length):t=new Array(r.length).fill(0),e.set(r,t)),t},L=(e,r,t,n=1e-4)=>{let y=ue(e,r),s=r[t],o=pe(r,n),a=o>0?Math.abs(y[t]-s)>o:y[t]!==s;return y[t]=s,a},le=(e,r=!1,t,n=1e-4)=>{if(k(e)){let a=$(e),i=T[a];return(p,u,l,c)=>{if(r&&t){if(!L(t,e,l,n))return 0;let m=0;return m+=T[A](p,u+m,l),m+=T[A](p,u+m,c),m+=i(p,u+m,e[l]),m}else{let m=0;return m+=T[A](p,u+m,l),m+=i(p,u+m,e[l]),m}}}let y=Object.keys(e),o=y.map(a=>{let i=e[a];if(!k(i))throw new Error(`Invalid array type for property ${a}`);return $(i)}).map(a=>T[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,i,p,u)=>{if(r&&t){let l=0;for(let b=0;b<y.length;b++){let f=e[y[b]];L(t,f,p,n)&&(l|=1<<b)}if(l===0)return 0;let c=0;c+=T[A](a,i+c,p),c+=T[A](a,i+c,u);let m=y.length<=8?T[g]:y.length<=16?T[C]:T[A];c+=m(a,i+c,l);for(let b=0;b<y.length;b++)if(l&1<<b){let f=e[y[b]];W(f)?c+=V(D(f),f[p],a,i+c):c+=o[b](a,i+c,f[p])}return c}else{let l=0;l+=T[A](a,i+l,p);for(let c=0;c<y.length;c++){let m=e[y[c]];W(m)?l+=V(D(m),m[p],a,i+l):l+=o[c](a,i+l,m[p])}return l}}},ce=(e,r=!1)=>{if(k(e)){let s=$(e),o=I[s];return(a,i,p)=>{let u=0,{value:l,size:c}=I[A](a,i);u+=c;let m=p?p.get(l)??l:l;if(r){let{size:d}=I[A](a,i+u);u+=d}let{value:b,size:f}=o(a,i+u);return e[m]=b,u+f}}let t=Object.keys(e),y=t.map(s=>{let o=e[s];if(!k(o))throw new Error(`Invalid array type for property ${s}`);return $(o)}).map(s=>I[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,o,a)=>{let i=0,{value:p,size:u}=I[A](s,o+i);i+=u;let l=a?a.get(p)??p:p;if(r){let{size:c}=I[A](s,o+i);i+=c;let m=t.length<=8?I[g]:t.length<=16?I[C]:I[A],{value:b,size:f}=m(s,o+i);i+=f;for(let d=0;d<t.length;d++)if(b&1<<d){let v=e[t[d]];if(W(v)){let{value:B,size:w}=E(D(v),s,o+i);Array.isArray(B)&&(v[l]=B),i+=w}else{let{value:B,size:w}=y[d](s,o+i);e[t[d]][l]=B,i+=w}}}else for(let c=0;c<t.length;c++){let m=e[t[c]];if(W(m)){let{value:b,size:f}=E(D(m),s,o+i);Array.isArray(b)&&(m[l]=b),i+=f}else{let{value:b,size:f}=y[c](s,o+i);e[t[c]][l]=b,i+=f}}return i}},G=(e,r={})=>{let{diff:t=!1,buffer:n=new ArrayBuffer(1024*1024*100),epsilon:y=1e-4}=r,s=new DataView(n),o=t?new Map:void 0,a=e.map(i=>le(i,t,o,y));return i=>{let p=0;for(let u=0;u<i.length;u++){let l=i[u];for(let c=0;c<a.length;c++)p+=a[c](s,p,l,c)}return n.slice(0,p)}},N=(e,r={})=>{let{diff:t=!1}=r,n=e.map(y=>ce(y,t));return(y,s)=>{let o=new DataView(y),a=0;for(;a<y.byteLength;)if(t){let{value:i,size:p}=I[A](o,a),{value:u,size:l}=I[A](o,a+p);a+=n[u](o,a,s)}else for(let i=0;i<n.length;i++)a+=n[i](o,a,s)}};function Te(e,r,t,n){if(!e)return n;if(Array.isArray(e)){let y=e[r];return y!==void 0?(t.setFloat64(n,y),n+8):n}if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s],a=o[r];a!==void 0&&(o instanceof Int8Array||h in o?(t.setInt8(n,a),n+=1):o instanceof Uint8Array||g in o?(t.setUint8(n,a),n+=1):o instanceof Int16Array||z in o?(t.setInt16(n,a),n+=2):o instanceof Uint16Array||C in o?(t.setUint16(n,a),n+=2):o instanceof Int32Array||x in o?(t.setInt32(n,a),n+=4):o instanceof Uint32Array||A in o?(t.setUint32(n,a),n+=4):o instanceof Float32Array||S in o?(t.setFloat32(n,a),n+=4):(t.setFloat64(n,a),n+=8))}}return n}function Ie(e,r,t,n){if(!e)return n;if(Array.isArray(e))return e[r]=t.getFloat64(n),n+8;if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s];o instanceof Int8Array||h in o?(o[r]=t.getInt8(n),n+=1):o instanceof Uint8Array||g in o?(o[r]=t.getUint8(n),n+=1):o instanceof Int16Array||z in o?(o[r]=t.getInt16(n),n+=2):o instanceof Uint16Array||C in o?(o[r]=t.getUint16(n),n+=2):o instanceof Int32Array||x in o?(o[r]=t.getInt32(n),n+=4):o instanceof Uint32Array||A in o?(o[r]=t.getUint32(n),n+=4):o instanceof Float32Array||S in o?(o[r]=t.getFloat32(n),n+=4):(o[r]=t.getFloat64(n),n+=8)}}return n}var K=(e,r,t,n=new ArrayBuffer(1024*1024*100))=>{let y=new DataView(n),s=0,o=[],a=new Map;return F(e,Q(r),i=>{o.push([i,0,-1])}),F(e,j(r),i=>{o.push([i,1,-1]),a.delete(i)}),t.forEach((i,p)=>{be(i)?(F(e,Q(r,i(J)),u=>{let l=de(e,u,i);for(let c of l){a.has(u)||a.set(u,new Map),a.get(u).set(p,c);let m=i(c);o.push([u,4,p,c,m])}}),F(e,j(r,i(J)),u=>{let l=a.get(u);if(l){let c=l.get(p);c!==void 0&&(o.push([u,5,p,c]),l.delete(p),l.size===0&&a.delete(u))}})):(F(e,Q(r,i),u=>{o.push([u,2,p])}),F(e,j(r,i),u=>{o.push([u,3,p])}))}),()=>{s=0;for(let i=0;i<o.length;i++){let[p,u,l,c,m]=o[i];y.setUint32(s,p),s+=4,y.setUint8(s,u),s+=1,(u===2||u===3||u===4||u===5)&&(y.setUint8(s,l),s+=1,(u===4||u===5)&&(y.setUint32(s,c),s+=4,u===4&&m&&(s=Te(m,p,y,s))))}return o.length=0,n.slice(0,s)}},X=(e,r,t,n)=>{let y=n||new Map;return(s,o)=>{let a=o||y,i=new DataView(s),p=0;for(;p<s.byteLength;){let u=i.getUint32(p);p+=4;let l=i.getUint8(p);p+=1;let c=-1,m=-1;(l===2||l===3||l===4||l===5)&&(c=i.getUint8(p),p+=1,(l===4||l===5)&&(m=i.getUint32(p),p+=4));let b=t[c],f=a.get(u);if(l===0)f===void 0?(f=me(e),a.set(u,f),M(e,f,r)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(f!==void 0&&Ae(e,f)){if(l===1)fe(e,f),a.delete(u);else if(l===2)M(e,f,b);else if(l===3)H(e,f,b);else if(l===4){let d=a.get(m);if(d!==void 0){let v=b(d);M(e,f,v),p=Ie(v,f,i,p)}}else if(l===5){let d=a.get(m);d!==void 0&&H(e,f,b(d))}}}return a}};function we(e,r){let t=new WeakSet,n,y;return(s,o)=>{t.has(s)||(t.add(s),n=K(s,e[0],e),y=G(e));let a=n(),i=y(o),p=new ArrayBuffer(a.byteLength+i.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(a),0),u.set(new Uint8Array(i),a.byteLength),p}}function Ve(e){let r=new WeakSet,t,n;return(y,s,o)=>{r.has(y)||(r.add(y),t=X(y,e[0],e),n=N(e));let a=t(s,o),i=s.slice(a);return n(i,o)}}var ge=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(ge||{});var Ue=Symbol("$modifier");function q(e,r){let t=()=>[e,r];return t[Ue]=!0,t}var qe=e=>q(e,"not"),Le=e=>q(e,"or"),Ge=e=>q(e,"changed");function Ne(e){let r=t=>he(t,e);return r.components=e,r}function He(e){let r=[],t=new WeakSet;return n=>{t.has(n)||(Z(n,Ce(...e.components),s=>r.push(s)),t.add(n));let y=r.slice();return r.length=0,y}}function Je(e){let r=[],t=new WeakSet;return n=>{t.has(n)||(Z(n,Se(...e.components),s=>r.push(s)),t.add(n));let y=r.slice();return r.length=0,y}}var Ke=(e,r,t)=>ze(e,t,r),Xe=(e,r,t)=>xe(e,t,r),Ye=(e,r,t)=>We(e,t,r),Ze={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},Y={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},_e=(e,r=1e5)=>{let t=(n,y)=>{let s={};for(let o in n)if(Array.isArray(n[o])){let[a,i]=n[o];s[o]=Array.from({length:i},()=>new Y[a](y))}else if(typeof n[o]=="object")s[o]=t(n[o],y);else{let a=n[o],i=Y[a];if(i)s[o]=new i(y);else throw new Error(`Unsupported type: ${n[o]}`)}return s};return t(e,r)};export{Ue as $modifier,Ge as Changed,ge as DESERIALIZE_MODE,qe as Not,Le as Or,Ze as Types,Ke as addComponent,_e as defineComponent,Ve as defineDeserializer,Ne as defineQuery,we as defineSerializer,He as enterQuery,Je as exitQuery,Xe as hasComponent,Ye as removeComponent};
//# sourceMappingURL=index.min.mjs.map
