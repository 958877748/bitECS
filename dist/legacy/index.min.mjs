import{observe as _,onAdd as Ce,onRemove as We,query as Re,addComponent as Ue,hasComponent as ve,removeComponent as De}from"bitecs";import{addComponent as Q,removeComponent as J,addEntity as Ae,removeEntity as Te,observe as F,onAdd as j,onRemove as q,entityExists as Ie,isRelation as ge,getRelationTargets as Se,Wildcard as K}from"bitecs";var g=Symbol.for("bitecs-u8"),z=Symbol.for("bitecs-i8"),S=Symbol.for("bitecs-u16"),x=Symbol.for("bitecs-i16"),b=Symbol.for("bitecs-u32"),C=Symbol.for("bitecs-i32"),h=Symbol.for("bitecs-f32"),U=Symbol.for("bitecs-f64"),w=Symbol.for("bitecs-str"),k=Symbol.for("bitecs-arr"),W=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ee=W(g),te=W(z),re=W(S),ne=W(x),oe=W(b),ie=W(C),ae=W(h),ye=W(U),se=W(w),pe=new Map([[ee,g],[te,z],[re,S],[ne,x],[oe,b],[ie,C],[ae,h],[ye,U],[se,w]]),A={[g]:(e,t,r)=>(e.setUint8(t,r),1),[z]:(e,t,r)=>(e.setInt8(t,r),1),[S]:(e,t,r)=>(e.setUint16(t,r),2),[x]:(e,t,r)=>(e.setInt16(t,r),2),[b]:(e,t,r)=>(e.setUint32(t,r),4),[C]:(e,t,r)=>(e.setInt32(t,r),4),[h]:(e,t,r)=>(e.setFloat32(t,r),4),[U]:(e,t,r)=>(e.setFloat64(t,r),8),[w]:(e,t,r)=>{let y=ue.encode(r),s=0;return s+=A[b](e,t+s,y.length),new Uint8Array(e.buffer,e.byteOffset+t+s,y.length).set(y),s+=y.length,s}},T={[g]:(e,t)=>({value:e.getUint8(t),size:1}),[z]:(e,t)=>({value:e.getInt8(t),size:1}),[S]:(e,t)=>({value:e.getUint16(t),size:2}),[x]:(e,t)=>({value:e.getInt16(t),size:2}),[b]:(e,t)=>({value:e.getUint32(t),size:4}),[C]:(e,t)=>({value:e.getInt32(t),size:4}),[h]:(e,t)=>({value:e.getFloat32(t),size:4}),[U]:(e,t)=>({value:e.getFloat64(t),size:8}),[w]:(e,t)=>{let{value:r,size:n}=T[b](e,t),y=new Uint8Array(e.buffer,e.byteOffset+t+n,r);return{value:le.decode(y),size:n+r}}};function V(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let t=pe.get(e);if(t)return t;throw new Error(`Unknown type function: ${e}`)}return R(e)?V(e[k]):h}var ue=new TextEncoder,le=new TextDecoder;function O(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function $(e){if(R(e))return V(e[k]);for(let t of[g,z,S,x,b,C,h,U,w])if(t in e)return t;return e instanceof Int8Array?z:e instanceof Uint8Array?g:e instanceof Int16Array?x:e instanceof Uint16Array?S:e instanceof Int32Array?C:e instanceof Uint32Array?b:e instanceof Float32Array?h:U}function R(e){return Array.isArray(e)&&k in e}function D(e){return e[k]}function E(e,t,r,n){let y=0,s=Array.isArray(t)?1:0;if(y+=A[g](r,n,s),!s)return y;y+=A[b](r,n+y,t.length);for(let o=0;o<t.length;o++){let a=t[o];if(R(e))y+=E(D(e),a,r,n+y);else{let i=V(e);y+=A[i](r,n+y,a)}}return y}function M(e,t,r){let n=0,y=T[g](t,r+n);if(n+=y.size,!y.value)return{size:n};let s=T[b](t,r+n);n+=s.size;let o=new Array(s.value);for(let a=0;a<o.length;a++)if(R(e)){let{value:i,size:p}=M(D(e),t,r+n);n+=p,Array.isArray(i)&&(o[a]=i)}else{let i=V(e),{value:p,size:u}=T[i](t,r+n);n+=u,o[a]=p}return{value:o,size:n}}var ce=e=>{let t=$(e);return t===h||t===U},me=(e,t)=>ce(e)?t:0,fe=(e,t)=>{let r=e.get(t);return r||(ArrayBuffer.isView(t)?r=new t.constructor(t.length):r=new Array(t.length).fill(0),e.set(t,r)),r},G=(e,t,r,n=1e-4)=>{let y=fe(e,t),s=t[r],o=me(t,n),a=o>0?Math.abs(y[r]-s)>o:y[r]!==s;return y[r]=s,a},be=(e,t=!1,r,n=1e-4)=>{if(O(e)){let a=$(e),i=A[a];return(p,u,l,c)=>{if(t&&r){if(!G(r,e,l,n))return 0;let m=0;return m+=A[b](p,u+m,l),m+=A[b](p,u+m,c),m+=i(p,u+m,e[l]),m}else{let m=0;return m+=A[b](p,u+m,l),m+=i(p,u+m,e[l]),m}}}let y=Object.keys(e),o=y.map(a=>{let i=e[a];if(!O(i))throw new Error(`Invalid array type for property ${a}`);return $(i)}).map(a=>A[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,i,p,u)=>{if(t&&r){let l=0;for(let d=0;d<y.length;d++){let f=e[y[d]];G(r,f,p,n)&&(l|=1<<d)}if(l===0)return 0;let c=0;c+=A[b](a,i+c,p),c+=A[b](a,i+c,u);let m=y.length<=8?A[g]:y.length<=16?A[S]:A[b];c+=m(a,i+c,l);for(let d=0;d<y.length;d++)if(l&1<<d){let f=e[y[d]];R(f)?c+=E(D(f),f[p],a,i+c):c+=o[d](a,i+c,f[p])}return c}else{let l=0;l+=A[b](a,i+l,p);for(let c=0;c<y.length;c++){let m=e[y[c]];R(m)?l+=E(D(m),m[p],a,i+l):l+=o[c](a,i+l,m[p])}return l}}},de=(e,t=!1)=>{if(O(e)){let s=$(e),o=T[s];return(a,i,p)=>{let u=0,{value:l,size:c}=T[b](a,i);u+=c;let m=p?p.get(l)??l:l;if(t){let{size:I}=T[b](a,i+u);u+=I}let{value:d,size:f}=o(a,i+u);return e[m]=d,u+f}}let r=Object.keys(e),y=r.map(s=>{let o=e[s];if(!O(o))throw new Error(`Invalid array type for property ${s}`);return $(o)}).map(s=>T[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,o,a)=>{let i=0,{value:p,size:u}=T[b](s,o+i);i+=u;let l=a?a.get(p)??p:p;if(t){let{size:c}=T[b](s,o+i);i+=c;let m=r.length<=8?T[g]:r.length<=16?T[S]:T[b],{value:d,size:f}=m(s,o+i);i+=f;for(let I=0;I<r.length;I++)if(d&1<<I){let v=e[r[I]];if(R(v)){let{value:B,size:P}=M(D(v),s,o+i);Array.isArray(B)&&(v[l]=B),i+=P}else{let{value:B,size:P}=y[I](s,o+i);e[r[I]][l]=B,i+=P}}}else for(let c=0;c<r.length;c++){let m=e[r[c]];if(R(m)){let{value:d,size:f}=M(D(m),s,o+i);Array.isArray(d)&&(m[l]=d),i+=f}else{let{value:d,size:f}=y[c](s,o+i);e[r[c]][l]=d,i+=f}}return i}},N=(e,t={})=>{let{diff:r=!1,buffer:n=new ArrayBuffer(1024*1024*100),epsilon:y=1e-4}=t,s=new DataView(n),o=r?new Map:void 0,a=e.map(i=>be(i,r,o,y));return i=>{let p=0;for(let u=0;u<i.length;u++){let l=i[u];for(let c=0;c<a.length;c++)p+=a[c](s,p,l,c)}return n.slice(0,p)}},H=(e,t={})=>{let{diff:r=!1}=t,n=e.map(y=>de(y,r));return(y,s)=>{let o=new DataView(y),a=0;for(;a<y.byteLength;)if(r){let{value:i,size:p}=T[b](o,a),{value:u,size:l}=T[b](o,a+p);a+=n[u](o,a,s)}else for(let i=0;i<n.length;i++)a+=n[i](o,a,s)}};function he(e,t,r,n){if(!e)return n;if(Array.isArray(e)){let y=e[t];return y!==void 0?(r.setFloat64(n,y),n+8):n}if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s],a=o[t];a!==void 0&&(o instanceof Int8Array||z in o?(r.setInt8(n,a),n+=1):o instanceof Uint8Array||g in o?(r.setUint8(n,a),n+=1):o instanceof Int16Array||x in o?(r.setInt16(n,a),n+=2):o instanceof Uint16Array||S in o?(r.setUint16(n,a),n+=2):o instanceof Int32Array||C in o?(r.setInt32(n,a),n+=4):o instanceof Uint32Array||b in o?(r.setUint32(n,a),n+=4):o instanceof Float32Array||h in o?(r.setFloat32(n,a),n+=4):(r.setFloat64(n,a),n+=8))}}return n}function ze(e,t,r,n){if(!e)return n;if(Array.isArray(e))return e[t]=r.getFloat64(n),n+8;if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s];o instanceof Int8Array||z in o?(o[t]=r.getInt8(n),n+=1):o instanceof Uint8Array||g in o?(o[t]=r.getUint8(n),n+=1):o instanceof Int16Array||x in o?(o[t]=r.getInt16(n),n+=2):o instanceof Uint16Array||S in o?(o[t]=r.getUint16(n),n+=2):o instanceof Int32Array||C in o?(o[t]=r.getInt32(n),n+=4):o instanceof Uint32Array||b in o?(o[t]=r.getUint32(n),n+=4):o instanceof Float32Array||h in o?(o[t]=r.getFloat32(n),n+=4):(o[t]=r.getFloat64(n),n+=8)}}return n}var X=(e,t,r,n=new ArrayBuffer(1024*1024*100))=>{let y=new DataView(n),s=0,o=[],a=new Map;return F(e,j(t),i=>{o.push([i,0,-1])}),F(e,q(t),i=>{o.push([i,1,-1]),a.delete(i)}),r.forEach((i,p)=>{ge(i)?(F(e,j(t,i(K)),u=>{let l=Se(e,u,i);for(let c of l){a.has(u)||a.set(u,new Map),a.get(u).set(p,c);let m=i(c);o.push([u,4,p,c,m])}}),F(e,q(t,i(K)),u=>{let l=a.get(u);if(l){let c=l.get(p);c!==void 0&&(o.push([u,5,p,c]),l.delete(p),l.size===0&&a.delete(u))}})):(F(e,j(t,i),u=>{o.push([u,2,p])}),F(e,q(t,i),u=>{o.push([u,3,p])}))}),()=>{s=0;for(let i=0;i<o.length;i++){let[p,u,l,c,m]=o[i];y.setUint32(s,p),s+=4,y.setUint8(s,u),s+=1,(u===2||u===3||u===4||u===5)&&(y.setUint8(s,l),s+=1,(u===4||u===5)&&(y.setUint32(s,c),s+=4,u===4&&m&&(s=he(m,p,y,s))))}return o.length=0,n.slice(0,s)}},Y=(e,t,r,n)=>{let y=n||new Map;return(s,o)=>{let a=o||y,i=new DataView(s),p=0;for(;p<s.byteLength;){let u=i.getUint32(p);p+=4;let l=i.getUint8(p);p+=1;let c=-1,m=-1;(l===2||l===3||l===4||l===5)&&(c=i.getUint8(p),p+=1,(l===4||l===5)&&(m=i.getUint32(p),p+=4));let d=r[c],f=a.get(u);if(l===0)f===void 0?(f=Ae(e),a.set(u,f),Q(e,f,t)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(f!==void 0&&Ie(e,f)){if(l===1)Te(e,f),a.delete(u);else if(l===2)Q(e,f,d);else if(l===3)J(e,f,d);else if(l===4){let I=a.get(m);if(I!==void 0){let v=d(I);Q(e,f,v),p=ze(v,f,i,p)}}else if(l===5){let I=a.get(m);I!==void 0&&J(e,f,d(I))}}}return a}};function Qe(e,t){let r=new WeakSet,n,y;return(s,o)=>{r.has(s)||(r.add(s),n=X(s,e[0],e),y=N(e));let a=n(),i=y(o),p=new ArrayBuffer(a.byteLength+i.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(a),0),u.set(new Uint8Array(i),a.byteLength),p}}function je(e){let t=new WeakSet,r,n;return(y,s,o)=>{t.has(y)||(t.add(y),r=Y(y,e[0],e),n=H(e));let a=r(s,o),i=s.slice(a);return n(i,o)}}var xe=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(xe||{});var Fe=Symbol("$modifier");function L(e,t){let r=()=>[e,t];return r[Fe]=!0,r}var He=e=>L(e,"not"),Je=e=>L(e,"or"),Ke=e=>L(e,"changed");function Xe(e){let t=r=>Re(r,e);return t.components=e,t}function Ye(e){let t=[],r=new WeakSet;return n=>{r.has(n)||(_(n,Ce(...e.components),s=>t.push(s)),r.add(n));let y=t.slice();return t.length=0,y}}function Ze(e){let t=[],r=new WeakSet;return n=>{r.has(n)||(_(n,We(...e.components),s=>t.push(s)),r.add(n));let y=t.slice();return t.length=0,y}}var _e=(e,t,r)=>Ue(e,r,t),et=(e,t,r)=>ve(e,r,t),tt=(e,t,r)=>De(e,r,t),rt={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},Z={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},nt=(e,t=1e5)=>{let r=(n,y)=>{let s={};for(let o in n)if(Array.isArray(n[o])){let[a,i]=n[o];s[o]=Array.from({length:i},()=>new Z[a](y))}else if(typeof n[o]=="object")s[o]=r(n[o],y);else{let a=n[o],i=Z[a];if(i)s[o]=new i(y);else throw new Error(`Unsupported type: ${n[o]}`)}return s};return r(e,t)};export{Fe as $modifier,Ke as Changed,xe as DESERIALIZE_MODE,He as Not,Je as Or,rt as Types,_e as addComponent,nt as defineComponent,je as defineDeserializer,Xe as defineQuery,Qe as defineSerializer,Ye as enterQuery,Ze as exitQuery,et as hasComponent,tt as removeComponent};
//# sourceMappingURL=index.min.mjs.map
