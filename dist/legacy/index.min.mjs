import{observe as L,onAdd as re,onRemove as ne,query as ie,addComponent as oe,hasComponent as ae,removeComponent as ye}from"bitecs";import{addComponent as $,removeComponent as V,addEntity as J,removeEntity as K,observe as S,onAdd as w,onRemove as F,entityExists as X,isRelation as Y,getRelationTargets as Z,Wildcard as E}from"bitecs";var I=Symbol.for("bitecs-u8"),T=Symbol.for("bitecs-i8"),C=Symbol.for("bitecs-u16"),g=Symbol.for("bitecs-i16"),f=Symbol.for("bitecs-u32"),x=Symbol.for("bitecs-i32"),W=Symbol.for("bitecs-f32"),z=Symbol.for("bitecs-f64"),k=Symbol.for("bitecs-arr"),v=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),pe=v(I),ue=v(T),le=v(C),me=v(g),ce=v(f),de=v(x),fe=v(W),be=v(z),U={[I]:(e,t,i)=>(e.setUint8(t,i),1),[T]:(e,t,i)=>(e.setInt8(t,i),1),[C]:(e,t,i)=>(e.setUint16(t,i),2),[g]:(e,t,i)=>(e.setInt16(t,i),2),[f]:(e,t,i)=>(e.setUint32(t,i),4),[x]:(e,t,i)=>(e.setInt32(t,i),4),[W]:(e,t,i)=>(e.setFloat32(t,i),4),[z]:(e,t,i)=>(e.setFloat64(t,i),8)},R={[I]:(e,t)=>({value:e.getUint8(t),size:1}),[T]:(e,t)=>({value:e.getInt8(t),size:1}),[C]:(e,t)=>({value:e.getUint16(t),size:2}),[g]:(e,t)=>({value:e.getInt16(t),size:2}),[f]:(e,t)=>({value:e.getUint32(t),size:4}),[x]:(e,t)=>({value:e.getInt32(t),size:4}),[W]:(e,t)=>({value:e.getFloat32(t),size:4}),[z]:(e,t)=>({value:e.getFloat64(t),size:8})};function D(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function B(e){for(let t of[I,T,C,g,f,x,W,z])if(t in e)return t;return e instanceof Int8Array?T:e instanceof Uint8Array?I:e instanceof Int16Array?g:e instanceof Uint16Array?C:e instanceof Int32Array?x:e instanceof Uint32Array?f:e instanceof Float32Array?W:z}var N=e=>{if(D(e)){let y=B(e),o=U[y];return(n,a,s)=>{let u=0;return u+=U[f](n,a,s),u+=o(n,a+u,e[s]),u}}let t=Object.keys(e),r=t.map(y=>{let o=e[y];if(!D(o))throw new Error(`Invalid array type for property ${y}`);return B(o)}).map(y=>U[y]||(()=>{throw new Error("Unsupported or unannotated type")}));return(y,o,n)=>{let a=0;a+=U[f](y,o+a,n);for(let s=0;s<t.length;s++){let u=e[t[s]][k],p=e[t[s]][n];if(u===void 0){a+=r[s](y,o+a,p);continue}let l=Array.isArray(p);if(a+=U[I](y,o+a,l?1:0),!l)continue;let m=p,c=m.length;a+=U[f](y,o+a,c);for(let b=0;b<c;b++)a+=U[u](y,o+a,m[b])}return a}},H=e=>{if(D(e)){let y=B(e),o=R[y];return(n,a,s)=>{let u=0,{value:p,size:l}=R[f](n,a);u+=l;let m=s?s.get(p)??p:p,{value:c,size:b}=o(n,a+u);return e[m]=c,u+b}}let t=Object.keys(e),r=t.map(y=>{let o=e[y];if(!D(o))throw new Error(`Invalid array type for property ${y}`);return B(o)}).map(y=>R[y]||(()=>{throw new Error("Unsupported or unannotated type")}));return(y,o,n)=>{let a=0,{value:s,size:u}=R[f](y,o+a);a+=u;let p=n?n.get(s)??s:s;for(let l=0;l<t.length;l++){let m=e[t[l]][k];if(m===void 0){let{value:A,size:h}=r[l](y,o+a);e[t[l]][p]=A,a+=h;continue}let c=R[I](y,o+a);if(a+=c.size,!c.value)continue;let b=R[f](y,o+a);a+=b.size;let d=new Array(b.value);for(let A=0;A<d.length;A++){let{value:h,size:G}=R[m](y,o+a);a+=G,d[A]=h}e[t[l]][p]=d}return a}},P=(e,t=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(t),r=e.map(N);return y=>{let o=0;for(let n=0;n<y.length;n++){let a=y[n];for(let s=0;s<r.length;s++)o+=r[s](i,o,a)}return t.slice(0,o)}},Q=e=>{let t=e.map(H);return(i,r)=>{let y=new DataView(i),o=0;for(;o<i.byteLength;)for(let n=0;n<t.length;n++)o+=t[n](y,o,r)}};function _(e,t,i,r){if(!e)return r;if(Array.isArray(e)){let y=e[t];return y!==void 0?(i.setFloat64(r,y),r+8):r}if(typeof e=="object"){let y=Object.keys(e).sort();for(let o of y){let n=e[o],a=n[t];a!==void 0&&(n instanceof Int8Array||T in n?(i.setInt8(r,a),r+=1):n instanceof Uint8Array||I in n?(i.setUint8(r,a),r+=1):n instanceof Int16Array||g in n?(i.setInt16(r,a),r+=2):n instanceof Uint16Array||C in n?(i.setUint16(r,a),r+=2):n instanceof Int32Array||x in n?(i.setInt32(r,a),r+=4):n instanceof Uint32Array||f in n?(i.setUint32(r,a),r+=4):n instanceof Float32Array||W in n?(i.setFloat32(r,a),r+=4):(i.setFloat64(r,a),r+=8))}}return r}function ee(e,t,i,r){if(!e)return r;if(Array.isArray(e))return e[t]=i.getFloat64(r),r+8;if(typeof e=="object"){let y=Object.keys(e).sort();for(let o of y){let n=e[o];n instanceof Int8Array||T in n?(n[t]=i.getInt8(r),r+=1):n instanceof Uint8Array||I in n?(n[t]=i.getUint8(r),r+=1):n instanceof Int16Array||g in n?(n[t]=i.getInt16(r),r+=2):n instanceof Uint16Array||C in n?(n[t]=i.getUint16(r),r+=2):n instanceof Int32Array||x in n?(n[t]=i.getInt32(r),r+=4):n instanceof Uint32Array||f in n?(n[t]=i.getUint32(r),r+=4):n instanceof Float32Array||W in n?(n[t]=i.getFloat32(r),r+=4):(n[t]=i.getFloat64(r),r+=8)}}return r}var j=(e,t,i,r=new ArrayBuffer(1024*1024*100))=>{let y=new DataView(r),o=0,n=[],a=new Map;return S(e,w(t),s=>{n.push([s,0,-1])}),S(e,F(t),s=>{n.push([s,1,-1]),a.delete(s)}),i.forEach((s,u)=>{Y(s)?(S(e,w(t,s(E)),p=>{let l=Z(e,p,s);for(let m of l){a.has(p)||a.set(p,new Map),a.get(p).set(u,m);let c=s(m);n.push([p,4,u,m,c])}}),S(e,F(t,s(E)),p=>{let l=a.get(p);if(l){let m=l.get(u);m!==void 0&&(n.push([p,5,u,m]),l.delete(u),l.size===0&&a.delete(p))}})):(S(e,w(t,s),p=>{n.push([p,2,u])}),S(e,F(t,s),p=>{n.push([p,3,u])}))}),()=>{o=0;for(let s=0;s<n.length;s++){let[u,p,l,m,c]=n[s];y.setUint32(o,u),o+=4,y.setUint8(o,p),o+=1,(p===2||p===3||p===4||p===5)&&(y.setUint8(o,l),o+=1,(p===4||p===5)&&(y.setUint32(o,m),o+=4,p===4&&c&&(o=_(c,u,y,o))))}return n.length=0,r.slice(0,o)}},M=(e,t,i,r)=>{let y=r||new Map;return(o,n)=>{let a=n||y,s=new DataView(o),u=0;for(;u<o.byteLength;){let p=s.getUint32(u);u+=4;let l=s.getUint8(u);u+=1;let m=-1,c=-1;(l===2||l===3||l===4||l===5)&&(m=s.getUint8(u),u+=1,(l===4||l===5)&&(c=s.getUint32(u),u+=4));let b=i[m],d=a.get(p);if(l===0)d===void 0?(d=J(e),a.set(p,d),$(e,d,t)):console.warn(`Attempted to deserialize addEntity with ID ${p}, but it has already been deserialzied and exists in the mapping.`);else if(d!==void 0&&X(e,d)){if(l===1)K(e,d),a.delete(p);else if(l===2)$(e,d,b);else if(l===3)V(e,d,b);else if(l===4){let A=a.get(c);if(A!==void 0){let h=b(A);$(e,d,h),u=ee(h,d,s,u)}}else if(l===5){let A=a.get(c);A!==void 0&&V(e,d,b(A))}}}return a}};function Re(e,t){let i=new WeakSet,r,y;return(o,n)=>{i.has(o)||(i.add(o),r=j(o,e[0],e),y=P(e));let a=r(),s=y(n),u=new ArrayBuffer(a.byteLength+s.byteLength),p=new Uint8Array(u);return p.set(new Uint8Array(a),0),p.set(new Uint8Array(s),a.byteLength),u}}function he(e){let t=new WeakSet,i,r;return(y,o,n)=>{t.has(y)||(t.add(y),i=M(y,e[0],e),r=Q(e));let a=i(o,n),s=o.slice(a);return r(s,n)}}var te=(r=>(r[r.REPLACE=0]="REPLACE",r[r.APPEND=1]="APPEND",r[r.MAP=2]="MAP",r))(te||{});var se=Symbol("$modifier");function O(e,t){let i=()=>[e,t];return i[se]=!0,i}var $e=e=>O(e,"not"),we=e=>O(e,"or"),Fe=e=>O(e,"changed");function Oe(e){let t=i=>ie(i,e);return t.components=e,t}function ke(e){let t=[],i=new WeakSet;return r=>{i.has(r)||(L(r,re(...e.components),o=>t.push(o)),i.add(r));let y=t.slice();return t.length=0,y}}function Pe(e){let t=[],i=new WeakSet;return r=>{i.has(r)||(L(r,ne(...e.components),o=>t.push(o)),i.add(r));let y=t.slice();return t.length=0,y}}var Qe=(e,t,i)=>oe(e,i,t),Ve=(e,t,i)=>ae(e,i,t),Ee=(e,t,i)=>ye(e,i,t),je={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},q={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Me=(e,t=1e5)=>{let i=(r,y)=>{let o={};for(let n in r)if(Array.isArray(r[n])){let[a,s]=r[n];o[n]=Array.from({length:s},()=>new q[a](y))}else if(typeof r[n]=="object")o[n]=i(r[n],y);else{let a=r[n],s=q[a];if(s)o[n]=new s(y);else throw new Error(`Unsupported type: ${r[n]}`)}return o};return i(e,t)};export{se as $modifier,Fe as Changed,te as DESERIALIZE_MODE,$e as Not,we as Or,je as Types,Qe as addComponent,Me as defineComponent,he as defineDeserializer,Oe as defineQuery,Re as defineSerializer,ke as enterQuery,Pe as exitQuery,Ve as hasComponent,Ee as removeComponent};
//# sourceMappingURL=index.min.mjs.map
