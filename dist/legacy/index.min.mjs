import{observe as K,onAdd as de,onRemove as Ae,query as be,addComponent as Te,hasComponent as Ie,removeComponent as ge}from"bitecs";import{addComponent as k,removeComponent as L,addEntity as ye,removeEntity as se,observe as h,onAdd as O,onRemove as P,entityExists as pe,isRelation as ue,getRelationTargets as le,Wildcard as G}from"bitecs";var A=Symbol.for("bitecs-u8"),I=Symbol.for("bitecs-i8"),g=Symbol.for("bitecs-u16"),C=Symbol.for("bitecs-i16"),f=Symbol.for("bitecs-u32"),x=Symbol.for("bitecs-i32"),T=Symbol.for("bitecs-f32"),R=Symbol.for("bitecs-f64"),$=Symbol.for("bitecs-arr"),W=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),X=W(A),Y=W(I),Z=W(g),_=W(C),ee=W(f),re=W(x),te=W(T),ne=W(R),oe=new Map([[X,A],[Y,I],[Z,g],[_,C],[ee,f],[re,x],[te,T],[ne,R]]),S={[A]:(e,r,o)=>(e.setUint8(r,o),1),[I]:(e,r,o)=>(e.setInt8(r,o),1),[g]:(e,r,o)=>(e.setUint16(r,o),2),[C]:(e,r,o)=>(e.setInt16(r,o),2),[f]:(e,r,o)=>(e.setUint32(r,o),4),[x]:(e,r,o)=>(e.setInt32(r,o),4),[T]:(e,r,o)=>(e.setFloat32(r,o),4),[R]:(e,r,o)=>(e.setFloat64(r,o),8)},U={[A]:(e,r)=>({value:e.getUint8(r),size:1}),[I]:(e,r)=>({value:e.getInt8(r),size:1}),[g]:(e,r)=>({value:e.getUint16(r),size:2}),[C]:(e,r)=>({value:e.getInt16(r),size:2}),[f]:(e,r)=>({value:e.getUint32(r),size:4}),[x]:(e,r)=>({value:e.getInt32(r),size:4}),[T]:(e,r)=>({value:e.getFloat32(r),size:4}),[R]:(e,r)=>({value:e.getFloat64(r),size:8})};function B(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let r=oe.get(e);if(r)return r;throw new Error(`Unknown type function: ${e}`)}return v(e)?B(e[$]):T}function D(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function F(e){if(v(e))return B(e[$]);for(let r of[A,I,g,C,f,x,T,R])if(r in e)return r;return e instanceof Int8Array?I:e instanceof Uint8Array?A:e instanceof Int16Array?C:e instanceof Uint16Array?g:e instanceof Int32Array?x:e instanceof Uint32Array?f:e instanceof Float32Array?T:R}function v(e){return Array.isArray(e)&&$ in e}function w(e){return e[$]}function Q(e,r,o,t){let i=0,a=Array.isArray(r)?1:0;if(i+=S[A](o,t,a),!a)return i;i+=S[f](o,t+i,r.length);for(let n=0;n<r.length;n++){let y=r[n];if(v(e))i+=Q(w(e),y,o,t+i);else{let s=B(e);i+=S[s](o,t+i,y)}}return i}function M(e,r,o){let t=0,i=U[A](r,o+t);if(t+=i.size,!i.value)return{size:t};let a=U[f](r,o+t);t+=a.size;let n=new Array(a.value);for(let y=0;y<n.length;y++)if(v(e)){let{value:s,size:p}=M(w(e),r,o+t);t+=p,Array.isArray(s)&&(n[y]=s)}else{let s=B(e),{value:p,size:u}=U[s](r,o+t);t+=u,n[y]=p}return{value:n,size:t}}var ie=e=>{if(D(e)){let i=F(e),a=S[i];return(n,y,s)=>{let p=0;return p+=S[f](n,y,s),p+=a(n,y+p,e[s]),p}}let r=Object.keys(e),t=r.map(i=>{let a=e[i];if(!D(a))throw new Error(`Invalid array type for property ${i}`);return F(a)}).map(i=>S[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,n)=>{let y=0;y+=S[f](i,a+y,n);for(let s=0;s<r.length;s++){let p=e[r[s]];v(p)?y+=Q(w(p),p[n],i,a+y):y+=t[s](i,a+y,p[n])}return y}},ae=e=>{if(D(e)){let i=F(e),a=U[i];return(n,y,s)=>{let p=0,{value:u,size:l}=U[f](n,y);p+=l;let m=s?s.get(u)??u:u,{value:c,size:b}=a(n,y+p);return e[m]=c,p+b}}let r=Object.keys(e),t=r.map(i=>{let a=e[i];if(!D(a))throw new Error(`Invalid array type for property ${i}`);return F(a)}).map(i=>U[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,n)=>{let y=0,{value:s,size:p}=U[f](i,a+y);y+=p;let u=n?n.get(s)??s:s;for(let l=0;l<r.length;l++){let m=e[r[l]];if(v(m)){let{value:c,size:b}=M(w(m),i,a+y);Array.isArray(c)&&(m[u]=c),y+=b}else{let{value:c,size:b}=t[l](i,a+y);e[r[l]][u]=c,y+=b}}return y}},j=(e,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),t=e.map(ie);return i=>{let a=0;for(let n=0;n<i.length;n++){let y=i[n];for(let s=0;s<t.length;s++)a+=t[s](o,a,y)}return r.slice(0,a)}},q=e=>{let r=e.map(ae);return(o,t)=>{let i=new DataView(o),a=0;for(;a<o.byteLength;)for(let n=0;n<r.length;n++)a+=r[n](i,a,t)}};function me(e,r,o,t){if(!e)return t;if(Array.isArray(e)){let i=e[r];return i!==void 0?(o.setFloat64(t,i),t+8):t}if(typeof e=="object"){let i=Object.keys(e).sort();for(let a of i){let n=e[a],y=n[r];y!==void 0&&(n instanceof Int8Array||I in n?(o.setInt8(t,y),t+=1):n instanceof Uint8Array||A in n?(o.setUint8(t,y),t+=1):n instanceof Int16Array||C in n?(o.setInt16(t,y),t+=2):n instanceof Uint16Array||g in n?(o.setUint16(t,y),t+=2):n instanceof Int32Array||x in n?(o.setInt32(t,y),t+=4):n instanceof Uint32Array||f in n?(o.setUint32(t,y),t+=4):n instanceof Float32Array||T in n?(o.setFloat32(t,y),t+=4):(o.setFloat64(t,y),t+=8))}}return t}function ce(e,r,o,t){if(!e)return t;if(Array.isArray(e))return e[r]=o.getFloat64(t),t+8;if(typeof e=="object"){let i=Object.keys(e).sort();for(let a of i){let n=e[a];n instanceof Int8Array||I in n?(n[r]=o.getInt8(t),t+=1):n instanceof Uint8Array||A in n?(n[r]=o.getUint8(t),t+=1):n instanceof Int16Array||C in n?(n[r]=o.getInt16(t),t+=2):n instanceof Uint16Array||g in n?(n[r]=o.getUint16(t),t+=2):n instanceof Int32Array||x in n?(n[r]=o.getInt32(t),t+=4):n instanceof Uint32Array||f in n?(n[r]=o.getUint32(t),t+=4):n instanceof Float32Array||T in n?(n[r]=o.getFloat32(t),t+=4):(n[r]=o.getFloat64(t),t+=8)}}return t}var N=(e,r,o,t=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(t),a=0,n=[],y=new Map;return h(e,O(r),s=>{n.push([s,0,-1])}),h(e,P(r),s=>{n.push([s,1,-1]),y.delete(s)}),o.forEach((s,p)=>{ue(s)?(h(e,O(r,s(G)),u=>{let l=le(e,u,s);for(let m of l){y.has(u)||y.set(u,new Map),y.get(u).set(p,m);let c=s(m);n.push([u,4,p,m,c])}}),h(e,P(r,s(G)),u=>{let l=y.get(u);if(l){let m=l.get(p);m!==void 0&&(n.push([u,5,p,m]),l.delete(p),l.size===0&&y.delete(u))}})):(h(e,O(r,s),u=>{n.push([u,2,p])}),h(e,P(r,s),u=>{n.push([u,3,p])}))}),()=>{a=0;for(let s=0;s<n.length;s++){let[p,u,l,m,c]=n[s];i.setUint32(a,p),a+=4,i.setUint8(a,u),a+=1,(u===2||u===3||u===4||u===5)&&(i.setUint8(a,l),a+=1,(u===4||u===5)&&(i.setUint32(a,m),a+=4,u===4&&c&&(a=me(c,p,i,a))))}return n.length=0,t.slice(0,a)}},H=(e,r,o,t)=>{let i=t||new Map;return(a,n)=>{let y=n||i,s=new DataView(a),p=0;for(;p<a.byteLength;){let u=s.getUint32(p);p+=4;let l=s.getUint8(p);p+=1;let m=-1,c=-1;(l===2||l===3||l===4||l===5)&&(m=s.getUint8(p),p+=1,(l===4||l===5)&&(c=s.getUint32(p),p+=4));let b=o[m],d=y.get(u);if(l===0)d===void 0?(d=ye(e),y.set(u,d),k(e,d,r)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(d!==void 0&&pe(e,d)){if(l===1)se(e,d),y.delete(u);else if(l===2)k(e,d,b);else if(l===3)L(e,d,b);else if(l===4){let z=y.get(c);if(z!==void 0){let E=b(z);k(e,d,E),p=ce(E,d,s,p)}}else if(l===5){let z=y.get(c);z!==void 0&&L(e,d,b(z))}}}return y}};function Fe(e,r){let o=new WeakSet,t,i;return(a,n)=>{o.has(a)||(o.add(a),t=N(a,e[0],e),i=j(e));let y=t(),s=i(n),p=new ArrayBuffer(y.byteLength+s.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(y),0),u.set(new Uint8Array(s),y.byteLength),p}}function $e(e){let r=new WeakSet,o,t;return(i,a,n)=>{r.has(i)||(r.add(i),o=H(i,e[0],e),t=q(e));let y=o(a,n),s=a.slice(y);return t(s,n)}}var fe=(t=>(t[t.REPLACE=0]="REPLACE",t[t.APPEND=1]="APPEND",t[t.MAP=2]="MAP",t))(fe||{});var Ce=Symbol("$modifier");function V(e,r){let o=()=>[e,r];return o[Ce]=!0,o}var Pe=e=>V(e,"not"),Ve=e=>V(e,"or"),Ee=e=>V(e,"changed");function Qe(e){let r=o=>be(o,e);return r.components=e,r}function Me(e){let r=[],o=new WeakSet;return t=>{o.has(t)||(K(t,de(...e.components),a=>r.push(a)),o.add(t));let i=r.slice();return r.length=0,i}}function je(e){let r=[],o=new WeakSet;return t=>{o.has(t)||(K(t,Ae(...e.components),a=>r.push(a)),o.add(t));let i=r.slice();return r.length=0,i}}var qe=(e,r,o)=>Te(e,o,r),Le=(e,r,o)=>Ie(e,o,r),Ge=(e,r,o)=>ge(e,o,r),Ne={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},J={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},He=(e,r=1e5)=>{let o=(t,i)=>{let a={};for(let n in t)if(Array.isArray(t[n])){let[y,s]=t[n];a[n]=Array.from({length:s},()=>new J[y](i))}else if(typeof t[n]=="object")a[n]=o(t[n],i);else{let y=t[n],s=J[y];if(s)a[n]=new s(i);else throw new Error(`Unsupported type: ${t[n]}`)}return a};return o(e,r)};export{Ce as $modifier,Ee as Changed,fe as DESERIALIZE_MODE,Pe as Not,Ve as Or,Ne as Types,qe as addComponent,He as defineComponent,$e as defineDeserializer,Qe as defineQuery,Fe as defineSerializer,Me as enterQuery,je as exitQuery,Le as hasComponent,Ge as removeComponent};
//# sourceMappingURL=index.min.mjs.map
