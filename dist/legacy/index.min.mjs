import{observe as J,onAdd as oe,onRemove as ae,query as ye,addComponent as se,hasComponent as pe,removeComponent as ue}from"bitecs";import{addComponent as w,removeComponent as q,addEntity as Y,removeEntity as Z,observe as v,onAdd as F,onRemove as O,entityExists as _,isRelation as ee,getRelationTargets as re,Wildcard as L}from"bitecs";var b=Symbol.for("bitecs-u8"),I=Symbol.for("bitecs-i8"),T=Symbol.for("bitecs-u16"),g=Symbol.for("bitecs-i16"),d=Symbol.for("bitecs-u32"),C=Symbol.for("bitecs-i32"),x=Symbol.for("bitecs-f32"),S=Symbol.for("bitecs-f64"),V=Symbol.for("bitecs-arr"),W=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),me=W(b),ce=W(I),de=W(T),fe=W(g),Ae=W(d),be=W(C),Ie=W(x),Te=W(S),R={[b]:(e,r,i)=>(e.setUint8(r,i),1),[I]:(e,r,i)=>(e.setInt8(r,i),1),[T]:(e,r,i)=>(e.setUint16(r,i),2),[g]:(e,r,i)=>(e.setInt16(r,i),2),[d]:(e,r,i)=>(e.setUint32(r,i),4),[C]:(e,r,i)=>(e.setInt32(r,i),4),[x]:(e,r,i)=>(e.setFloat32(r,i),4),[S]:(e,r,i)=>(e.setFloat64(r,i),8)},U={[b]:(e,r)=>({value:e.getUint8(r),size:1}),[I]:(e,r)=>({value:e.getInt8(r),size:1}),[T]:(e,r)=>({value:e.getUint16(r),size:2}),[g]:(e,r)=>({value:e.getInt16(r),size:2}),[d]:(e,r)=>({value:e.getUint32(r),size:4}),[C]:(e,r)=>({value:e.getInt32(r),size:4}),[x]:(e,r)=>({value:e.getFloat32(r),size:4}),[S]:(e,r)=>({value:e.getFloat64(r),size:8})};function z(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function D(e){for(let r of[b,I,T,g,d,C,x,S])if(r in e)return r;return e instanceof Int8Array?I:e instanceof Uint8Array?b:e instanceof Int16Array?g:e instanceof Uint16Array?T:e instanceof Int32Array?C:e instanceof Uint32Array?d:e instanceof Float32Array?x:S}function $(e){return Array.isArray(e)&&V in e}function B(e){return e[V]}function Q(e,r,i,t){let o=0,a=Array.isArray(r)?1:0;if(o+=R[b](i,t,a),!a)return o;o+=R[d](i,t+o,r.length);for(let n=0;n<r.length;n++){let y=r[n];$(e)?o+=Q(B(e),y,i,t+o):typeof e=="symbol"&&(o+=R[e](i,t+o,y))}return o}function E(e,r,i){let t=0,o=U[b](r,i+t);if(t+=o.size,!o.value)return{size:t};let a=U[d](r,i+t);t+=a.size;let n=new Array(a.value);for(let y=0;y<n.length;y++)if($(e)){let{value:s,size:p}=E(B(e),r,i+t);t+=p,Array.isArray(s)&&(n[y]=s)}else{let{value:s,size:p}=U[e](r,i+t);t+=p,n[y]=s}return{value:n,size:t}}var K=e=>{if(z(e)){let o=D(e),a=R[o];return(n,y,s)=>{let p=0;return p+=R[d](n,y,s),p+=a(n,y+p,e[s]),p}}let r=Object.keys(e),t=r.map(o=>{let a=e[o];if(!z(a))throw new Error(`Invalid array type for property ${o}`);return D(a)}).map(o=>R[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0;y+=R[d](o,a+y,n);for(let s=0;s<r.length;s++){let p=e[r[s]];$(p)?y+=Q(B(p),p[n],o,a+y):y+=t[s](o,a+y,p[n])}return y}},X=e=>{if(z(e)){let o=D(e),a=U[o];return(n,y,s)=>{let p=0,{value:u,size:l}=U[d](n,y);p+=l;let m=s?s.get(u)??u:u,{value:c,size:A}=a(n,y+p);return e[m]=c,p+A}}let r=Object.keys(e),t=r.map(o=>{let a=e[o];if(!z(a))throw new Error(`Invalid array type for property ${o}`);return D(a)}).map(o=>U[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0,{value:s,size:p}=U[d](o,a+y);y+=p;let u=n?n.get(s)??s:s;for(let l=0;l<r.length;l++){let m=e[r[l]];if($(m)){let{value:c,size:A}=E(B(m),o,a+y);Array.isArray(c)&&(m[u]=c),y+=A}else{let{value:c,size:A}=t[l](o,a+y);e[r[l]][u]=c,y+=A}}return y}},M=(e,r=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(r),t=e.map(K);return o=>{let a=0;for(let n=0;n<o.length;n++){let y=o[n];for(let s=0;s<t.length;s++)a+=t[s](i,a,y)}return r.slice(0,a)}},j=e=>{let r=e.map(X);return(i,t)=>{let o=new DataView(i),a=0;for(;a<i.byteLength;)for(let n=0;n<r.length;n++)a+=r[n](o,a,t)}};function te(e,r,i,t){if(!e)return t;if(Array.isArray(e)){let o=e[r];return o!==void 0?(i.setFloat64(t,o),t+8):t}if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a],y=n[r];y!==void 0&&(n instanceof Int8Array||I in n?(i.setInt8(t,y),t+=1):n instanceof Uint8Array||b in n?(i.setUint8(t,y),t+=1):n instanceof Int16Array||g in n?(i.setInt16(t,y),t+=2):n instanceof Uint16Array||T in n?(i.setUint16(t,y),t+=2):n instanceof Int32Array||C in n?(i.setInt32(t,y),t+=4):n instanceof Uint32Array||d in n?(i.setUint32(t,y),t+=4):n instanceof Float32Array||x in n?(i.setFloat32(t,y),t+=4):(i.setFloat64(t,y),t+=8))}}return t}function ne(e,r,i,t){if(!e)return t;if(Array.isArray(e))return e[r]=i.getFloat64(t),t+8;if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a];n instanceof Int8Array||I in n?(n[r]=i.getInt8(t),t+=1):n instanceof Uint8Array||b in n?(n[r]=i.getUint8(t),t+=1):n instanceof Int16Array||g in n?(n[r]=i.getInt16(t),t+=2):n instanceof Uint16Array||T in n?(n[r]=i.getUint16(t),t+=2):n instanceof Int32Array||C in n?(n[r]=i.getInt32(t),t+=4):n instanceof Uint32Array||d in n?(n[r]=i.getUint32(t),t+=4):n instanceof Float32Array||x in n?(n[r]=i.getFloat32(t),t+=4):(n[r]=i.getFloat64(t),t+=8)}}return t}var G=(e,r,i,t=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(t),a=0,n=[],y=new Map;return v(e,F(r),s=>{n.push([s,0,-1])}),v(e,O(r),s=>{n.push([s,1,-1]),y.delete(s)}),i.forEach((s,p)=>{ee(s)?(v(e,F(r,s(L)),u=>{let l=re(e,u,s);for(let m of l){y.has(u)||y.set(u,new Map),y.get(u).set(p,m);let c=s(m);n.push([u,4,p,m,c])}}),v(e,O(r,s(L)),u=>{let l=y.get(u);if(l){let m=l.get(p);m!==void 0&&(n.push([u,5,p,m]),l.delete(p),l.size===0&&y.delete(u))}})):(v(e,F(r,s),u=>{n.push([u,2,p])}),v(e,O(r,s),u=>{n.push([u,3,p])}))}),()=>{a=0;for(let s=0;s<n.length;s++){let[p,u,l,m,c]=n[s];o.setUint32(a,p),a+=4,o.setUint8(a,u),a+=1,(u===2||u===3||u===4||u===5)&&(o.setUint8(a,l),a+=1,(u===4||u===5)&&(o.setUint32(a,m),a+=4,u===4&&c&&(a=te(c,p,o,a))))}return n.length=0,t.slice(0,a)}},N=(e,r,i,t)=>{let o=t||new Map;return(a,n)=>{let y=n||o,s=new DataView(a),p=0;for(;p<a.byteLength;){let u=s.getUint32(p);p+=4;let l=s.getUint8(p);p+=1;let m=-1,c=-1;(l===2||l===3||l===4||l===5)&&(m=s.getUint8(p),p+=1,(l===4||l===5)&&(c=s.getUint32(p),p+=4));let A=i[m],f=y.get(u);if(l===0)f===void 0?(f=Y(e),y.set(u,f),w(e,f,r)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(f!==void 0&&_(e,f)){if(l===1)Z(e,f),y.delete(u);else if(l===2)w(e,f,A);else if(l===3)q(e,f,A);else if(l===4){let h=y.get(c);if(h!==void 0){let k=A(h);w(e,f,k),p=ne(k,f,s,p)}}else if(l===5){let h=y.get(c);h!==void 0&&q(e,f,A(h))}}}return y}};function ze(e,r){let i=new WeakSet,t,o;return(a,n)=>{i.has(a)||(i.add(a),t=G(a,e[0],e),o=M(e));let y=t(),s=o(n),p=new ArrayBuffer(y.byteLength+s.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(y),0),u.set(new Uint8Array(s),y.byteLength),p}}function De(e){let r=new WeakSet,i,t;return(o,a,n)=>{r.has(o)||(r.add(o),i=N(o,e[0],e),t=j(e));let y=i(a,n),s=a.slice(y);return t(s,n)}}var ie=(t=>(t[t.REPLACE=0]="REPLACE",t[t.APPEND=1]="APPEND",t[t.MAP=2]="MAP",t))(ie||{});var le=Symbol("$modifier");function P(e,r){let i=()=>[e,r];return i[le]=!0,i}var Oe=e=>P(e,"not"),Pe=e=>P(e,"or"),ke=e=>P(e,"changed");function Ve(e){let r=i=>ye(i,e);return r.components=e,r}function Qe(e){let r=[],i=new WeakSet;return t=>{i.has(t)||(J(t,oe(...e.components),a=>r.push(a)),i.add(t));let o=r.slice();return r.length=0,o}}function Ee(e){let r=[],i=new WeakSet;return t=>{i.has(t)||(J(t,ae(...e.components),a=>r.push(a)),i.add(t));let o=r.slice();return r.length=0,o}}var Me=(e,r,i)=>se(e,i,r),je=(e,r,i)=>pe(e,i,r),qe=(e,r,i)=>ue(e,i,r),Le={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},H={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Ge=(e,r=1e5)=>{let i=(t,o)=>{let a={};for(let n in t)if(Array.isArray(t[n])){let[y,s]=t[n];a[n]=Array.from({length:s},()=>new H[y](o))}else if(typeof t[n]=="object")a[n]=i(t[n],o);else{let y=t[n],s=H[y];if(s)a[n]=new s(o);else throw new Error(`Unsupported type: ${t[n]}`)}return a};return i(e,r)};export{le as $modifier,ke as Changed,ie as DESERIALIZE_MODE,Oe as Not,Pe as Or,Le as Types,Me as addComponent,Ge as defineComponent,De as defineDeserializer,Ve as defineQuery,ze as defineSerializer,Qe as enterQuery,Ee as exitQuery,je as hasComponent,qe as removeComponent};
//# sourceMappingURL=index.min.mjs.map
