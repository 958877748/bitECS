import{observe as V,onAdd as Z,onRemove as _,query as ee,addComponent as te,hasComponent as ne,removeComponent as re}from"bitecs";import{addComponent as h,removeComponent as O,addEntity as L,removeEntity as G,observe as U,onAdd as S,onRemove as z,entityExists as N,isRelation as H,getRelationTargets as J,Wildcard as Q}from"bitecs";var b=Symbol.for("bitecs-u8"),A=Symbol.for("bitecs-i8"),I=Symbol.for("bitecs-u16"),C=Symbol.for("bitecs-i16"),d=Symbol.for("bitecs-u32"),T=Symbol.for("bitecs-i32"),x=Symbol.for("bitecs-f32"),W=Symbol.for("bitecs-f64"),g=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ie=g(b),ae=g(A),ye=g(I),se=g(C),pe=g(d),ue=g(T),me=g(x),le=g(W),w={[b]:(e,t,o)=>(e.setUint8(t,o),1),[A]:(e,t,o)=>(e.setInt8(t,o),1),[I]:(e,t,o)=>(e.setUint16(t,o),2),[C]:(e,t,o)=>(e.setInt16(t,o),2),[d]:(e,t,o)=>(e.setUint32(t,o),4),[T]:(e,t,o)=>(e.setInt32(t,o),4),[x]:(e,t,o)=>(e.setFloat32(t,o),4),[W]:(e,t,o)=>(e.setFloat64(t,o),8)},k={[b]:(e,t)=>({value:e.getUint8(t),size:1}),[A]:(e,t)=>({value:e.getInt8(t),size:1}),[I]:(e,t)=>({value:e.getUint16(t),size:2}),[C]:(e,t)=>({value:e.getInt16(t),size:2}),[d]:(e,t)=>({value:e.getUint32(t),size:4}),[T]:(e,t)=>({value:e.getInt32(t),size:4}),[x]:(e,t)=>({value:e.getFloat32(t),size:4}),[W]:(e,t)=>({value:e.getFloat64(t),size:8})},j=e=>{let t=Object.keys(e),n=t.map(a=>{let i=e[a];for(let r of[b,A,I,C,d,T,x,W])if(r in i)return r;return W}).map(a=>w[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,i,r)=>{let y=0;y+=w[d](a,i+y,r);for(let s=0;s<t.length;s++)y+=n[s](a,i+y,e[t[s]][r]);return y}},q=e=>{let t=Object.keys(e),n=t.map(a=>{let i=e[a];for(let r of[b,A,I,C,d,T,x,W])if(r in i)return r;return W}).map(a=>k[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,i,r)=>{let y=0,{value:s,size:u}=k[d](a,i+y);y+=u;let p=r?r.get(s)??s:s;for(let m=0;m<t.length;m++){let{value:l,size:f}=n[m](a,i+y);e[t[m]][p]=l,y+=f}return y}},F=(e,t=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(t),n=e.map(j);return a=>{let i=0;for(let r=0;r<a.length;r++){let y=a[r];for(let s=0;s<n.length;s++)i+=n[s](o,i,y)}return t.slice(0,i)}},B=e=>{let t=e.map(q);return(o,n)=>{let a=new DataView(o),i=0;for(;i<o.byteLength;)for(let r=0;r<t.length;r++)i+=t[r](a,i,n)}};function K(e,t,o,n){if(!e)return n;if(Array.isArray(e)){let a=e[t];return a!==void 0?(o.setFloat64(n,a),n+8):n}if(typeof e=="object"){let a=Object.keys(e).sort();for(let i of a){let r=e[i],y=r[t];y!==void 0&&(r instanceof Int8Array||A in r?(o.setInt8(n,y),n+=1):r instanceof Uint8Array||b in r?(o.setUint8(n,y),n+=1):r instanceof Int16Array||C in r?(o.setInt16(n,y),n+=2):r instanceof Uint16Array||I in r?(o.setUint16(n,y),n+=2):r instanceof Int32Array||T in r?(o.setInt32(n,y),n+=4):r instanceof Uint32Array||d in r?(o.setUint32(n,y),n+=4):r instanceof Float32Array||x in r?(o.setFloat32(n,y),n+=4):(o.setFloat64(n,y),n+=8))}}return n}function X(e,t,o,n){if(!e)return n;if(Array.isArray(e))return e[t]=o.getFloat64(n),n+8;if(typeof e=="object"){let a=Object.keys(e).sort();for(let i of a){let r=e[i];r instanceof Int8Array||A in r?(r[t]=o.getInt8(n),n+=1):r instanceof Uint8Array||b in r?(r[t]=o.getUint8(n),n+=1):r instanceof Int16Array||C in r?(r[t]=o.getInt16(n),n+=2):r instanceof Uint16Array||I in r?(r[t]=o.getUint16(n),n+=2):r instanceof Int32Array||T in r?(r[t]=o.getInt32(n),n+=4):r instanceof Uint32Array||d in r?(r[t]=o.getUint32(n),n+=4):r instanceof Float32Array||x in r?(r[t]=o.getFloat32(n),n+=4):(r[t]=o.getFloat64(n),n+=8)}}return n}var E=(e,t,o,n=new ArrayBuffer(1024*1024*100))=>{let a=new DataView(n),i=0,r=[],y=new Map;return U(e,S(t),s=>{r.push([s,0,-1])}),U(e,z(t),s=>{r.push([s,1,-1]),y.delete(s)}),o.forEach((s,u)=>{H(s)?(U(e,S(t,s(Q)),p=>{let m=J(e,p,s);for(let l of m){y.has(p)||y.set(p,new Map),y.get(p).set(u,l);let f=s(l);r.push([p,4,u,l,f])}}),U(e,z(t,s(Q)),p=>{let m=y.get(p);if(m){let l=m.get(u);l!==void 0&&(r.push([p,5,u,l]),m.delete(u),m.size===0&&y.delete(p))}})):(U(e,S(t,s),p=>{r.push([p,2,u])}),U(e,z(t,s),p=>{r.push([p,3,u])}))}),()=>{i=0;for(let s=0;s<r.length;s++){let[u,p,m,l,f]=r[s];a.setUint32(i,u),i+=4,a.setUint8(i,p),i+=1,(p===2||p===3||p===4||p===5)&&(a.setUint8(i,m),i+=1,(p===4||p===5)&&(a.setUint32(i,l),i+=4,p===4&&f&&(i=K(f,u,a,i))))}return r.length=0,n.slice(0,i)}},M=(e,t,o,n)=>{let a=n||new Map;return(i,r)=>{let y=r||a,s=new DataView(i),u=0;for(;u<i.byteLength;){let p=s.getUint32(u);u+=4;let m=s.getUint8(u);u+=1;let l=-1,f=-1;(m===2||m===3||m===4||m===5)&&(l=s.getUint8(u),u+=1,(m===4||m===5)&&(f=s.getUint32(u),u+=4));let v=o[l],c=y.get(p);if(m===0)if(c===void 0)c=L(e),y.set(p,c),h(e,c,t);else throw new Error(`Entity with ID ${p} already exists in the mapping.`);else if(c!==void 0&&N(e,c)){if(m===1)G(e,c);else if(m===2)h(e,c,v);else if(m===3)O(e,c,v);else if(m===4){let R=y.get(f);if(R!==void 0){let $=v(R);h(e,c,$),u=X($,c,s,u)}}else if(m===5){let R=y.get(f);R!==void 0&&O(e,c,v(R))}}}return y}};function ge(e,t){let o=new WeakSet,n,a;return(i,r)=>{o.has(i)||(o.add(i),n=E(i,e[0],e),a=F(e));let y=n(),s=a(r),u=new ArrayBuffer(y.byteLength+s.byteLength),p=new Uint8Array(u);return p.set(new Uint8Array(y),0),p.set(new Uint8Array(s),y.byteLength),u}}function We(e){let t=new WeakSet,o,n;return(a,i,r)=>{t.has(a)||(t.add(a),o=M(a,e[0],e),n=B(e));let y=o(i,r),s=i.slice(y);return n(s,r)}}var Y=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(Y||{});var oe=Symbol("$modifier");function D(e,t){let o=()=>[e,t];return o[oe]=!0,o}var Se=e=>D(e,"not"),ze=e=>D(e,"or"),De=e=>D(e,"changed");function $e(e){let t=o=>ee(o,e);return t.components=e,t}function we(e){let t=[],o=new WeakSet;return n=>{o.has(n)||(V(n,Z(...e.components),i=>t.push(i)),o.add(n));let a=t.slice();return t.length=0,a}}function ke(e){let t=[],o=new WeakSet;return n=>{o.has(n)||(V(n,_(...e.components),i=>t.push(i)),o.add(n));let a=t.slice();return t.length=0,a}}var Fe=(e,t,o)=>te(e,o,t),Be=(e,t,o)=>ne(e,o,t),Oe=(e,t,o)=>re(e,o,t),Qe={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},P={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Ee=(e,t=1e5)=>{let o=(n,a)=>{let i={};for(let r in n)if(Array.isArray(n[r])){let[y,s]=n[r];i[r]=Array.from({length:s},()=>new P[y](a))}else if(typeof n[r]=="object")i[r]=o(n[r],a);else{let y=n[r],s=P[y];if(s)i[r]=new s(a);else throw new Error(`Unsupported type: ${n[r]}`)}return i};return o(e,t)};export{oe as $modifier,De as Changed,Y as DESERIALIZE_MODE,Se as Not,ze as Or,Qe as Types,Fe as addComponent,Ee as defineComponent,We as defineDeserializer,$e as defineQuery,ge as defineSerializer,we as enterQuery,ke as exitQuery,Be as hasComponent,Oe as removeComponent};
//# sourceMappingURL=index.min.mjs.map
