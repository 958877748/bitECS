var oe=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var ze=Object.getOwnPropertyNames;var je=Object.prototype.hasOwnProperty;var we=(e,t)=>{for(var o in t)oe(e,o,{get:t[o],enumerable:!0})},Pe=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of ze(t))!je.call(e,a)&&a!==o&&oe(e,a,{get:()=>t[a],enumerable:!(n=$e(t,a))||n.enumerable});return e};var qe=e=>Pe(oe({},"__esModule",{value:!0}),e);var it={};we(it,{$modifier:()=>ke,Changed:()=>_e,DESERIALIZE_MODE:()=>Se,Not:()=>Xe,Or:()=>Ye,Types:()=>at,addComponent:()=>nt,defineComponent:()=>st,defineDeserializer:()=>Je,defineQuery:()=>Ze,defineSerializer:()=>Le,enterQuery:()=>et,exitQuery:()=>tt,hasComponent:()=>ot,removeComponent:()=>rt});module.exports=qe(it);var re=()=>{let e=[],t=[],o=r=>e[t[r]]===r;return{add:r=>{o(r)||(t[r]=e.push(r)-1)},remove:r=>{if(!o(r))return;let i=t[r],p=e.pop();p!==r&&(e[i]=p,t[p]=i)},has:o,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},de=(e=1e3)=>{let t=[],o=0,n=new Uint32Array(e),a=p=>p<t.length&&t[p]<o&&n[t[p]]===p;return{add:p=>{if(!a(p)){if(o>=n.length){let y=new Uint32Array(n.length*2);y.set(n),n=y}n[o]=p,t[p]=o,o++}},remove:p=>{if(!a(p))return;o--;let y=t[p],m=n[o];n[y]=m,t[m]=y},has:a,sparse:t,get dense(){return new Uint32Array(n.buffer,0,o)},reset:()=>{o=0,t.length=0}}};var q=(e,t,o)=>Object.defineProperty(e,t,{value:o,enumerable:!1,writable:!0,configurable:!0});var fe=(e,t)=>t&e.entityMask;var ae=(e,t)=>{let o=fe(e,t),n=e.sparse[o];return n!==void 0&&n<e.aliveCount&&e.dense[n]===t};var f=Symbol.for("bitecs_internal");var V=Symbol("relation"),w=Symbol("pairTarget"),L=Symbol("isPairComponent"),A=Symbol("relationData"),Ie=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=o=>{if(o===void 0)throw Error("Relation target is undefined");let n=o==="*"?g:o;if(!e.pairsMap.has(n)){let a=e.initStore?e.initStore():{};q(a,V,t),q(a,w,n),q(a,L,!0),e.pairsMap.set(n,a)}return e.pairsMap.get(n)};return q(t,A,e),t},be=e=>t=>{let o=t[A];return o.initStore=e,t},Fe=e=>{let t=e[A];return t.exclusiveRelation=!0,e},xe=e=>{let t=e[A];return t.autoRemoveSubject=!0,e},ve=e=>t=>{let o=t[A];return o.onTargetRemoved=e,t};var h=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},g=se(),B=se(),F=(e,t,o)=>{let n=G(e,t),a=[];for(let s of n)s[V]===o&&s[w]!==g&&a.push(s[w]);return a};function se(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:o,autoRemoveSubject:n,onTargetRemoved:a}=e[0];return[t&&be(t),o&&Fe,n&&xe,a&&ve(a)].filter(Boolean).reduce((r,i)=>i(r),Ie())}else return e.reduce((o,n)=>n(o),Ie())}var H={};var G=(e,t)=>{let o=e[f];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!ae(o.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(o.entityComponents.get(t))},Z=(e,t)=>ae(e[f].entityIndex,t);var N=()=>{let e=new Set;return{subscribe:n=>(e.add(n),()=>{e.delete(n)}),notify:(n,...a)=>Array.from(e).reduce((s,r)=>{let i=r(n,...a);return i&&typeof i=="object"?{...s,...i}:s},{})}};var z=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let o=e[f],n=new Set,a={id:o.componentCount++,generationId:o.entityMasks.length-1,bitflag:o.bitflag,ref:t,queries:n,setObservable:N(),getObservable:N()};return o.componentMap.set(t,a),o.bitflag*=2,o.bitflag>=2**31&&(o.bitflag=1,o.entityMasks.push([])),a};var T=(e,t,o)=>{let n=e[f],a=n.componentMap.get(o);if(!a)return!1;let{generationId:s,bitflag:r}=a;return(n.entityMasks[s][t]&r)===r},Re=(e,t,o)=>{let a=e[f].componentMap.get(o);if(a&&T(e,t,o))return a.getObservable.notify(t)};var Te=(e,t,o,n=!0)=>{let a=e[f];C(e,t,B(o));for(let s of G(e,o))if(s!==H&&(C(e,t,s),n)){let r=a.componentMap.get(s);if(r?.setObservable){let i=Re(e,o,s);r.setObservable.notify(t,i)}}for(let s of F(e,o,B))Te(e,t,s,!1)},C=(e,t,...o)=>{if(!Z(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);let n=e[f];o.forEach(a=>{let s="component"in a?a.component:a,r="data"in a?a.data:void 0;n.componentMap.has(s)||z(e,s);let i=n.componentMap.get(s);if(r!==void 0&&i.setObservable.notify(t,r),T(e,t,s))return;let{generationId:p,bitflag:y,queries:m}=i;if(n.entityMasks[p][t]|=y,T(e,t,H)||m.forEach(u=>{u.toRemove.remove(t),J(e,u,t)?X(u,t):ne(e,u,t)}),n.entityComponents.get(t).add(s),s[L]){let u=s[V],d=s[w];if(C(e,t,h(u,g)),C(e,t,h(g,d)),typeof d=="number"&&(C(e,d,h(g,u)),n.entitiesWithRelations.add(d)),n.entitiesWithRelations.add(d),u[A].exclusiveRelation===!0&&d!==g){let x=F(e,t,u)[0];x!=null&&x!==d&&j(e,t,u(x))}if(u===B){let x=F(e,t,B);for(let v of x)Te(e,t,v)}}})};var j=(e,t,...o)=>{let n=e[f];if(!Z(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);o.forEach(a=>{if(!T(e,t,a))return;let s=n.componentMap.get(a),{generationId:r,bitflag:i,queries:p}=s;if(n.entityMasks[r][t]&=~i,p.forEach(y=>{y.toRemove.remove(t),J(e,y,t)?X(y,t):ne(e,y,t)}),n.entityComponents.get(t).delete(a),a[L]){let y=a[w];j(e,t,h(g,y));let m=a[V];F(e,t,m).length===0&&j(e,t,h(m,g))}})};var W=Symbol("opType"),K=Symbol("opTerms");var ie=(...e)=>({[W]:"add",[K]:e}),pe=(...e)=>({[W]:"remove",[K]:e});function ee(e,t,o){let n=e[f],{[W]:a,[K]:s}=t;if(a==="add"||a==="remove"){let r=ue(e,s),i=n.queriesHashMap.get(r);return i||(i=te(e,s)),i[a==="add"?"addObservable":"removeObservable"].subscribe(o)}else if(a==="set"||a==="get"){if(s.length!==1)throw new Error("Set and Get hooks can only observe a single component");let r=s[0],i=n.componentMap.get(r);return i||(i=z(e,r)),i[a==="set"?"setObservable":"getObservable"].subscribe(o)}throw new Error(`Invalid hook type: ${a}`)}var ue=(e,t)=>{let o=e[f],n=s=>(o.componentMap.has(s)||z(e,s),o.componentMap.get(s).id),a=s=>{if(W in s){let i=s[K].map(n).sort((y,m)=>y-m);return`${s[W].toLowerCase()}(${i.join(",")})`}else return n(s).toString()};return t.map(a).sort().join("-")},te=(e,t,o={})=>{let n=e[f],a=ue(e,t),s=[],r=[],i=[],p=(l,R)=>{l.forEach(_=>{n.componentMap.has(_)||z(e,_),R.push(_)})};t.forEach(l=>{W in l?l[W]==="Not"?p(l[K],r):l[W]==="Or"&&p(l[K],i):(n.componentMap.has(l)||z(e,l),s.push(l))});let y=l=>n.componentMap.get(l),m=s.concat(r.flat()).concat(i.flat()).map(y),u=o.buffered?de():re(),d=re(),b=m.map(l=>l.generationId).reduce((l,R)=>(l.includes(R)||l.push(R),l),[]),x=(l,R)=>(l[R.generationId]||(l[R.generationId]=0),l[R.generationId]|=R.bitflag,l),v=s.map(y).reduce(x,{}),U=r.map(y).reduce(x,{}),Y=i.map(y).reduce(x,{}),Qe=m.reduce(x,{}),De=N(),Ue=N(),$=Object.assign(u,{components:s,notComponents:r,orComponents:i,allComponents:m,masks:v,notMasks:U,orMasks:Y,hasMasks:Qe,generations:b,toRemove:d,addObservable:De,removeObservable:Ue,queues:{}});n.queries.add($),n.queriesHashMap.set(a,$),m.forEach(l=>{l.queries.add($)}),r.length&&n.notQueries.add($);let le=n.entityIndex;for(let l=0;l<le.aliveCount;l++){let R=le.dense[l];if(T(e,R,H))continue;J(e,$,R)&&X($,R)}return $};function ye(e,t,o={}){let n=e[f],a=ue(e,t),s=n.queriesHashMap.get(a);return s?o.buffered&&!("buffer"in s.dense)&&(s=te(e,t,{buffered:!0})):s=te(e,t,o),s.dense}function me(e,t){return ge(e),ye(e,t)}function J(e,t,o){let n=e[f],{masks:a,notMasks:s,orMasks:r,generations:i}=t;for(let p=0;p<i.length;p++){let y=i[p],m=a[y],u=s[y],d=r[y],b=n.entityMasks[y][o];if(u&&b&u||m&&(b&m)!==m||d&&!(b&d))return!1}return!0}var X=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},He=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let o=e.toRemove.dense[t];e.remove(o)}e.toRemove.reset()},ge=e=>{let t=e[f];t.dirtyQueries.size&&(t.dirtyQueries.forEach(He),t.dirtyQueries.clear())},ne=(e,t,o)=>{let n=e[f];!t.has(o)||t.toRemove.has(o)||(t.toRemove.add(o),n.dirtyQueries.add(t),t.removeObservable.notify(o))};var c=require("bitecs");var O=Symbol("u8"),E=Symbol("i8"),S=Symbol("u16"),M=Symbol("i16"),I=Symbol("u32"),k=Symbol("i32"),Q=Symbol("f32"),P=Symbol("f64"),D=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),En=D(O),Sn=D(E),Mn=D(S),kn=D(M),Qn=D(I),Dn=D(k),Un=D(Q),$n=D(P),Ce={[O]:(e,t,o)=>(e.setUint8(t,o),1),[E]:(e,t,o)=>(e.setInt8(t,o),1),[S]:(e,t,o)=>(e.setUint16(t,o),2),[M]:(e,t,o)=>(e.setInt16(t,o),2),[I]:(e,t,o)=>(e.setUint32(t,o),4),[k]:(e,t,o)=>(e.setInt32(t,o),4),[Q]:(e,t,o)=>(e.setFloat32(t,o),4),[P]:(e,t,o)=>(e.setFloat64(t,o),8)},he={[O]:(e,t)=>({value:e.getUint8(t),size:1}),[E]:(e,t)=>({value:e.getInt8(t),size:1}),[S]:(e,t)=>({value:e.getUint16(t),size:2}),[M]:(e,t)=>({value:e.getInt16(t),size:2}),[I]:(e,t)=>({value:e.getUint32(t),size:4}),[k]:(e,t)=>({value:e.getInt32(t),size:4}),[Q]:(e,t)=>({value:e.getFloat32(t),size:4}),[P]:(e,t)=>({value:e.getFloat64(t),size:8})},Ve=e=>{let t=Object.keys(e),n=t.map(a=>{let s=e[a];for(let r of[O,E,S,M,I,k,Q,P])if(r in s)return r;return P}).map(a=>Ce[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,s,r)=>{let i=0;i+=Ce[I](a,s+i,r);for(let p=0;p<t.length;p++)i+=n[p](a,s+i,e[t[p]][r]);return i}},Ne=e=>{let t=Object.keys(e),n=t.map(a=>{let s=e[a];for(let r of[O,E,S,M,I,k,Q,P])if(r in s)return r;return P}).map(a=>he[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,s,r)=>{let i=0,{value:p,size:y}=he[I](a,s+i);i+=y;let m=r?r.get(p)??p:p;for(let u=0;u<t.length;u++){let{value:d,size:b}=n[u](a,s+i);e[t[u]][m]=d,i+=b}return i}},Ae=(e,t=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(t),n=e.map(Ve);return a=>{let s=0;for(let r=0;r<a.length;r++){let i=a[r];for(let p=0;p<n.length;p++)s+=n[p](o,s,i)}return t.slice(0,s)}},We=e=>{let t=e.map(Ne);return(o,n)=>{let a=new DataView(o),s=0;for(;s<o.byteLength;)for(let r=0;r<t.length;r++)s+=t[r](a,s,n)}};function Ke(e,t,o,n){if(!e)return n;if(Array.isArray(e)){let a=e[t];return a!==void 0?(o.setFloat64(n,a),n+8):n}if(typeof e=="object"){let a=Object.keys(e).sort();for(let s of a){let r=e[s],i=r[t];i!==void 0&&(r instanceof Int8Array||E in r?(o.setInt8(n,i),n+=1):r instanceof Uint8Array||O in r?(o.setUint8(n,i),n+=1):r instanceof Int16Array||M in r?(o.setInt16(n,i),n+=2):r instanceof Uint16Array||S in r?(o.setUint16(n,i),n+=2):r instanceof Int32Array||k in r?(o.setInt32(n,i),n+=4):r instanceof Uint32Array||I in r?(o.setUint32(n,i),n+=4):r instanceof Float32Array||Q in r?(o.setFloat32(n,i),n+=4):(o.setFloat64(n,i),n+=8))}}return n}function Ge(e,t,o,n){if(!e)return n;if(Array.isArray(e))return e[t]=o.getFloat64(n),n+8;if(typeof e=="object"){let a=Object.keys(e).sort();for(let s of a){let r=e[s];r instanceof Int8Array||E in r?(r[t]=o.getInt8(n),n+=1):r instanceof Uint8Array||O in r?(r[t]=o.getUint8(n),n+=1):r instanceof Int16Array||M in r?(r[t]=o.getInt16(n),n+=2):r instanceof Uint16Array||S in r?(r[t]=o.getUint16(n),n+=2):r instanceof Int32Array||k in r?(r[t]=o.getInt32(n),n+=4):r instanceof Uint32Array||I in r?(r[t]=o.getUint32(n),n+=4):r instanceof Float32Array||Q in r?(r[t]=o.getFloat32(n),n+=4):(r[t]=o.getFloat64(n),n+=8)}}return n}var Oe=(e,t,o,n=new ArrayBuffer(1024*1024*100))=>{let a=new DataView(n),s=0,r=[],i=new Map;return(0,c.observe)(e,(0,c.onAdd)(t),p=>{r.push([p,0,-1])}),(0,c.observe)(e,(0,c.onRemove)(t),p=>{r.push([p,1,-1]),i.delete(p)}),o.forEach((p,y)=>{(0,c.isRelation)(p)?((0,c.observe)(e,(0,c.onAdd)(t,p(c.Wildcard)),m=>{let u=(0,c.getRelationTargets)(e,m,p);for(let d of u){i.has(m)||i.set(m,new Map),i.get(m).set(y,d);let b=p(d);r.push([m,4,y,d,b])}}),(0,c.observe)(e,(0,c.onRemove)(t,p(c.Wildcard)),m=>{let u=i.get(m);if(u){let d=u.get(y);d!==void 0&&(r.push([m,5,y,d]),u.delete(y),u.size===0&&i.delete(m))}})):((0,c.observe)(e,(0,c.onAdd)(t,p),m=>{r.push([m,2,y])}),(0,c.observe)(e,(0,c.onRemove)(t,p),m=>{r.push([m,3,y])}))}),()=>{s=0;for(let p=0;p<r.length;p++){let[y,m,u,d,b]=r[p];a.setUint32(s,y),s+=4,a.setUint8(s,m),s+=1,(m===2||m===3||m===4||m===5)&&(a.setUint8(s,u),s+=1,(m===4||m===5)&&(a.setUint32(s,d),s+=4,m===4&&b&&(s=Ke(b,y,a,s))))}return r.length=0,n.slice(0,s)}},Ee=(e,t,o,n)=>{let a=n||new Map;return(s,r)=>{let i=r||a,p=new DataView(s),y=0;for(;y<s.byteLength;){let m=p.getUint32(y);y+=4;let u=p.getUint8(y);y+=1;let d=-1,b=-1;(u===2||u===3||u===4||u===5)&&(d=p.getUint8(y),y+=1,(u===4||u===5)&&(b=p.getUint32(y),y+=4));let x=o[d],v=i.get(m);if(u===0)if(v===void 0)v=(0,c.addEntity)(e),i.set(m,v),(0,c.addComponent)(e,v,t);else throw new Error(`Entity with ID ${m} already exists in the mapping.`);else if(v!==void 0&&(0,c.entityExists)(e,v)){if(u===1)(0,c.removeEntity)(e,v);else if(u===2)(0,c.addComponent)(e,v,x);else if(u===3)(0,c.removeComponent)(e,v,x);else if(u===4){let U=i.get(b);if(U!==void 0){let Y=x(U);(0,c.addComponent)(e,v,Y),y=Ge(Y,v,p,y)}}else if(u===5){let U=i.get(b);U!==void 0&&(0,c.removeComponent)(e,v,x(U))}}}return i}};function Le(e,t){let o=new WeakSet,n,a;return(s,r)=>{o.has(s)||(o.add(s),n=Oe(s,e[0],e),a=Ae(e));let i=n(),p=a(r),y=new ArrayBuffer(i.byteLength+p.byteLength),m=new Uint8Array(y);return m.set(new Uint8Array(i),0),m.set(new Uint8Array(p),i.byteLength),y}}function Je(e){let t=new WeakSet,o,n;return(a,s,r)=>{t.has(a)||(t.add(a),o=Ee(a,e[0],e),n=We(e));let i=o(s,r),p=s.slice(i);return n(p,r)}}var Se=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(Se||{});var ke=Symbol("$modifier");function ce(e,t){let o=()=>[e,t];return o[ke]=!0,o}var Xe=e=>ce(e,"not"),Ye=e=>ce(e,"or"),_e=e=>ce(e,"changed");function Ze(e){let t=o=>me(o,e);return t.components=e,t}function et(e){let t=[],o=new WeakSet;return n=>{o.has(n)||(ee(n,ie(...e.components),s=>t.push(s)),o.add(n));let a=t.slice();return t.length=0,a}}function tt(e){let t=[],o=new WeakSet;return n=>{o.has(n)||(ee(n,pe(...e.components),s=>t.push(s)),o.add(n));let a=t.slice();return t.length=0,a}}var nt=(e,t,o)=>C(e,o,t),ot=(e,t,o)=>T(e,o,t),rt=(e,t,o)=>j(e,o,t),at={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},Me={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},st=(e,t=1e5)=>{let o=(n,a)=>{let s={};for(let r in n)if(Array.isArray(n[r])){let[i,p]=n[r];s[r]=Array.from({length:p},()=>new Me[i](a))}else if(typeof n[r]=="object")s[r]=o(n[r],a);else{let i=n[r],p=Me[i];if(p)s[r]=new p(a);else throw new Error(`Unsupported type: ${n[r]}`)}return s};return o(e,t)};
//# sourceMappingURL=index.min.cjs.map
