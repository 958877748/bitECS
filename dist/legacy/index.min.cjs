var w=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var r in t)w(e,r,{get:t[r],enumerable:!0})},L=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of F(t))!O.call(e,o)&&o!==r&&w(e,o,{get:()=>t[o],enumerable:!(a=Q(t,o))||a.enumerable});return e};var M=e=>L(w({},"__esModule",{value:!0}),e);var oe={};P(oe,{$modifier:()=>B,Changed:()=>K,Not:()=>N,Or:()=>J,Types:()=>re,addComponent:()=>_,defineComponent:()=>ne,defineDeserializer:()=>H,defineQuery:()=>X,defineSerializer:()=>G,enterQuery:()=>Y,exitQuery:()=>Z,hasComponent:()=>ee,removeComponent:()=>te});module.exports=M(oe);var f=require("../core"),A=require("../core");var s=require("../core");var D=(e,t,r,a=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(a),i=0,n=[];return(0,s.observe)(e,(0,s.onAdd)(t),y=>{n.push([y,0,-1])}),(0,s.observe)(e,(0,s.onRemove)(t),y=>{n.push([y,1,-1])}),r.forEach((y,p)=>{(0,s.observe)(e,(0,s.onAdd)(t,y),u=>{n.push([u,2,p])}),(0,s.observe)(e,(0,s.onRemove)(t,y),u=>{n.push([u,3,p])})}),()=>{i=0;for(let y=0;y<n.length;y++){let[p,u,b]=n[y];o.setUint32(i,p),i+=4,o.setUint8(i,u),i+=1,o.setUint8(i,b),i+=1}return n.length=0,a.slice(0,i)}},U=(e,t,r)=>(a,o=new Map)=>{let i=new DataView(a),n=0;for(;n<a.byteLength;){let y=i.getUint32(n);n+=4;let p=i.getUint8(n);n+=1;let u=i.getUint8(n);n+=1;let b=r[u],m=o.get(y);m===void 0&&(m=(0,s.addEntity)(e),o.set(y,m)),p===0?(0,s.addComponent)(e,m,t):p===1?(0,s.removeEntity)(e,m):p===2?(0,s.addComponent)(e,m,b):p===3&&(0,s.removeComponent)(e,m,b)}return o};var I=Symbol("u8"),C=Symbol("i8"),x=Symbol("u16"),W=Symbol("i16"),d=Symbol("u32"),T=Symbol("i32"),S=Symbol("f32"),c=Symbol("f64"),l=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),se=l(I),ue=l(C),me=l(x),fe=l(W),le=l(d),de=l(T),ce=l(S),be=l(c),v={[I]:(e,t,r)=>(e.setUint8(t,r),1),[C]:(e,t,r)=>(e.setInt8(t,r),1),[x]:(e,t,r)=>(e.setUint16(t,r),2),[W]:(e,t,r)=>(e.setInt16(t,r),2),[d]:(e,t,r)=>(e.setUint32(t,r),4),[T]:(e,t,r)=>(e.setInt32(t,r),4),[S]:(e,t,r)=>(e.setFloat32(t,r),4),[c]:(e,t,r)=>(e.setFloat64(t,r),8)},z={[I]:(e,t)=>({value:e.getUint8(t),size:1}),[C]:(e,t)=>({value:e.getInt8(t),size:1}),[x]:(e,t)=>({value:e.getUint16(t),size:2}),[W]:(e,t)=>({value:e.getInt16(t),size:2}),[d]:(e,t)=>({value:e.getUint32(t),size:4}),[T]:(e,t)=>({value:e.getInt32(t),size:4}),[S]:(e,t)=>({value:e.getFloat32(t),size:4}),[c]:(e,t)=>({value:e.getFloat64(t),size:8})},q=e=>{let t=Object.keys(e),a=t.map(o=>{let i=e[o];for(let n of[I,C,x,W,d,T,S,c])if(n in i)return n;return c}).map(o=>v[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,i,n)=>{let y=0;y+=v[d](o,i+y,n);for(let p=0;p<t.length;p++)y+=a[p](o,i+y,e[t[p]][n]);return y}},j=e=>{let t=Object.keys(e),a=t.map(o=>{let i=e[o];for(let n of[I,C,x,W,d,T,S,c])if(n in i)return n;return c}).map(o=>z[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,i,n)=>{let y=0,{value:p,size:u}=z[d](o,i+y);y+=u;let b=n?n.get(p)??p:p;for(let m=0;m<t.length;m++){let{value:$,size:k}=a[m](o,i+y);e[t[m]][b]=$,y+=k}return y}},g=(e,t=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(t),a=e.map(q);return o=>{let i=0;for(let n=0;n<o.length;n++){let y=o[n];for(let p=0;p<a.length;p++)i+=a[p](r,i,y)}return t.slice(0,i)}},R=e=>{let t=e.map(j);return(r,a)=>{let o=new DataView(r),i=0;for(;i<r.byteLength;)for(let n=0;n<t.length;n++)i+=t[n](o,i,a)}};var E=require("../core");function G(e,t){let r=new WeakSet,a,o;return i=>{r.has(e)||(r.add(e),a=D(i,e[0],e),o=g(e));let n=a(),y=o((0,E.query)(i,e)),p=new ArrayBuffer(n.byteLength+y.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(n),0),u.set(new Uint8Array(y),n.byteLength),p}}function H(e){let t=new WeakSet,r,a;return(o,i,n)=>{t.has(e)||(t.add(e),r=U(o,e[0],e),a=R(e));let y=r(i,n),p=i.slice(y);return a(p,n)}}var B=Symbol("$modifier");function h(e,t){let r=()=>[e,t];return r[B]=!0,r}var N=e=>h(e,"not"),J=e=>h(e,"or"),K=e=>h(e,"changed");function X(e){let t=r=>(0,f.query)(r,e);return t.components=e,t}function Y(e){let t=[],r=new WeakSet;return a=>{r.has(a)||((0,f.observe)(a,(0,f.onAdd)(...e.components),i=>t.push(i)),r.add(a));let o=t.slice();return t.length=0,o}}function Z(e){let t=[],r=new WeakSet;return a=>{r.has(a)||((0,f.observe)(a,(0,f.onRemove)(...e.terms),i=>t.push(i)),r.add(a));let o=t.slice();return t.length=0,o}}var _=(e,t,r)=>(0,A.addComponent)(e,r,t),ee=(e,t,r)=>(0,A.hasComponent)(e,r,t),te=(e,t,r)=>(0,A.removeComponent)(e,r,t),re={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},V={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},ne=(e,t=1e5)=>{let r=(a,o)=>{let i={};for(let n in a)if(Array.isArray(a[n])){let[y,p]=a[n];i[n]=Array.from({length:p},()=>new V[y](o))}else if(typeof a[n]=="object")i[n]=r(a[n],o);else{let y=a[n],p=V[y];if(p)i[n]=new p(o);else throw new Error(`Unsupported type: ${a[n]}`)}return i};return r(e,t)};
//# sourceMappingURL=index.min.cjs.map
