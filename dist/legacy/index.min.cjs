var S=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var O=(e,t)=>{for(var r in t)S(e,r,{get:t[r],enumerable:!0})},E=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of q(t))!j.call(e,i)&&i!==r&&S(e,i,{get:()=>t[i],enumerable:!(o=F(t,i))||o.enumerable});return e};var L=e=>E(S({},"__esModule",{value:!0}),e);var ie={};O(ie,{$modifier:()=>k,Changed:()=>X,DESERIALIZE_MODE:()=>B,Not:()=>J,Or:()=>K,Types:()=>ne,addComponent:()=>ee,defineComponent:()=>oe,defineDeserializer:()=>H,defineQuery:()=>Y,defineSerializer:()=>N,enterQuery:()=>Z,exitQuery:()=>_,hasComponent:()=>te,removeComponent:()=>re});module.exports=L(ie);var f=require("../core"),A=require("../core");var s=require("../core");var U=(e,t,r,o=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(o),a=0,n=[];return(0,s.observe)(e,(0,s.onAdd)(t),y=>{n.push([y,0,-1])}),(0,s.observe)(e,(0,s.onRemove)(t),y=>{n.push([y,1,-1])}),r.forEach((y,p)=>{(0,s.observe)(e,(0,s.onAdd)(t,y),u=>{n.push([u,2,p])}),(0,s.observe)(e,(0,s.onRemove)(t,y),u=>{n.push([u,3,p])})}),()=>{a=0;for(let y=0;y<n.length;y++){let[p,u,b]=n[y];i.setUint32(a,p),a+=4,i.setUint8(a,u),a+=1,i.setUint8(a,b),a+=1}return n.length=0,o.slice(0,a)}},v=(e,t,r)=>(o,i=new Map)=>{let a=new DataView(o),n=0;for(;n<o.byteLength;){let y=a.getUint32(n);n+=4;let p=a.getUint8(n);n+=1;let u=a.getUint8(n);n+=1;let b=r[u],m=i.get(y);m===void 0&&(m=(0,s.addEntity)(e),i.set(y,m)),p===0?(0,s.addComponent)(e,m,t):p===1?(0,s.removeEntity)(e,m):p===2?(0,s.addComponent)(e,m,b):p===3&&(0,s.removeComponent)(e,m,b)}return i};var C=Symbol("u8"),I=Symbol("i8"),x=Symbol("u16"),W=Symbol("i16"),d=Symbol("u32"),T=Symbol("i32"),w=Symbol("f32"),c=Symbol("f64"),l=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ue=l(C),me=l(I),fe=l(x),le=l(W),de=l(d),ce=l(T),be=l(w),Ae=l(c),z={[C]:(e,t,r)=>(e.setUint8(t,r),1),[I]:(e,t,r)=>(e.setInt8(t,r),1),[x]:(e,t,r)=>(e.setUint16(t,r),2),[W]:(e,t,r)=>(e.setInt16(t,r),2),[d]:(e,t,r)=>(e.setUint32(t,r),4),[T]:(e,t,r)=>(e.setInt32(t,r),4),[w]:(e,t,r)=>(e.setFloat32(t,r),4),[c]:(e,t,r)=>(e.setFloat64(t,r),8)},g={[C]:(e,t)=>({value:e.getUint8(t),size:1}),[I]:(e,t)=>({value:e.getInt8(t),size:1}),[x]:(e,t)=>({value:e.getUint16(t),size:2}),[W]:(e,t)=>({value:e.getInt16(t),size:2}),[d]:(e,t)=>({value:e.getUint32(t),size:4}),[T]:(e,t)=>({value:e.getInt32(t),size:4}),[w]:(e,t)=>({value:e.getFloat32(t),size:4}),[c]:(e,t)=>({value:e.getFloat64(t),size:8})},M=e=>{let t=Object.keys(e),o=t.map(i=>{let a=e[i];for(let n of[C,I,x,W,d,T,w,c])if(n in a)return n;return c}).map(i=>z[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,n)=>{let y=0;y+=z[d](i,a+y,n);for(let p=0;p<t.length;p++)y+=o[p](i,a+y,e[t[p]][n]);return y}},G=e=>{let t=Object.keys(e),o=t.map(i=>{let a=e[i];for(let n of[C,I,x,W,d,T,w,c])if(n in a)return n;return c}).map(i=>g[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,n)=>{let y=0,{value:p,size:u}=g[d](i,a+y);y+=u;let b=n?n.get(p)??p:p;for(let m=0;m<t.length;m++){let{value:Q,size:P}=o[m](i,a+y);e[t[m]][b]=Q,y+=P}return y}},D=(e,t=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(t),o=e.map(M);return i=>{let a=0;for(let n=0;n<i.length;n++){let y=i[n];for(let p=0;p<o.length;p++)a+=o[p](r,a,y)}return t.slice(0,a)}},V=e=>{let t=e.map(G);return(r,o)=>{let i=new DataView(r),a=0;for(;a<r.byteLength;)for(let n=0;n<t.length;n++)a+=t[n](i,a,o)}};var R=require("../core");function N(e,t){let r=new WeakSet,o,i;return a=>{r.has(e)||(r.add(e),o=U(a,e[0],e),i=D(e));let n=o(),y=i((0,R.query)(a,e)),p=new ArrayBuffer(n.byteLength+y.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(n),0),u.set(new Uint8Array(y),n.byteLength),p}}function H(e){let t=new WeakSet,r,o;return(i,a,n)=>{t.has(e)||(t.add(e),r=v(i,e[0],e),o=V(e));let y=r(a,n),p=a.slice(y);return o(p,n)}}var B=(o=>(o[o.REPLACE=0]="REPLACE",o[o.APPEND=1]="APPEND",o[o.MAP=2]="MAP",o))(B||{});var k=Symbol("$modifier");function h(e,t){let r=()=>[e,t];return r[k]=!0,r}var J=e=>h(e,"not"),K=e=>h(e,"or"),X=e=>h(e,"changed");function Y(e){let t=r=>(0,f.query)(r,e);return t.components=e,t}function Z(e){let t=[],r=new WeakSet;return o=>{r.has(o)||((0,f.observe)(o,(0,f.onAdd)(...e.components),a=>t.push(a)),r.add(o));let i=t.slice();return t.length=0,i}}function _(e){let t=[],r=new WeakSet;return o=>{r.has(o)||((0,f.observe)(o,(0,f.onRemove)(...e.terms),a=>t.push(a)),r.add(o));let i=t.slice();return t.length=0,i}}var ee=(e,t,r)=>(0,A.addComponent)(e,r,t),te=(e,t,r)=>(0,A.hasComponent)(e,r,t),re=(e,t,r)=>(0,A.removeComponent)(e,r,t),ne={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},$={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},oe=(e,t=1e5)=>{let r=(o,i)=>{let a={};for(let n in o)if(Array.isArray(o[n])){let[y,p]=o[n];a[n]=Array.from({length:p},()=>new $[y](i))}else if(typeof o[n]=="object")a[n]=r(o[n],i);else{let y=o[n],p=$[y];if(p)a[n]=new p(i);else throw new Error(`Unsupported type: ${o[n]}`)}return a};return r(e,t)};
//# sourceMappingURL=index.min.cjs.map
