var S=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var q=(e,t)=>{for(var o in t)S(e,o,{get:t[o],enumerable:!0})},L=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of V(t))!j.call(e,i)&&i!==o&&S(e,i,{get:()=>t[i],enumerable:!(n=P(t,i))||n.enumerable});return e};var G=e=>L(S({},"__esModule",{value:!0}),e);var pe={};q(pe,{$modifier:()=>M,Changed:()=>ee,DESERIALIZE_MODE:()=>Q,Not:()=>Z,Or:()=>_,Types:()=>ye,addComponent:()=>oe,defineComponent:()=>se,defineDeserializer:()=>Y,defineQuery:()=>te,defineSerializer:()=>X,enterQuery:()=>ne,exitQuery:()=>re,hasComponent:()=>ie,removeComponent:()=>ae});module.exports=G(pe);var c=require("bitecs");var p=require("bitecs");var I=Symbol.for("bitecs-u8"),C=Symbol.for("bitecs-i8"),T=Symbol.for("bitecs-u16"),x=Symbol.for("bitecs-i16"),A=Symbol.for("bitecs-u32"),g=Symbol.for("bitecs-i32"),W=Symbol.for("bitecs-f32"),R=Symbol.for("bitecs-f64"),U=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),me=U(I),le=U(C),ce=U(T),fe=U(x),de=U(A),be=U(g),Ae=U(W),Ie=U(R),$={[I]:(e,t,o)=>(e.setUint8(t,o),1),[C]:(e,t,o)=>(e.setInt8(t,o),1),[T]:(e,t,o)=>(e.setUint16(t,o),2),[x]:(e,t,o)=>(e.setInt16(t,o),2),[A]:(e,t,o)=>(e.setUint32(t,o),4),[g]:(e,t,o)=>(e.setInt32(t,o),4),[W]:(e,t,o)=>(e.setFloat32(t,o),4),[R]:(e,t,o)=>(e.setFloat64(t,o),8)},w={[I]:(e,t)=>({value:e.getUint8(t),size:1}),[C]:(e,t)=>({value:e.getInt8(t),size:1}),[T]:(e,t)=>({value:e.getUint16(t),size:2}),[x]:(e,t)=>({value:e.getInt16(t),size:2}),[A]:(e,t)=>({value:e.getUint32(t),size:4}),[g]:(e,t)=>({value:e.getInt32(t),size:4}),[W]:(e,t)=>({value:e.getFloat32(t),size:4}),[R]:(e,t)=>({value:e.getFloat64(t),size:8})},N=e=>{let t=Object.keys(e),n=t.map(i=>{let a=e[i];for(let r of[I,C,T,x,A,g,W,R])if(r in a)return r;return R}).map(i=>$[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,r)=>{let y=0;y+=$[A](i,a+y,r);for(let s=0;s<t.length;s++)y+=n[s](i,a+y,e[t[s]][r]);return y}},H=e=>{let t=Object.keys(e),n=t.map(i=>{let a=e[i];for(let r of[I,C,T,x,A,g,W,R])if(r in a)return r;return R}).map(i=>w[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,a,r)=>{let y=0,{value:s,size:m}=w[A](i,a+y);y+=m;let u=r?r.get(s)??s:s;for(let l=0;l<t.length;l++){let{value:f,size:b}=n[l](i,a+y);e[t[l]][u]=f,y+=b}return y}},k=(e,t=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(t),n=e.map(N);return i=>{let a=0;for(let r=0;r<i.length;r++){let y=i[r];for(let s=0;s<n.length;s++)a+=n[s](o,a,y)}return t.slice(0,a)}},F=e=>{let t=e.map(H);return(o,n)=>{let i=new DataView(o),a=0;for(;a<o.byteLength;)for(let r=0;r<t.length;r++)a+=t[r](i,a,n)}};function J(e,t,o,n){if(!e)return n;if(Array.isArray(e)){let i=e[t];return i!==void 0?(o.setFloat64(n,i),n+8):n}if(typeof e=="object"){let i=Object.keys(e).sort();for(let a of i){let r=e[a],y=r[t];y!==void 0&&(r instanceof Int8Array||C in r?(o.setInt8(n,y),n+=1):r instanceof Uint8Array||I in r?(o.setUint8(n,y),n+=1):r instanceof Int16Array||x in r?(o.setInt16(n,y),n+=2):r instanceof Uint16Array||T in r?(o.setUint16(n,y),n+=2):r instanceof Int32Array||g in r?(o.setInt32(n,y),n+=4):r instanceof Uint32Array||A in r?(o.setUint32(n,y),n+=4):r instanceof Float32Array||W in r?(o.setFloat32(n,y),n+=4):(o.setFloat64(n,y),n+=8))}}return n}function K(e,t,o,n){if(!e)return n;if(Array.isArray(e))return e[t]=o.getFloat64(n),n+8;if(typeof e=="object"){let i=Object.keys(e).sort();for(let a of i){let r=e[a];r instanceof Int8Array||C in r?(r[t]=o.getInt8(n),n+=1):r instanceof Uint8Array||I in r?(r[t]=o.getUint8(n),n+=1):r instanceof Int16Array||x in r?(r[t]=o.getInt16(n),n+=2):r instanceof Uint16Array||T in r?(r[t]=o.getUint16(n),n+=2):r instanceof Int32Array||g in r?(r[t]=o.getInt32(n),n+=4):r instanceof Uint32Array||A in r?(r[t]=o.getUint32(n),n+=4):r instanceof Float32Array||W in r?(r[t]=o.getFloat32(n),n+=4):(r[t]=o.getFloat64(n),n+=8)}}return n}var B=(e,t,o,n=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(n),a=0,r=[],y=new Map;return(0,p.observe)(e,(0,p.onAdd)(t),s=>{r.push([s,0,-1])}),(0,p.observe)(e,(0,p.onRemove)(t),s=>{r.push([s,1,-1]),y.delete(s)}),o.forEach((s,m)=>{(0,p.isRelation)(s)?((0,p.observe)(e,(0,p.onAdd)(t,s(p.Wildcard)),u=>{let l=(0,p.getRelationTargets)(e,u,s);for(let f of l){y.has(u)||y.set(u,new Map),y.get(u).set(m,f);let b=s(f);r.push([u,4,m,f,b])}}),(0,p.observe)(e,(0,p.onRemove)(t,s(p.Wildcard)),u=>{let l=y.get(u);if(l){let f=l.get(m);f!==void 0&&(r.push([u,5,m,f]),l.delete(m),l.size===0&&y.delete(u))}})):((0,p.observe)(e,(0,p.onAdd)(t,s),u=>{r.push([u,2,m])}),(0,p.observe)(e,(0,p.onRemove)(t,s),u=>{r.push([u,3,m])}))}),()=>{a=0;for(let s=0;s<r.length;s++){let[m,u,l,f,b]=r[s];i.setUint32(a,m),a+=4,i.setUint8(a,u),a+=1,(u===2||u===3||u===4||u===5)&&(i.setUint8(a,l),a+=1,(u===4||u===5)&&(i.setUint32(a,f),a+=4,u===4&&b&&(a=J(b,m,i,a))))}return r.length=0,n.slice(0,a)}},O=(e,t,o,n)=>{let i=n||new Map;return(a,r)=>{let y=r||i,s=new DataView(a),m=0;for(;m<a.byteLength;){let u=s.getUint32(m);m+=4;let l=s.getUint8(m);m+=1;let f=-1,b=-1;(l===2||l===3||l===4||l===5)&&(f=s.getUint8(m),m+=1,(l===4||l===5)&&(b=s.getUint32(m),m+=4));let h=o[f],d=y.get(u);if(l===0)if(d===void 0)d=(0,p.addEntity)(e),y.set(u,d),(0,p.addComponent)(e,d,t);else throw new Error(`Entity with ID ${u} already exists in the mapping.`);else if(d!==void 0&&(0,p.entityExists)(e,d)){if(l===1)(0,p.removeEntity)(e,d);else if(l===2)(0,p.addComponent)(e,d,h);else if(l===3)(0,p.removeComponent)(e,d,h);else if(l===4){let v=y.get(b);if(v!==void 0){let D=h(v);(0,p.addComponent)(e,d,D),m=K(D,d,s,m)}}else if(l===5){let v=y.get(b);v!==void 0&&(0,p.removeComponent)(e,d,h(v))}}}return y}};function X(e,t){let o=new WeakSet,n,i;return(a,r)=>{o.has(a)||(o.add(a),n=B(a,e[0],e),i=k(e));let y=n(),s=i(r),m=new ArrayBuffer(y.byteLength+s.byteLength),u=new Uint8Array(m);return u.set(new Uint8Array(y),0),u.set(new Uint8Array(s),y.byteLength),m}}function Y(e){let t=new WeakSet,o,n;return(i,a,r)=>{t.has(i)||(t.add(i),o=O(i,e[0],e),n=F(e));let y=o(a,r),s=a.slice(y);return n(s,r)}}var Q=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(Q||{});var M=Symbol("$modifier");function z(e,t){let o=()=>[e,t];return o[M]=!0,o}var Z=e=>z(e,"not"),_=e=>z(e,"or"),ee=e=>z(e,"changed");function te(e){let t=o=>(0,c.query)(o,e);return t.components=e,t}function ne(e){let t=[],o=new WeakSet;return n=>{o.has(n)||((0,c.observe)(n,(0,c.onAdd)(...e.components),a=>t.push(a)),o.add(n));let i=t.slice();return t.length=0,i}}function re(e){let t=[],o=new WeakSet;return n=>{o.has(n)||((0,c.observe)(n,(0,c.onRemove)(...e.components),a=>t.push(a)),o.add(n));let i=t.slice();return t.length=0,i}}var oe=(e,t,o)=>(0,c.addComponent)(e,o,t),ie=(e,t,o)=>(0,c.hasComponent)(e,o,t),ae=(e,t,o)=>(0,c.removeComponent)(e,o,t),ye={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},E={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},se=(e,t=1e5)=>{let o=(n,i)=>{let a={};for(let r in n)if(Array.isArray(n[r])){let[y,s]=n[r];a[r]=Array.from({length:s},()=>new E[y](i))}else if(typeof n[r]=="object")a[r]=o(n[r],i);else{let y=n[r],s=E[y];if(s)a[r]=new s(i);else throw new Error(`Unsupported type: ${n[r]}`)}return a};return o(e,t)};
//# sourceMappingURL=index.min.cjs.map
