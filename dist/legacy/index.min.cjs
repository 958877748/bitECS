var E=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var ee=(e,r)=>{for(var t in r)E(e,t,{get:r[t],enumerable:!0})},re=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let y of Z(r))!_.call(e,y)&&y!==t&&E(e,y,{get:()=>r[y],enumerable:!(n=Y(r,y))||n.enumerable});return e};var te=e=>re(E({},"__esModule",{value:!0}),e);var $e={};ee($e,{$modifier:()=>X,Changed:()=>he,DESERIALIZE_MODE:()=>J,Not:()=>Ce,Or:()=>Se,Types:()=>De,addComponent:()=>Ue,defineComponent:()=>Fe,defineDeserializer:()=>ge,defineQuery:()=>ze,defineSerializer:()=>Ie,enterQuery:()=>xe,exitQuery:()=>We,hasComponent:()=>Re,removeComponent:()=>ve});module.exports=te($e);var T=require("bitecs");var f=require("bitecs");var S=Symbol.for("bitecs-u8"),x=Symbol.for("bitecs-i8"),h=Symbol.for("bitecs-u16"),W=Symbol.for("bitecs-i16"),b=Symbol.for("bitecs-u32"),U=Symbol.for("bitecs-i32"),z=Symbol.for("bitecs-f32"),D=Symbol.for("bitecs-f64"),P=Symbol.for("bitecs-arr"),v=e=>(r=[])=>Object.defineProperty(r,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ne=v(S),oe=v(x),ie=v(h),ae=v(W),ye=v(b),se=v(U),pe=v(z),ue=v(D),le=new Map([[ne,S],[oe,x],[ie,h],[ae,W],[ye,b],[se,U],[pe,z],[ue,D]]),g={[S]:(e,r,t)=>(e.setUint8(r,t),1),[x]:(e,r,t)=>(e.setInt8(r,t),1),[h]:(e,r,t)=>(e.setUint16(r,t),2),[W]:(e,r,t)=>(e.setInt16(r,t),2),[b]:(e,r,t)=>(e.setUint32(r,t),4),[U]:(e,r,t)=>(e.setInt32(r,t),4),[z]:(e,r,t)=>(e.setFloat32(r,t),4),[D]:(e,r,t)=>(e.setFloat64(r,t),8)},C={[S]:(e,r)=>({value:e.getUint8(r),size:1}),[x]:(e,r)=>({value:e.getInt8(r),size:1}),[h]:(e,r)=>({value:e.getUint16(r),size:2}),[W]:(e,r)=>({value:e.getInt16(r),size:2}),[b]:(e,r)=>({value:e.getUint32(r),size:4}),[U]:(e,r)=>({value:e.getInt32(r),size:4}),[z]:(e,r)=>({value:e.getFloat32(r),size:4}),[D]:(e,r)=>({value:e.getFloat64(r),size:8})};function w(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let r=le.get(e);if(r)return r;throw new Error(`Unknown type function: ${e}`)}return R(e)?w(e[P]):z}function O(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function B(e){if(R(e))return w(e[P]);for(let r of[S,x,h,W,b,U,z,D])if(r in e)return r;return e instanceof Int8Array?x:e instanceof Uint8Array?S:e instanceof Int16Array?W:e instanceof Uint16Array?h:e instanceof Int32Array?U:e instanceof Uint32Array?b:e instanceof Float32Array?z:D}function R(e){return Array.isArray(e)&&P in e}function $(e){return e[P]}function M(e,r,t,n){let y=0,s=Array.isArray(r)?1:0;if(y+=g[S](t,n,s),!s)return y;y+=g[b](t,n+y,r.length);for(let o=0;o<r.length;o++){let a=r[o];if(R(e))y+=M($(e),a,t,n+y);else{let i=w(e);y+=g[i](t,n+y,a)}}return y}function Q(e,r,t){let n=0,y=C[S](r,t+n);if(n+=y.size,!y.value)return{size:n};let s=C[b](r,t+n);n+=s.size;let o=new Array(s.value);for(let a=0;a<o.length;a++)if(R(e)){let{value:i,size:p}=Q($(e),r,t+n);n+=p,Array.isArray(i)&&(o[a]=i)}else{let i=w(e),{value:p,size:u}=C[i](r,t+n);n+=u,o[a]=p}return{value:o,size:n}}var ce=e=>{let r=B(e);return r===z||r===D},me=(e,r)=>ce(e)?r:0,fe=(e,r)=>{let t=e.get(r);return t||(ArrayBuffer.isView(r)?t=new r.constructor(r.length):t=new Array(r.length).fill(0),e.set(r,t)),t},q=(e,r,t,n=1e-4)=>{let y=fe(e,r),s=r[t],o=me(r,n),a=o>0?Math.abs(y[t]-s)>o:y[t]!==s;return y[t]=s,a},Ae=(e,r=!1,t,n=1e-4)=>{if(O(e)){let a=B(e),i=g[a];return(p,u,l,c)=>{if(r&&t){if(!q(t,e,l,n))return 0;let m=0;return m+=g[b](p,u+m,l),m+=g[b](p,u+m,c),m+=i(p,u+m,e[l]),m}else{let m=0;return m+=g[b](p,u+m,l),m+=i(p,u+m,e[l]),m}}}let y=Object.keys(e),o=y.map(a=>{let i=e[a];if(!O(i))throw new Error(`Invalid array type for property ${a}`);return B(i)}).map(a=>g[a]||(()=>{throw new Error("Unsupported or unannotated type")}));return(a,i,p,u)=>{if(r&&t){let l=0;for(let d=0;d<y.length;d++){let A=e[y[d]];q(t,A,p,n)&&(l|=1<<d)}if(l===0)return 0;let c=0;c+=g[b](a,i+c,p),c+=g[b](a,i+c,u);let m=y.length<=8?g[S]:y.length<=16?g[h]:g[b];c+=m(a,i+c,l);for(let d=0;d<y.length;d++)if(l&1<<d){let A=e[y[d]];R(A)?c+=M($(A),A[p],a,i+c):c+=o[d](a,i+c,A[p])}return c}else{let l=0;l+=g[b](a,i+l,p);for(let c=0;c<y.length;c++){let m=e[y[c]];R(m)?l+=M($(m),m[p],a,i+l):l+=o[c](a,i+l,m[p])}return l}}},be=(e,r=!1)=>{if(O(e)){let s=B(e),o=C[s];return(a,i,p)=>{let u=0,{value:l,size:c}=C[b](a,i);u+=c;let m=p?p.get(l)??l:l;if(r){let{size:I}=C[b](a,i+u);u+=I}let{value:d,size:A}=o(a,i+u);return e[m]=d,u+A}}let t=Object.keys(e),y=t.map(s=>{let o=e[s];if(!O(o))throw new Error(`Invalid array type for property ${s}`);return B(o)}).map(s=>C[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,o,a)=>{let i=0,{value:p,size:u}=C[b](s,o+i);i+=u;let l=a?a.get(p)??p:p;if(r){let{size:c}=C[b](s,o+i);i+=c;let m=t.length<=8?C[S]:t.length<=16?C[h]:C[b],{value:d,size:A}=m(s,o+i);i+=A;for(let I=0;I<t.length;I++)if(d&1<<I){let F=e[t[I]];if(R(F)){let{value:k,size:V}=Q($(F),s,o+i);Array.isArray(k)&&(F[l]=k),i+=V}else{let{value:k,size:V}=y[I](s,o+i);e[t[I]][l]=k,i+=V}}}else for(let c=0;c<t.length;c++){let m=e[t[c]];if(R(m)){let{value:d,size:A}=Q($(m),s,o+i);Array.isArray(d)&&(m[l]=d),i+=A}else{let{value:d,size:A}=y[c](s,o+i);e[t[c]][l]=d,i+=A}}return i}},L=(e,r={})=>{let{diff:t=!1,buffer:n=new ArrayBuffer(1024*1024*100),epsilon:y=1e-4}=r,s=new DataView(n),o=t?new Map:void 0,a=e.map(i=>Ae(i,t,o,y));return i=>{let p=0;for(let u=0;u<i.length;u++){let l=i[u];for(let c=0;c<a.length;c++)p+=a[c](s,p,l,c)}return n.slice(0,p)}},G=(e,r={})=>{let{diff:t=!1}=r,n=e.map(y=>be(y,t));return(y,s)=>{let o=new DataView(y),a=0;for(;a<y.byteLength;)if(t){let{value:i,size:p}=C[b](o,a),{value:u,size:l}=C[b](o,a+p);a+=n[u](o,a,s)}else for(let i=0;i<n.length;i++)a+=n[i](o,a,s)}};function de(e,r,t,n){if(!e)return n;if(Array.isArray(e)){let y=e[r];return y!==void 0?(t.setFloat64(n,y),n+8):n}if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s],a=o[r];a!==void 0&&(o instanceof Int8Array||x in o?(t.setInt8(n,a),n+=1):o instanceof Uint8Array||S in o?(t.setUint8(n,a),n+=1):o instanceof Int16Array||W in o?(t.setInt16(n,a),n+=2):o instanceof Uint16Array||h in o?(t.setUint16(n,a),n+=2):o instanceof Int32Array||U in o?(t.setInt32(n,a),n+=4):o instanceof Uint32Array||b in o?(t.setUint32(n,a),n+=4):o instanceof Float32Array||z in o?(t.setFloat32(n,a),n+=4):(t.setFloat64(n,a),n+=8))}}return n}function Te(e,r,t,n){if(!e)return n;if(Array.isArray(e))return e[r]=t.getFloat64(n),n+8;if(typeof e=="object"){let y=Object.keys(e).sort();for(let s of y){let o=e[s];o instanceof Int8Array||x in o?(o[r]=t.getInt8(n),n+=1):o instanceof Uint8Array||S in o?(o[r]=t.getUint8(n),n+=1):o instanceof Int16Array||W in o?(o[r]=t.getInt16(n),n+=2):o instanceof Uint16Array||h in o?(o[r]=t.getUint16(n),n+=2):o instanceof Int32Array||U in o?(o[r]=t.getInt32(n),n+=4):o instanceof Uint32Array||b in o?(o[r]=t.getUint32(n),n+=4):o instanceof Float32Array||z in o?(o[r]=t.getFloat32(n),n+=4):(o[r]=t.getFloat64(n),n+=8)}}return n}var N=(e,r,t,n=new ArrayBuffer(1024*1024*100))=>{let y=new DataView(n),s=0,o=[],a=new Map;return(0,f.observe)(e,(0,f.onAdd)(r),i=>{o.push([i,0,-1])}),(0,f.observe)(e,(0,f.onRemove)(r),i=>{o.push([i,1,-1]),a.delete(i)}),t.forEach((i,p)=>{(0,f.isRelation)(i)?((0,f.observe)(e,(0,f.onAdd)(r,i(f.Wildcard)),u=>{let l=(0,f.getRelationTargets)(e,u,i);for(let c of l){a.has(u)||a.set(u,new Map),a.get(u).set(p,c);let m=i(c);o.push([u,4,p,c,m])}}),(0,f.observe)(e,(0,f.onRemove)(r,i(f.Wildcard)),u=>{let l=a.get(u);if(l){let c=l.get(p);c!==void 0&&(o.push([u,5,p,c]),l.delete(p),l.size===0&&a.delete(u))}})):((0,f.observe)(e,(0,f.onAdd)(r,i),u=>{o.push([u,2,p])}),(0,f.observe)(e,(0,f.onRemove)(r,i),u=>{o.push([u,3,p])}))}),()=>{s=0;for(let i=0;i<o.length;i++){let[p,u,l,c,m]=o[i];y.setUint32(s,p),s+=4,y.setUint8(s,u),s+=1,(u===2||u===3||u===4||u===5)&&(y.setUint8(s,l),s+=1,(u===4||u===5)&&(y.setUint32(s,c),s+=4,u===4&&m&&(s=de(m,p,y,s))))}return o.length=0,n.slice(0,s)}},H=(e,r,t,n)=>{let y=n||new Map;return(s,o)=>{let a=o||y,i=new DataView(s),p=0;for(;p<s.byteLength;){let u=i.getUint32(p);p+=4;let l=i.getUint8(p);p+=1;let c=-1,m=-1;(l===2||l===3||l===4||l===5)&&(c=i.getUint8(p),p+=1,(l===4||l===5)&&(m=i.getUint32(p),p+=4));let d=t[c],A=a.get(u);if(l===0)A===void 0?(A=(0,f.addEntity)(e),a.set(u,A),(0,f.addComponent)(e,A,r)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(A!==void 0&&(0,f.entityExists)(e,A)){if(l===1)(0,f.removeEntity)(e,A),a.delete(u);else if(l===2)(0,f.addComponent)(e,A,d);else if(l===3)(0,f.removeComponent)(e,A,d);else if(l===4){let I=a.get(m);if(I!==void 0){let F=d(I);(0,f.addComponent)(e,A,F),p=Te(F,A,i,p)}}else if(l===5){let I=a.get(m);I!==void 0&&(0,f.removeComponent)(e,A,d(I))}}}return a}};function Ie(e,r){let t=new WeakSet,n,y;return(s,o)=>{t.has(s)||(t.add(s),n=N(s,e[0],e),y=L(e));let a=n(),i=y(o),p=new ArrayBuffer(a.byteLength+i.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(a),0),u.set(new Uint8Array(i),a.byteLength),p}}function ge(e){let r=new WeakSet,t,n;return(y,s,o)=>{r.has(y)||(r.add(y),t=H(y,e[0],e),n=G(e));let a=t(s,o),i=s.slice(a);return n(i,o)}}var J=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(J||{});var X=Symbol("$modifier");function j(e,r){let t=()=>[e,r];return t[X]=!0,t}var Ce=e=>j(e,"not"),Se=e=>j(e,"or"),he=e=>j(e,"changed");function ze(e){let r=t=>(0,T.query)(t,e);return r.components=e,r}function xe(e){let r=[],t=new WeakSet;return n=>{t.has(n)||((0,T.observe)(n,(0,T.onAdd)(...e.components),s=>r.push(s)),t.add(n));let y=r.slice();return r.length=0,y}}function We(e){let r=[],t=new WeakSet;return n=>{t.has(n)||((0,T.observe)(n,(0,T.onRemove)(...e.components),s=>r.push(s)),t.add(n));let y=r.slice();return r.length=0,y}}var Ue=(e,r,t)=>(0,T.addComponent)(e,t,r),Re=(e,r,t)=>(0,T.hasComponent)(e,t,r),ve=(e,r,t)=>(0,T.removeComponent)(e,t,r),De={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},K={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Fe=(e,r=1e5)=>{let t=(n,y)=>{let s={};for(let o in n)if(Array.isArray(n[o])){let[a,i]=n[o];s[o]=Array.from({length:i},()=>new K[a](y))}else if(typeof n[o]=="object")s[o]=t(n[o],y);else{let a=n[o],i=K[a];if(i)s[o]=new i(y);else throw new Error(`Unsupported type: ${n[o]}`)}return s};return t(e,r)};
//# sourceMappingURL=index.min.cjs.map
