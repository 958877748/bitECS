var M=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(e,t)=>{for(var r in t)M(e,r,{get:t[r],enumerable:!0})},re=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of _(t))!ee.call(e,a)&&a!==r&&M(e,a,{get:()=>t[a],enumerable:!(n=Z(t,a))||n.enumerable});return e};var ne=e=>re(M({},"__esModule",{value:!0}),e);var ke={};te(ke,{$modifier:()=>Y,Changed:()=>Re,DESERIALIZE_MODE:()=>K,Not:()=>Ce,Or:()=>We,Types:()=>Be,addComponent:()=>Fe,defineComponent:()=>Oe,defineDeserializer:()=>xe,defineQuery:()=>Ue,defineSerializer:()=>ze,enterQuery:()=>ve,exitQuery:()=>De,hasComponent:()=>$e,removeComponent:()=>we});module.exports=ne(ke);var g=require("bitecs");var f=require("bitecs");var h=Symbol.for("bitecs-u8"),C=Symbol.for("bitecs-i8"),z=Symbol.for("bitecs-u16"),W=Symbol.for("bitecs-i16"),d=Symbol.for("bitecs-u32"),R=Symbol.for("bitecs-i32"),x=Symbol.for("bitecs-f32"),D=Symbol.for("bitecs-f64"),B=Symbol.for("bitecs-str"),V=Symbol.for("bitecs-arr"),U=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),oe=U(h),ie=U(C),ae=U(z),ye=U(W),se=U(d),pe=U(R),ue=U(x),le=U(D),ce=U(B),me=new Map([[oe,h],[ie,C],[ae,z],[ye,W],[se,d],[pe,R],[ue,x],[le,D],[ce,B]]),T={[h]:(e,t,r)=>(e.setUint8(t,r),1),[C]:(e,t,r)=>(e.setInt8(t,r),1),[z]:(e,t,r)=>(e.setUint16(t,r),2),[W]:(e,t,r)=>(e.setInt16(t,r),2),[d]:(e,t,r)=>(e.setUint32(t,r),4),[R]:(e,t,r)=>(e.setInt32(t,r),4),[x]:(e,t,r)=>(e.setFloat32(t,r),4),[D]:(e,t,r)=>(e.setFloat64(t,r),8),[B]:(e,t,r)=>{let a=fe.encode(r),s=0;return s+=T[d](e,t+s,a.length),new Uint8Array(e.buffer,e.byteOffset+t+s,a.length).set(a),s+=a.length,s}},I={[h]:(e,t)=>({value:e.getUint8(t),size:1}),[C]:(e,t)=>({value:e.getInt8(t),size:1}),[z]:(e,t)=>({value:e.getUint16(t),size:2}),[W]:(e,t)=>({value:e.getInt16(t),size:2}),[d]:(e,t)=>({value:e.getUint32(t),size:4}),[R]:(e,t)=>({value:e.getInt32(t),size:4}),[x]:(e,t)=>({value:e.getFloat32(t),size:4}),[D]:(e,t)=>({value:e.getFloat64(t),size:8}),[B]:(e,t)=>{let{value:r,size:n}=I[d](e,t),a=new Uint8Array(e.buffer,e.byteOffset+t+n,r);return{value:be.decode(a),size:n+r}}};function P(e){if(typeof e=="symbol")return e;if(typeof e=="function"){let t=me.get(e);if(t)return t;throw new Error(`Unknown type function: ${e}`)}return v(e)?P(e[V]):x}var fe=new TextEncoder,be=new TextDecoder;function k(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function w(e){if(v(e))return P(e[V]);for(let t of[h,C,z,W,d,R,x,D,B])if(t in e)return t;return e instanceof Int8Array?C:e instanceof Uint8Array?h:e instanceof Int16Array?W:e instanceof Uint16Array?z:e instanceof Int32Array?R:e instanceof Uint32Array?d:e instanceof Float32Array?x:D}function v(e){return Array.isArray(e)&&V in e}function $(e){return e[V]}function Q(e,t,r,n){let a=0,s=Array.isArray(t)?1:0;if(a+=T[h](r,n,s),!s)return a;a+=T[d](r,n+a,t.length);for(let o=0;o<t.length;o++){let y=t[o];if(v(e))a+=Q($(e),y,r,n+a);else{let i=P(e);a+=T[i](r,n+a,y)}}return a}function j(e,t,r){let n=0,a=I[h](t,r+n);if(n+=a.size,!a.value)return{size:n};let s=I[d](t,r+n);n+=s.size;let o=new Array(s.value);for(let y=0;y<o.length;y++)if(v(e)){let{value:i,size:p}=j($(e),t,r+n);n+=p,Array.isArray(i)&&(o[y]=i)}else{let i=P(e),{value:p,size:u}=I[i](t,r+n);n+=u,o[y]=p}return{value:o,size:n}}var de=e=>{let t=w(e);return t===x||t===D},Ae=(e,t)=>de(e)?t:0,Te=(e,t)=>{let r=e.get(t);return r||(ArrayBuffer.isView(t)?r=new t.constructor(t.length):r=new Array(t.length).fill(0),e.set(t,r)),r},L=(e,t,r,n=1e-4)=>{let a=Te(e,t),s=t[r],o=Ae(t,n),y=o>0?Math.abs(a[r]-s)>o:a[r]!==s;return a[r]=s,y},Ie=(e,t=!1,r,n=1e-4)=>{if(k(e)){let y=w(e),i=T[y];return(p,u,l,c)=>{if(t&&r){if(!L(r,e,l,n))return 0;let m=0;return m+=T[d](p,u+m,l),m+=T[d](p,u+m,c),m+=i(p,u+m,e[l]),m}else{let m=0;return m+=T[d](p,u+m,l),m+=i(p,u+m,e[l]),m}}}let a=Object.keys(e),o=a.map(y=>{let i=e[y];if(!k(i))throw new Error(`Invalid array type for property ${y}`);return w(i)}).map(y=>T[y]||(()=>{throw new Error("Unsupported or unannotated type")}));return(y,i,p,u)=>{if(t&&r){let l=0;for(let A=0;A<a.length;A++){let b=e[a[A]];L(r,b,p,n)&&(l|=1<<A)}if(l===0)return 0;let c=0;c+=T[d](y,i+c,p),c+=T[d](y,i+c,u);let m=a.length<=8?T[h]:a.length<=16?T[z]:T[d];c+=m(y,i+c,l);for(let A=0;A<a.length;A++)if(l&1<<A){let b=e[a[A]];v(b)?c+=Q($(b),b[p],y,i+c):c+=o[A](y,i+c,b[p])}return c}else{let l=0;l+=T[d](y,i+l,p);for(let c=0;c<a.length;c++){let m=e[a[c]];v(m)?l+=Q($(m),m[p],y,i+l):l+=o[c](y,i+l,m[p])}return l}}},ge=(e,t=!1)=>{if(k(e)){let s=w(e),o=I[s];return(y,i,p)=>{let u=0,{value:l,size:c}=I[d](y,i);u+=c;let m=p?p.get(l)??l:l;if(t){let{size:S}=I[d](y,i+u);u+=S}let{value:A,size:b}=o(y,i+u);return e[m]=A,u+b}}let r=Object.keys(e),a=r.map(s=>{let o=e[s];if(!k(o))throw new Error(`Invalid array type for property ${s}`);return w(o)}).map(s=>I[s]||(()=>{throw new Error("Unsupported or unannotated type")}));return(s,o,y)=>{let i=0,{value:p,size:u}=I[d](s,o+i);i+=u;let l=y?y.get(p)??p:p;if(t){let{size:c}=I[d](s,o+i);i+=c;let m=r.length<=8?I[h]:r.length<=16?I[z]:I[d],{value:A,size:b}=m(s,o+i);i+=b;for(let S=0;S<r.length;S++)if(A&1<<S){let F=e[r[S]];if(v(F)){let{value:O,size:E}=j($(F),s,o+i);Array.isArray(O)&&(F[l]=O),i+=E}else{let{value:O,size:E}=a[S](s,o+i);e[r[S]][l]=O,i+=E}}}else for(let c=0;c<r.length;c++){let m=e[r[c]];if(v(m)){let{value:A,size:b}=j($(m),s,o+i);Array.isArray(A)&&(m[l]=A),i+=b}else{let{value:A,size:b}=a[c](s,o+i);e[r[c]][l]=A,i+=b}}return i}},G=(e,t={})=>{let{diff:r=!1,buffer:n=new ArrayBuffer(1024*1024*100),epsilon:a=1e-4}=t,s=new DataView(n),o=r?new Map:void 0,y=e.map(i=>Ie(i,r,o,a));return i=>{let p=0;for(let u=0;u<i.length;u++){let l=i[u];for(let c=0;c<y.length;c++)p+=y[c](s,p,l,c)}return n.slice(0,p)}},N=(e,t={})=>{let{diff:r=!1}=t,n=e.map(a=>ge(a,r));return(a,s)=>{let o=new DataView(a),y=0;for(;y<a.byteLength;)if(r){let{value:i,size:p}=I[d](o,y),{value:u,size:l}=I[d](o,y+p);y+=n[u](o,y,s)}else for(let i=0;i<n.length;i++)y+=n[i](o,y,s)}};function Se(e,t,r,n){if(!e)return n;if(Array.isArray(e)){let a=e[t];return a!==void 0?(r.setFloat64(n,a),n+8):n}if(typeof e=="object"){let a=Object.keys(e).sort();for(let s of a){let o=e[s],y=o[t];y!==void 0&&(o instanceof Int8Array||C in o?(r.setInt8(n,y),n+=1):o instanceof Uint8Array||h in o?(r.setUint8(n,y),n+=1):o instanceof Int16Array||W in o?(r.setInt16(n,y),n+=2):o instanceof Uint16Array||z in o?(r.setUint16(n,y),n+=2):o instanceof Int32Array||R in o?(r.setInt32(n,y),n+=4):o instanceof Uint32Array||d in o?(r.setUint32(n,y),n+=4):o instanceof Float32Array||x in o?(r.setFloat32(n,y),n+=4):(r.setFloat64(n,y),n+=8))}}return n}function he(e,t,r,n){if(!e)return n;if(Array.isArray(e))return e[t]=r.getFloat64(n),n+8;if(typeof e=="object"){let a=Object.keys(e).sort();for(let s of a){let o=e[s];o instanceof Int8Array||C in o?(o[t]=r.getInt8(n),n+=1):o instanceof Uint8Array||h in o?(o[t]=r.getUint8(n),n+=1):o instanceof Int16Array||W in o?(o[t]=r.getInt16(n),n+=2):o instanceof Uint16Array||z in o?(o[t]=r.getUint16(n),n+=2):o instanceof Int32Array||R in o?(o[t]=r.getInt32(n),n+=4):o instanceof Uint32Array||d in o?(o[t]=r.getUint32(n),n+=4):o instanceof Float32Array||x in o?(o[t]=r.getFloat32(n),n+=4):(o[t]=r.getFloat64(n),n+=8)}}return n}var H=(e,t,r,n=new ArrayBuffer(1024*1024*100))=>{let a=new DataView(n),s=0,o=[],y=new Map;return(0,f.observe)(e,(0,f.onAdd)(t),i=>{o.push([i,0,-1])}),(0,f.observe)(e,(0,f.onRemove)(t),i=>{o.push([i,1,-1]),y.delete(i)}),r.forEach((i,p)=>{(0,f.isRelation)(i)?((0,f.observe)(e,(0,f.onAdd)(t,i(f.Wildcard)),u=>{let l=(0,f.getRelationTargets)(e,u,i);for(let c of l){y.has(u)||y.set(u,new Map),y.get(u).set(p,c);let m=i(c);o.push([u,4,p,c,m])}}),(0,f.observe)(e,(0,f.onRemove)(t,i(f.Wildcard)),u=>{let l=y.get(u);if(l){let c=l.get(p);c!==void 0&&(o.push([u,5,p,c]),l.delete(p),l.size===0&&y.delete(u))}})):((0,f.observe)(e,(0,f.onAdd)(t,i),u=>{o.push([u,2,p])}),(0,f.observe)(e,(0,f.onRemove)(t,i),u=>{o.push([u,3,p])}))}),()=>{s=0;for(let i=0;i<o.length;i++){let[p,u,l,c,m]=o[i];a.setUint32(s,p),s+=4,a.setUint8(s,u),s+=1,(u===2||u===3||u===4||u===5)&&(a.setUint8(s,l),s+=1,(u===4||u===5)&&(a.setUint32(s,c),s+=4,u===4&&m&&(s=Se(m,p,a,s))))}return o.length=0,n.slice(0,s)}},J=(e,t,r,n)=>{let a=n||new Map;return(s,o)=>{let y=o||a,i=new DataView(s),p=0;for(;p<s.byteLength;){let u=i.getUint32(p);p+=4;let l=i.getUint8(p);p+=1;let c=-1,m=-1;(l===2||l===3||l===4||l===5)&&(c=i.getUint8(p),p+=1,(l===4||l===5)&&(m=i.getUint32(p),p+=4));let A=r[c],b=y.get(u);if(l===0)b===void 0?(b=(0,f.addEntity)(e),y.set(u,b),(0,f.addComponent)(e,b,t)):console.warn(`Attempted to deserialize addEntity with ID ${u}, but it has already been deserialzied and exists in the mapping.`);else if(b!==void 0&&(0,f.entityExists)(e,b)){if(l===1)(0,f.removeEntity)(e,b),y.delete(u);else if(l===2)(0,f.addComponent)(e,b,A);else if(l===3)(0,f.removeComponent)(e,b,A);else if(l===4){let S=y.get(m);if(S!==void 0){let F=A(S);(0,f.addComponent)(e,b,F),p=he(F,b,i,p)}}else if(l===5){let S=y.get(m);S!==void 0&&(0,f.removeComponent)(e,b,A(S))}}}return y}};function ze(e,t){let r=new WeakSet,n,a;return(s,o)=>{r.has(s)||(r.add(s),n=H(s,e[0],e),a=G(e));let y=n(),i=a(o),p=new ArrayBuffer(y.byteLength+i.byteLength),u=new Uint8Array(p);return u.set(new Uint8Array(y),0),u.set(new Uint8Array(i),y.byteLength),p}}function xe(e){let t=new WeakSet,r,n;return(a,s,o)=>{t.has(a)||(t.add(a),r=J(a,e[0],e),n=N(e));let y=r(s,o),i=s.slice(y);return n(i,o)}}var K=(n=>(n[n.REPLACE=0]="REPLACE",n[n.APPEND=1]="APPEND",n[n.MAP=2]="MAP",n))(K||{});var Y=Symbol("$modifier");function q(e,t){let r=()=>[e,t];return r[Y]=!0,r}var Ce=e=>q(e,"not"),We=e=>q(e,"or"),Re=e=>q(e,"changed");function Ue(e){let t=r=>(0,g.query)(r,e);return t.components=e,t}function ve(e){let t=[],r=new WeakSet;return n=>{r.has(n)||((0,g.observe)(n,(0,g.onAdd)(...e.components),s=>t.push(s)),r.add(n));let a=t.slice();return t.length=0,a}}function De(e){let t=[],r=new WeakSet;return n=>{r.has(n)||((0,g.observe)(n,(0,g.onRemove)(...e.components),s=>t.push(s)),r.add(n));let a=t.slice();return t.length=0,a}}var Fe=(e,t,r)=>(0,g.addComponent)(e,r,t),$e=(e,t,r)=>(0,g.hasComponent)(e,r,t),we=(e,t,r)=>(0,g.removeComponent)(e,r,t),Be={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},X={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Oe=(e,t=1e5)=>{let r=(n,a)=>{let s={};for(let o in n)if(Array.isArray(n[o])){let[y,i]=n[o];s[o]=Array.from({length:i},()=>new X[y](a))}else if(typeof n[o]=="object")s[o]=r(n[o],a);else{let y=n[o],i=X[y];if(i)s[o]=new i(a);else throw new Error(`Unsupported type: ${n[o]}`)}return s};return r(e,t)};
//# sourceMappingURL=index.min.cjs.map
