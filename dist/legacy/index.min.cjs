var w=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var H=(e,t)=>{for(var i in t)w(e,i,{get:t[i],enumerable:!0})},J=(e,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of G(t))!N.call(e,o)&&o!==i&&w(e,o,{get:()=>t[o],enumerable:!(r=L(t,o))||r.enumerable});return e};var K=e=>J(w({},"__esModule",{value:!0}),e);var ce={};H(ce,{$modifier:()=>M,Changed:()=>ie,DESERIALIZE_MODE:()=>E,Not:()=>re,Or:()=>ne,Types:()=>le,addComponent:()=>se,defineComponent:()=>me,defineDeserializer:()=>te,defineQuery:()=>oe,defineSerializer:()=>ee,enterQuery:()=>ae,exitQuery:()=>ye,hasComponent:()=>pe,removeComponent:()=>ue});module.exports=K(ce);var b=require("bitecs");var l=require("bitecs");var C=Symbol.for("bitecs-u8"),g=Symbol.for("bitecs-i8"),x=Symbol.for("bitecs-u16"),W=Symbol.for("bitecs-i16"),A=Symbol.for("bitecs-u32"),v=Symbol.for("bitecs-i32"),U=Symbol.for("bitecs-f32"),D=Symbol.for("bitecs-f64"),O=Symbol.for("bitecs-arr"),R=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),fe=R(C),be=R(g),Ae=R(x),Ie=R(W),Te=R(A),Ce=R(v),ge=R(U),xe=R(D),h={[C]:(e,t,i)=>(e.setUint8(t,i),1),[g]:(e,t,i)=>(e.setInt8(t,i),1),[x]:(e,t,i)=>(e.setUint16(t,i),2),[W]:(e,t,i)=>(e.setInt16(t,i),2),[A]:(e,t,i)=>(e.setUint32(t,i),4),[v]:(e,t,i)=>(e.setInt32(t,i),4),[U]:(e,t,i)=>(e.setFloat32(t,i),4),[D]:(e,t,i)=>(e.setFloat64(t,i),8)},S={[C]:(e,t)=>({value:e.getUint8(t),size:1}),[g]:(e,t)=>({value:e.getInt8(t),size:1}),[x]:(e,t)=>({value:e.getUint16(t),size:2}),[W]:(e,t)=>({value:e.getInt16(t),size:2}),[A]:(e,t)=>({value:e.getUint32(t),size:4}),[v]:(e,t)=>({value:e.getInt32(t),size:4}),[U]:(e,t)=>({value:e.getFloat32(t),size:4}),[D]:(e,t)=>({value:e.getFloat64(t),size:8})};function B(e){return e&&(ArrayBuffer.isView(e)||Array.isArray(e)&&typeof e=="object")}function $(e){for(let t of[C,g,x,W,A,v,U,D])if(t in e)return t;return e instanceof Int8Array?g:e instanceof Uint8Array?C:e instanceof Int16Array?W:e instanceof Uint16Array?x:e instanceof Int32Array?v:e instanceof Uint32Array?A:e instanceof Float32Array?U:D}var X=e=>{if(B(e)){let o=$(e),a=h[o];return(n,y,s)=>{let u=0;return u+=h[A](n,y,s),u+=a(n,y+u,e[s]),u}}let t=Object.keys(e),r=t.map(o=>{let a=e[o];if(!B(a))throw new Error(`Invalid array type for property ${o}`);return $(a)}).map(o=>h[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0;y+=h[A](o,a+y,n);for(let s=0;s<t.length;s++){let u=e[t[s]][O],p=e[t[s]][n];if(u===void 0){y+=r[s](o,a+y,p);continue}let m=Array.isArray(p);if(y+=h[C](o,a+y,m?1:0),!m)continue;let c=p,d=c.length;y+=h[A](o,a+y,d);for(let I=0;I<d;I++)y+=h[u](o,a+y,c[I])}return y}},Y=e=>{if(B(e)){let o=$(e),a=S[o];return(n,y,s)=>{let u=0,{value:p,size:m}=S[A](n,y);u+=m;let c=s?s.get(p)??p:p,{value:d,size:I}=a(n,y+u);return e[c]=d,u+I}}let t=Object.keys(e),r=t.map(o=>{let a=e[o];if(!B(a))throw new Error(`Invalid array type for property ${o}`);return $(a)}).map(o=>S[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,n)=>{let y=0,{value:s,size:u}=S[A](o,a+y);y+=u;let p=n?n.get(s)??s:s;for(let m=0;m<t.length;m++){let c=e[t[m]][O];if(c===void 0){let{value:T,size:z}=r[m](o,a+y);e[t[m]][p]=T,y+=z;continue}let d=S[C](o,a+y);if(y+=d.size,!d.value)continue;let I=S[A](o,a+y);y+=I.size;let f=new Array(I.value);for(let T=0;T<f.length;T++){let{value:z,size:q}=S[c](o,a+y);y+=q,f[T]=z}e[t[m]][p]=f}return y}},k=(e,t=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(t),r=e.map(X);return o=>{let a=0;for(let n=0;n<o.length;n++){let y=o[n];for(let s=0;s<r.length;s++)a+=r[s](i,a,y)}return t.slice(0,a)}},P=e=>{let t=e.map(Y);return(i,r)=>{let o=new DataView(i),a=0;for(;a<i.byteLength;)for(let n=0;n<t.length;n++)a+=t[n](o,a,r)}};function Z(e,t,i,r){if(!e)return r;if(Array.isArray(e)){let o=e[t];return o!==void 0?(i.setFloat64(r,o),r+8):r}if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a],y=n[t];y!==void 0&&(n instanceof Int8Array||g in n?(i.setInt8(r,y),r+=1):n instanceof Uint8Array||C in n?(i.setUint8(r,y),r+=1):n instanceof Int16Array||W in n?(i.setInt16(r,y),r+=2):n instanceof Uint16Array||x in n?(i.setUint16(r,y),r+=2):n instanceof Int32Array||v in n?(i.setInt32(r,y),r+=4):n instanceof Uint32Array||A in n?(i.setUint32(r,y),r+=4):n instanceof Float32Array||U in n?(i.setFloat32(r,y),r+=4):(i.setFloat64(r,y),r+=8))}}return r}function _(e,t,i,r){if(!e)return r;if(Array.isArray(e))return e[t]=i.getFloat64(r),r+8;if(typeof e=="object"){let o=Object.keys(e).sort();for(let a of o){let n=e[a];n instanceof Int8Array||g in n?(n[t]=i.getInt8(r),r+=1):n instanceof Uint8Array||C in n?(n[t]=i.getUint8(r),r+=1):n instanceof Int16Array||W in n?(n[t]=i.getInt16(r),r+=2):n instanceof Uint16Array||x in n?(n[t]=i.getUint16(r),r+=2):n instanceof Int32Array||v in n?(n[t]=i.getInt32(r),r+=4):n instanceof Uint32Array||A in n?(n[t]=i.getUint32(r),r+=4):n instanceof Float32Array||U in n?(n[t]=i.getFloat32(r),r+=4):(n[t]=i.getFloat64(r),r+=8)}}return r}var Q=(e,t,i,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),a=0,n=[],y=new Map;return(0,l.observe)(e,(0,l.onAdd)(t),s=>{n.push([s,0,-1])}),(0,l.observe)(e,(0,l.onRemove)(t),s=>{n.push([s,1,-1]),y.delete(s)}),i.forEach((s,u)=>{(0,l.isRelation)(s)?((0,l.observe)(e,(0,l.onAdd)(t,s(l.Wildcard)),p=>{let m=(0,l.getRelationTargets)(e,p,s);for(let c of m){y.has(p)||y.set(p,new Map),y.get(p).set(u,c);let d=s(c);n.push([p,4,u,c,d])}}),(0,l.observe)(e,(0,l.onRemove)(t,s(l.Wildcard)),p=>{let m=y.get(p);if(m){let c=m.get(u);c!==void 0&&(n.push([p,5,u,c]),m.delete(u),m.size===0&&y.delete(p))}})):((0,l.observe)(e,(0,l.onAdd)(t,s),p=>{n.push([p,2,u])}),(0,l.observe)(e,(0,l.onRemove)(t,s),p=>{n.push([p,3,u])}))}),()=>{a=0;for(let s=0;s<n.length;s++){let[u,p,m,c,d]=n[s];o.setUint32(a,u),a+=4,o.setUint8(a,p),a+=1,(p===2||p===3||p===4||p===5)&&(o.setUint8(a,m),a+=1,(p===4||p===5)&&(o.setUint32(a,c),a+=4,p===4&&d&&(a=Z(d,u,o,a))))}return n.length=0,r.slice(0,a)}},V=(e,t,i,r)=>{let o=r||new Map;return(a,n)=>{let y=n||o,s=new DataView(a),u=0;for(;u<a.byteLength;){let p=s.getUint32(u);u+=4;let m=s.getUint8(u);u+=1;let c=-1,d=-1;(m===2||m===3||m===4||m===5)&&(c=s.getUint8(u),u+=1,(m===4||m===5)&&(d=s.getUint32(u),u+=4));let I=i[c],f=y.get(p);if(m===0)f===void 0?(f=(0,l.addEntity)(e),y.set(p,f),(0,l.addComponent)(e,f,t)):console.warn(`Attempted to deserialize addEntity with ID ${p}, but it has already been deserialzied and exists in the mapping.`);else if(f!==void 0&&(0,l.entityExists)(e,f)){if(m===1)(0,l.removeEntity)(e,f),y.delete(p);else if(m===2)(0,l.addComponent)(e,f,I);else if(m===3)(0,l.removeComponent)(e,f,I);else if(m===4){let T=y.get(d);if(T!==void 0){let z=I(T);(0,l.addComponent)(e,f,z),u=_(z,f,s,u)}}else if(m===5){let T=y.get(d);T!==void 0&&(0,l.removeComponent)(e,f,I(T))}}}return y}};function ee(e,t){let i=new WeakSet,r,o;return(a,n)=>{i.has(a)||(i.add(a),r=Q(a,e[0],e),o=k(e));let y=r(),s=o(n),u=new ArrayBuffer(y.byteLength+s.byteLength),p=new Uint8Array(u);return p.set(new Uint8Array(y),0),p.set(new Uint8Array(s),y.byteLength),u}}function te(e){let t=new WeakSet,i,r;return(o,a,n)=>{t.has(o)||(t.add(o),i=V(o,e[0],e),r=P(e));let y=i(a,n),s=a.slice(y);return r(s,n)}}var E=(r=>(r[r.REPLACE=0]="REPLACE",r[r.APPEND=1]="APPEND",r[r.MAP=2]="MAP",r))(E||{});var M=Symbol("$modifier");function F(e,t){let i=()=>[e,t];return i[M]=!0,i}var re=e=>F(e,"not"),ne=e=>F(e,"or"),ie=e=>F(e,"changed");function oe(e){let t=i=>(0,b.query)(i,e);return t.components=e,t}function ae(e){let t=[],i=new WeakSet;return r=>{i.has(r)||((0,b.observe)(r,(0,b.onAdd)(...e.components),a=>t.push(a)),i.add(r));let o=t.slice();return t.length=0,o}}function ye(e){let t=[],i=new WeakSet;return r=>{i.has(r)||((0,b.observe)(r,(0,b.onRemove)(...e.components),a=>t.push(a)),i.add(r));let o=t.slice();return t.length=0,o}}var se=(e,t,i)=>(0,b.addComponent)(e,i,t),pe=(e,t,i)=>(0,b.hasComponent)(e,i,t),ue=(e,t,i)=>(0,b.removeComponent)(e,i,t),le={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},j={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},me=(e,t=1e5)=>{let i=(r,o)=>{let a={};for(let n in r)if(Array.isArray(r[n])){let[y,s]=r[n];a[n]=Array.from({length:s},()=>new j[y](o))}else if(typeof r[n]=="object")a[n]=i(r[n],o);else{let y=r[n],s=j[y];if(s)a[n]=new s(o);else throw new Error(`Unsupported type: ${r[n]}`)}return a};return i(e,t)};
//# sourceMappingURL=index.min.cjs.map
