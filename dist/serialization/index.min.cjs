var G=Object.defineProperty;var ve=Object.getOwnPropertyDescriptor;var Ie=Object.getOwnPropertyNames;var ge=Object.prototype.hasOwnProperty;var Re=(t,e)=>{for(var n in e)G(t,n,{get:e[n],enumerable:!0})},he=(t,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Ie(e))!ge.call(t,o)&&o!==n&&G(t,o,{get:()=>e[o],enumerable:!(a=ve(e,o))||a.enumerable});return t};var We=t=>he(G({},"__esModule",{value:!0}),t);var we={};Re(we,{createObserverDeserializer:()=>_,createObserverSerializer:()=>Y,createSnapshotDeserializer:()=>Ce,createSnapshotSerializer:()=>xe,createSoADeserializer:()=>$,createSoASerializer:()=>z,f32:()=>pe,f64:()=>me,i16:()=>ae,i32:()=>ie,i8:()=>oe,u16:()=>re,u32:()=>se,u8:()=>ne});module.exports=We(we);var Q=Symbol("u8"),M=Symbol("i8"),k=Symbol("u16"),D=Symbol("i16"),I=Symbol("u32"),U=Symbol("i32"),w=Symbol("f32"),g=Symbol("f64"),x=t=>(e=[])=>Object.defineProperty(e,t,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ne=x(Q),oe=x(M),re=x(k),ae=x(D),se=x(I),ie=x(U),pe=x(w),me=x(g),ee={[Q]:(t,e,n)=>(t.setUint8(e,n),1),[M]:(t,e,n)=>(t.setInt8(e,n),1),[k]:(t,e,n)=>(t.setUint16(e,n),2),[D]:(t,e,n)=>(t.setInt16(e,n),2),[I]:(t,e,n)=>(t.setUint32(e,n),4),[U]:(t,e,n)=>(t.setInt32(e,n),4),[w]:(t,e,n)=>(t.setFloat32(e,n),4),[g]:(t,e,n)=>(t.setFloat64(e,n),8)},te={[Q]:(t,e)=>({value:t.getUint8(e),size:1}),[M]:(t,e)=>({value:t.getInt8(e),size:1}),[k]:(t,e)=>({value:t.getUint16(e),size:2}),[D]:(t,e)=>({value:t.getInt16(e),size:2}),[I]:(t,e)=>({value:t.getUint32(e),size:4}),[U]:(t,e)=>({value:t.getInt32(e),size:4}),[w]:(t,e)=>({value:t.getFloat32(e),size:4}),[g]:(t,e)=>({value:t.getFloat64(e),size:8})},Ae=t=>{let e=Object.keys(t),a=e.map(o=>{let r=t[o];for(let s of[Q,M,k,D,I,U,w,g])if(s in r)return s;return g}).map(o=>ee[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,s)=>{let i=0;i+=ee[I](o,r+i,s);for(let p=0;p<e.length;p++)i+=a[p](o,r+i,t[e[p]][s]);return i}},Se=t=>{let e=Object.keys(t),a=e.map(o=>{let r=t[o];for(let s of[Q,M,k,D,I,U,w,g])if(s in r)return s;return g}).map(o=>te[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,s)=>{let i=0,{value:p,size:m}=te[I](o,r+i);i+=m;let c=s?s.get(p)??p:p;for(let y=0;y<e.length;y++){let{value:l,size:f}=a[y](o,r+i);t[e[y]][c]=l,i+=f}return i}},z=(t,e=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(e),a=t.map(Ae);return o=>{let r=0;for(let s=0;s<o.length;s++){let i=o[s];for(let p=0;p<a.length;p++)r+=a[p](n,r,i)}return e.slice(0,r)}},$=t=>{let e=t.map(Se);return(n,a)=>{let o=new DataView(n),r=0;for(;r<n.byteLength;)for(let s=0;s<e.length;s++)r+=e[s](o,r,a)}};var A=(t,e,n)=>Object.defineProperty(t,e,{value:n,enumerable:!1,writable:!0,configurable:!0});var J=(t,e)=>{let n=t.sparse[e];return n!==void 0&&t.dense[n]===e};var d=Symbol.for("bitecs_internal");var V=()=>{let t=new Set;return{subscribe:a=>(t.add(a),()=>{t.delete(a)}),notify:(a,...o)=>Array.from(t).reduce((r,s)=>{let i=s(a,...o);return i&&typeof i=="object"?{...r,...i}:r},{})}};var et=Symbol("opType"),tt=Symbol("opTerms");function H(t,e,n){let a=t[d],{masks:o,notMasks:r,orMasks:s,generations:i}=e;for(let p=0;p<i.length;p++){let m=i[p],c=o[m],y=r[m],l=s[m],f=a.entityMasks[m][n];if(y&&f&y||c&&(f&c)!==c||l&&!(f&l))return!1}return!0}var F=(t,e)=>{t.toRemove.remove(e),t.addObservable.notify(e),t.add(e)};var N=(t,e,n)=>{let a=t[d];!e.has(n)||e.toRemove.has(n)||(e.toRemove.add(n),a.dirtyQueries.add(e),e.removeObservable.notify(n))};var u=require("../core");var Y=(t,e,n,a=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(a),r=0,s=[];return(0,u.observe)(t,(0,u.onAdd)(e),i=>{s.push([i,0,-1])}),(0,u.observe)(t,(0,u.onRemove)(e),i=>{s.push([i,1,-1])}),n.forEach((i,p)=>{(0,u.observe)(t,(0,u.onAdd)(e,i),m=>{s.push([m,2,p])}),(0,u.observe)(t,(0,u.onRemove)(e,i),m=>{s.push([m,3,p])})}),()=>{r=0;for(let i=0;i<s.length;i++){let[p,m,c]=s[i];o.setUint32(r,p),r+=4,o.setUint8(r,m),r+=1,o.setUint8(r,c),r+=1}return s.length=0,a.slice(0,r)}},_=(t,e,n)=>(a,o=new Map)=>{let r=new DataView(a),s=0;for(;s<a.byteLength;){let i=r.getUint32(s);s+=4;let p=r.getUint8(s);s+=1;let m=r.getUint8(s);s+=1;let c=n[m],y=o.get(i);y===void 0&&(y=(0,u.addEntity)(t),o.set(i,y)),p===0?(0,u.addComponent)(t,y,e):p===1?(0,u.removeEntity)(t,y):p===2?(0,u.addComponent)(t,y,c):p===3&&(0,u.removeComponent)(t,y,c)}return o};var ke=Symbol("$modifier");var O=Symbol("relation"),h=Symbol("pairTarget"),B=Symbol("isPairComponent"),v=Symbol("relationData"),fe=()=>{let t={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},e=n=>{if(n===void 0)throw Error("Relation target is undefined");let a=n==="*"?b:n;if(!t.pairsMap.has(a)){let o=t.initStore?t.initStore():{};A(o,O,e),A(o,h,a),A(o,B,!0),t.pairsMap.set(a,o)}return t.pairsMap.get(a)};return A(e,v,t),e},ce=t=>e=>{let n=e[v];return n.initStore=t,e},Ue=t=>{let e=t[v];return e.exclusiveRelation=!0,t},ue=t=>{let e=t[v];return e.autoRemoveSubject=!0,t},le=t=>e=>{let n=e[v];return n.onTargetRemoved=t,e};var R=(t,e)=>{if(t===void 0)throw Error("Relation is undefined");return t(e)},b=Z(),S=Z(),E=(t,e,n)=>{let a=q(t,e),o=[];for(let r of a)r[O]===n&&r[h]!==b&&o.push(r[h]);return o};function Z(...t){if(t.length===1&&typeof t[0]=="object"){let{store:e,exclusive:n,autoRemoveSubject:a,onTargetRemoved:o}=t[0];return[e&&ce(e),n&&Ue,a&&ue,o&&le(o)].filter(Boolean).reduce((s,i)=>i(s),fe())}else return t.reduce((n,a)=>a(n),fe())}var P={};var q=(t,e)=>{let n=t[d];if(e===void 0)throw new Error("bitECS - entity is undefined.");if(!J(n.entityIndex,e))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(e))},K=(t,e)=>J(t[d].entityIndex,e);var X=(t,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");let n=t[d],a=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:e,queries:a,setObservable:V(),getObservable:V()};return n.componentMap.set(e,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var C=(t,e,n)=>{let a=t[d],o=a.componentMap.get(n);if(!o)return!1;let{generationId:r,bitflag:s}=o;return(a.entityMasks[r][e]&s)===s},de=(t,e,n)=>{let o=t[d].componentMap.get(n);if(o&&C(t,e,n))return o.getObservable.notify(e)};var be=(t,e,n)=>{let a=t[d];T(t,e,S(n));let o=q(t,n);for(let s of o){if(s===P)continue;T(t,e,s);let i=a.componentMap.get(s);if(i&&i.setObservable){let p=de(t,n,s);i.setObservable.notify(e,p)}}let r=E(t,n,S);for(let s of r)be(t,e,s)},T=(t,e,...n)=>{let a=t[d];if(!K(t,e))throw new Error(`Cannot add component - entity ${e} does not exist in the world.`);n.forEach(o=>{let r="component"in o?o.component:o,s="data"in o?o.data:void 0;if(a.componentMap.has(r)||X(t,r),C(t,e,r))return;let i=a.componentMap.get(r),{generationId:p,bitflag:m,queries:c}=i;if(a.entityMasks[p][e]|=m,C(t,e,P)||c.forEach(y=>{y.toRemove.remove(e),H(t,y,e)?F(y,e):N(t,y,e)}),a.entityComponents.get(e).add(r),s!==void 0&&i.setObservable.notify(e,s),r[B]){let y=r[O];T(t,e,R(y,b));let l=r[h];if(T(t,e,R(b,l)),y[v].exclusiveRelation===!0&&l!==b){let W=E(t,e,y)[0];W!=null&&W!==l&&j(t,e,y(W))}if(y===S){let W=E(t,e,S);for(let Te of W)be(t,e,Te)}}})};var j=(t,e,...n)=>{let a=t[d];if(!K(t,e))throw new Error(`Cannot remove component - entity ${e} does not exist in the world.`);n.forEach(o=>{if(!C(t,e,o))return;let r=a.componentMap.get(o),{generationId:s,bitflag:i,queries:p}=r;if(a.entityMasks[s][e]&=~i,p.forEach(m=>{m.toRemove.remove(e),H(t,m,e)?F(m,e):N(t,m,e)}),a.entityComponents.get(e).delete(o),o[B]){let m=o[h];j(t,e,R(b,m));let c=o[O];E(t,e,c).length===0&&j(t,e,R(c,b))}})};var L=require("../core"),xe=(t,e,n=new ArrayBuffer(1024*1024*100))=>{let a=new DataView(n),o=0,r=i=>{let p=i.length;a.setUint32(o,p),o+=4;for(let m=0;m<p;m++){let c=i[m],y=0;a.setUint32(o,c),o+=4;let l=o;o+=1;for(let f=0;f<e.length;f++)C(t,c,e[f])&&(a.setUint8(o,f),o+=1,y++);a.setUint8(l,y)}},s=i=>{let m=z(e,n.slice(o))(i);new Uint8Array(n).set(new Uint8Array(m),o),o+=m.byteLength};return()=>{o=0;let i=(0,L.getAllEntities)(t);return r(i),s(i),n.slice(0,o)}},Ce=(t,e)=>{let n=$(e);return a=>{let o=new DataView(a),r=0,s=new Map,i=o.getUint32(r);r+=4;for(let p=0;p<i;p++){let m=o.getUint32(r);r+=4;let c=(0,L.addEntity)(t);s.set(m,c);let y=o.getUint8(r);r+=1;for(let l=0;l<y;l++){let f=o.getUint8(r);r+=1,T(t,c,e[f])}}return n(a.slice(r),s),s}};
//# sourceMappingURL=index.min.cjs.map
