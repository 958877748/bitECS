var Y=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Me=Object.prototype.hasOwnProperty;var Ae=(e,t)=>{for(var n in t)Y(e,n,{get:t[n],enumerable:!0})},Qe=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ee(t))!Me.call(e,r)&&r!==n&&Y(e,r,{get:()=>t[r],enumerable:!(s=Se(t,r))||s.enumerable});return e};var ke=e=>Qe(Y({},"__esModule",{value:!0}),e);var je={};Ae(je,{createObserverDeserializer:()=>Te,createObserverSerializer:()=>Ce,createSnapshotDeserializer:()=>he,createSnapshotSerializer:()=>Re,createSoADeserializer:()=>L,createSoASerializer:()=>K,f32:()=>le,f64:()=>ye,i16:()=>ce,i32:()=>me,i8:()=>ie,u16:()=>pe,u32:()=>ue,u8:()=>ae});module.exports=ke(je);var w=Symbol("u8"),z=Symbol("i8"),$=Symbol("u16"),U=Symbol("i16"),T=Symbol("u32"),P=Symbol("i32"),V=Symbol("f32"),I=Symbol("f64"),R=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ae=R(w),ie=R(z),pe=R($),ce=R(U),ue=R(T),me=R(P),le=R(V),ye=R(I),oe={[w]:(e,t,n)=>(e.setUint8(t,n),1),[z]:(e,t,n)=>(e.setInt8(t,n),1),[$]:(e,t,n)=>(e.setUint16(t,n),2),[U]:(e,t,n)=>(e.setInt16(t,n),2),[T]:(e,t,n)=>(e.setUint32(t,n),4),[P]:(e,t,n)=>(e.setInt32(t,n),4),[V]:(e,t,n)=>(e.setFloat32(t,n),4),[I]:(e,t,n)=>(e.setFloat64(t,n),8)},se={[w]:(e,t)=>({value:e.getUint8(t),size:1}),[z]:(e,t)=>({value:e.getInt8(t),size:1}),[$]:(e,t)=>({value:e.getUint16(t),size:2}),[U]:(e,t)=>({value:e.getInt16(t),size:2}),[T]:(e,t)=>({value:e.getUint32(t),size:4}),[P]:(e,t)=>({value:e.getInt32(t),size:4}),[V]:(e,t)=>({value:e.getFloat32(t),size:4}),[I]:(e,t)=>({value:e.getFloat64(t),size:8})},De=e=>{let t=Object.keys(e),s=t.map(r=>{let o=e[r];for(let a of[w,z,$,U,T,P,V,I])if(a in o)return a;return I}).map(r=>oe[r]||(()=>{throw new Error("Unsupported or unannotated type")}));return(r,o,a)=>{let i=0;i+=oe[T](r,o+i,a);for(let p=0;p<t.length;p++)i+=s[p](r,o+i,e[t[p]][a]);return i}},we=e=>{let t=Object.keys(e),s=t.map(r=>{let o=e[r];for(let a of[w,z,$,U,T,P,V,I])if(a in o)return a;return I}).map(r=>se[r]||(()=>{throw new Error("Unsupported or unannotated type")}));return(r,o,a)=>{let i=0,{value:p,size:c}=se[T](r,o+i);i+=c;let l=a?a.get(p)??p:p;for(let u=0;u<t.length;u++){let{value:b,size:x}=s[u](r,o+i);e[t[u]][l]=b,i+=x}return i}},K=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),s=e.map(De);return r=>{let o=0;for(let a=0;a<r.length;a++){let i=r[a];for(let p=0;p<s.length;p++)o+=s[p](n,o,i)}return t.slice(0,o)}},L=e=>{let t=e.map(we);return(n,s)=>{let r=new DataView(n),o=0;for(;o<n.byteLength;)for(let a=0;a<t.length;a++)o+=t[a](r,o,s)}};var W=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var fe=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t};var Z=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var y=Symbol("internal");var _=e=>e[y].entityIndex.dense.slice(0);var ee=()=>{let e=[],t=[],n=a=>e[t[a]]===a;return{add:a=>{n(a)||(t[a]=e.push(a)-1)},remove:a=>{if(!n(a))return;let i=t[a],p=e.pop();p!==a&&(e[i]=p,t[p]=i)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}};var j=()=>{let e=new Set;return{subscribe:s=>(e.add(s),()=>{e.delete(s)}),notify:(s,...r)=>{e.forEach(o=>o(s,...r))}}};var te=(...e)=>({type:"add",components:e}),ne=(...e)=>({type:"remove",components:e});var G=(e,t,n)=>{let s=e[y],{type:r,components:o}=t,a=de(e,o),i=s.queriesHashMap.get(a);return i||(i=be(e,o)),i[r==="add"?"addObservable":r==="remove"?"removeObservable":"setObservable"].subscribe(n)};var de=(e,t)=>{let n=e[y],s=o=>(n.componentMap.has(o)||E(e,o),n.componentMap.get(o).id),r=o=>{if("type"in o){let a=o.components.map(s).sort((i,p)=>i-p);return`${o.type}(${a.join(",")})`}else return s(o).toString()};return t.map(r).sort().join("-")},be=(e,t)=>{let n=e[y],s=de(e,t);if(n.queriesHashMap.has(s))return n.queriesHashMap.get(s);let r=[],o=[];t.forEach(m=>{m.type==="Not"?m.components.forEach(f=>{n.componentMap.has(f)||E(e,f),o.push(f)}):(n.componentMap.has(m)||E(e,m),r.push(m))});let a=m=>n.componentMap.get(m),i=r.concat(o).map(a),p=ee(),c=ee(),l=i.map(m=>m.generationId).reduce((m,f)=>(m.includes(f)||m.push(f),m),[]),u=(m,f)=>(m[f.generationId]||(m[f.generationId]=0),m[f.generationId]|=f.bitflag,m),b=r.map(a).reduce(u,{}),x=o.map(a).reduce(u,{}),Ie=i.reduce(u,{}),We=j(),Oe=j(),C=Object.assign(p,{components:r,notComponents:o,allComponents:i,masks:b,notMasks:x,hasMasks:Ie,generations:l,toRemove:c,addObservable:We,removeObservable:Oe});n.queries.add(C),n.queriesHashMap.set(s,C),i.forEach(m=>{m.queries.add(C)}),o.length&&n.notQueries.add(C);let re=n.entityIndex;for(let m=0;m<re.aliveCount;m++){let f=re.dense[m];if(h(e,Q,f))continue;M(e,C,f)&&A(C,f)}return C};var M=(e,t,n)=>{let s=e[y],{masks:r,notMasks:o,generations:a}=t;for(let i=0;i<a.length;i++){let p=a[i],c=r[p],l=o[p],u=s.entityMasks[p][n];if(l&&u&l||c&&(u&c)!==c)return!1}return!0};var A=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var J=(e,t,n)=>{let s=e[y];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),s.dirtyQueries.add(t),t.removeObservable.notify(n))};var k=Symbol("relation"),O=Symbol("pairTarget"),q=Symbol("isPairComponent"),v=Symbol("internal"),xe=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let s=n==="*"?g:n;if(!e.pairsMap.has(s)){let r={};W(r,k,t),W(r,O,s),W(r,q,!0),e.pairsMap.set(s,r)}return e.pairsMap.get(s)};return W(t,v,e),t},ze=e=>t=>{let n=t[v];return n.initStore=e,s=>{if(s===void 0)throw Error("Relation target is undefined");let r=s==="*"?g:s;if(!n.pairsMap.has(r)){let o=e();W(o,v,{pairTarget:r,...n}),n.pairsMap.set(r,o)}return n.pairsMap.get(r)}},$e=e=>{let t=e[v];return t.exclusiveRelation=!0,e},Ue=e=>{let t=e[v];return t.autoRemoveSubject=!0,e},Pe=e=>t=>{let n=t[v];return n.onTargetRemoved=e,t};var D=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},g=ge(),B=ge(),H=(e,t,n)=>{let s=N(e,n),r=[];for(let o of s)o[k]===t&&o[O]!==g&&r.push(o[O]);return r};function ge(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:s,onTargetRemoved:r}=e[0];return[t&&ze(t),n&&$e,s&&Ue,r&&Pe(r)].filter(Boolean).reduce((a,i)=>i(a),xe())}else return e.reduce((n,s)=>s(n),xe())}var E=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[y],s=new Set,r={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:s,setObservable:j()};return n.componentMap.set(t,r),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),r};var h=(e,t,n)=>{let s=e[y],r=s.componentMap.get(t);if(!r)return!1;let{generationId:o,bitflag:a}=r;return(s.entityMasks[o][n]&a)===a},ve=(e,t,n)=>{d(e,B(n),t);let s=N(e,n);for(let o of s){if(o===Q)continue;d(e,o,t);let a=Object.keys(o);for(let i of a)o[i][t]=o[i][n]}let r=H(e,B,n);for(let o of r)ve(e,t,o)},d=(e,t,n)=>{let s=e[y];if(!X(e,n))throw new Error("bitECS - entity does not exist in the world.");if(s.componentMap.has(t)||E(e,t),h(e,t,n))return;let r=s.componentMap.get(t),{generationId:o,bitflag:a,queries:i}=r;if(s.entityMasks[o][n]|=a,h(e,Q,n)||i.forEach(p=>{p.toRemove.remove(n),M(e,p,n)?A(p,n):J(e,p,n)}),s.entityComponents.get(n).add(t),t[q]){let p=t[k];d(e,D(p,g),n);let c=t[O];if(d(e,D(g,c),n),p[v].exclusiveRelation===!0&&c!==g){let u=H(e,p,n)[0];u!=null&&u!==c&&S(e,p(u),n)}if(p===B){let u=H(e,B,n);for(let b of u)ve(e,n,b)}}};var S=(e,t,n)=>{let s=e[y];if(!X(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!h(e,t,n))return;let r=s.componentMap.get(t),{generationId:o,bitflag:a,queries:i}=r;if(s.entityMasks[o][n]&=~a,i.forEach(p=>{p.toRemove.remove(n),M(e,p,n)?A(p,n):J(e,p,n)}),s.entityComponents.get(n).delete(t),t[q]){let p=t[O];S(e,D(g,p),n);let c=t[k];H(e,c,n).length===0&&S(e,D(c,g),n)}};var Q={};var F=e=>{let t=e[y],n=fe(t.entityIndex);return t.notQueries.forEach(s=>{M(e,s,n)&&A(s,n)}),t.entityComponents.set(n,new Set),n};var N=(e,t)=>{let n=e[y];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!Z(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},X=(e,t)=>Z(e[y].entityIndex,t);var Re=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let s=new DataView(n),r=0,o=i=>{let p=i.length;s.setUint32(r,p),r+=4;for(let c=0;c<p;c++){let l=i[c],u=0;s.setUint32(r,l),r+=4;let b=r;r+=1;for(let x=0;x<t.length;x++)h(e,t[x],l)&&(s.setUint8(r,x),r+=1,u++);s.setUint8(b,u)}},a=i=>{let c=K(t,n.slice(r))(i);new Uint8Array(n).set(new Uint8Array(c),r),r+=c.byteLength};return()=>{r=0;let i=_(e);return o(i),a(i),n.slice(0,r)}},he=(e,t)=>{let n=L(t);return s=>{let r=new DataView(s),o=0,a=new Map,i=r.getUint32(o);o+=4;for(let p=0;p<i;p++){let c=r.getUint32(o);o+=4;let l=F(e);a.set(c,l);let u=r.getUint8(o);o+=1;for(let b=0;b<u;b++){let x=r.getUint8(o);o+=1,d(e,t[x],l)}}return n(s.slice(o),a),a}};var Ce=(e,t,n,s=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(s),o=0,a=[];return n.forEach((i,p)=>{G(e,te(t,i),c=>{a.push([c,0,p])}),G(e,ne(t,i),c=>{a.push([c,1,p])})}),()=>{o=0;for(let i=0;i<a.length;i++){let[p,c,l]=a[i];r.setUint32(o,p),o+=4,r.setUint8(o,c),o+=1,r.setUint8(o,l),o+=1}return a.length=0,s.slice(0,o)}},Te=(e,t,n)=>(s,r=new Map)=>{let o=new DataView(s),a=0;for(;a<s.byteLength;){let i=o.getUint32(a);a+=4;let p=o.getUint8(a);a+=1;let c=o.getUint8(a);a+=1;let l=n[c],u=r.get(i);u===void 0&&(u=F(e),r.set(i,u)),p===0?(d(e,l,u),d(e,t,u)):p===1&&S(e,l,u)}return r};
//# sourceMappingURL=index.min.cjs.map
