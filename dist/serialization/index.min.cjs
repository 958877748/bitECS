var ie=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var Fe=Object.getOwnPropertyNames;var Ke=Object.prototype.hasOwnProperty;var Ge=(e,t)=>{for(var n in t)ie(e,n,{get:t[n],enumerable:!0})},Le=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Fe(t))!Ke.call(e,o)&&o!==n&&ie(e,o,{get:()=>t[o],enumerable:!(s=Ne(t,o))||s.enumerable});return e};var _e=e=>Le(ie({},"__esModule",{value:!0}),e);var tt={};Ge(tt,{createObserverDeserializer:()=>Ve,createObserverSerializer:()=>ze,createSnapshotDeserializer:()=>Ue,createSnapshotSerializer:()=>we,createSoADeserializer:()=>Z,createSoASerializer:()=>Y,f32:()=>Te,f64:()=>Ie,i16:()=>Re,i32:()=>Ce,i8:()=>ve,u16:()=>xe,u32:()=>ge,u8:()=>be});module.exports=_e(tt);var B=Symbol("u8"),N=Symbol("i8"),F=Symbol("u16"),K=Symbol("i16"),W=Symbol("u32"),G=Symbol("i32"),L=Symbol("f32"),A=Symbol("f64"),I=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),be=I(B),ve=I(N),xe=I(F),Re=I(K),ge=I(W),Ce=I(G),Te=I(L),Ie=I(A),fe={[B]:(e,t,n)=>(e.setUint8(t,n),1),[N]:(e,t,n)=>(e.setInt8(t,n),1),[F]:(e,t,n)=>(e.setUint16(t,n),2),[K]:(e,t,n)=>(e.setInt16(t,n),2),[W]:(e,t,n)=>(e.setUint32(t,n),4),[G]:(e,t,n)=>(e.setInt32(t,n),4),[L]:(e,t,n)=>(e.setFloat32(t,n),4),[A]:(e,t,n)=>(e.setFloat64(t,n),8)},de={[B]:(e,t)=>({value:e.getUint8(t),size:1}),[N]:(e,t)=>({value:e.getInt8(t),size:1}),[F]:(e,t)=>({value:e.getUint16(t),size:2}),[K]:(e,t)=>({value:e.getInt16(t),size:2}),[W]:(e,t)=>({value:e.getUint32(t),size:4}),[G]:(e,t)=>({value:e.getInt32(t),size:4}),[L]:(e,t)=>({value:e.getFloat32(t),size:4}),[A]:(e,t)=>({value:e.getFloat64(t),size:8})},Je=e=>{let t=Object.keys(e),s=t.map(o=>{let r=e[o];for(let i of[B,N,F,K,W,G,L,A])if(i in r)return i;return A}).map(o=>fe[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,i)=>{let a=0;a+=fe[W](o,r+a,i);for(let p=0;p<t.length;p++)a+=s[p](o,r+a,e[t[p]][i]);return a}},Xe=e=>{let t=Object.keys(e),s=t.map(o=>{let r=e[o];for(let i of[B,N,F,K,W,G,L,A])if(i in r)return i;return A}).map(o=>de[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,i)=>{let a=0,{value:p,size:m}=de[W](o,r+a);a+=m;let c=i?i.get(p)??p:p;for(let u=0;u<t.length;u++){let{value:f,size:d}=s[u](o,r+a);e[t[u]][c]=f,a+=d}return a}},Y=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),s=e.map(Je);return o=>{let r=0;for(let i=0;i<o.length;i++){let a=o[i];for(let p=0;p<s.length;p++)r+=s[p](n,r,a)}return t.slice(0,r)}},Z=e=>{let t=e.map(Xe);return(n,s)=>{let o=new DataView(n),r=0;for(;r<n.byteLength;)for(let i=0;i<t.length;i++)r+=t[i](o,r,s)}};var pe=()=>{let e=[],t=[],n=i=>e[t[i]]===i;return{add:i=>{n(i)||(t[i]=e.push(i)-1)},remove:i=>{if(!n(i))return;let a=t[i],p=e.pop();p!==i&&(e[a]=p,t[p]=a)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},he=(e=1e3)=>{let t=[],n=0,s=new Uint32Array(e),o=p=>p<t.length&&t[p]<n&&s[t[p]]===p;return{add:p=>{if(!o(p)){if(n>=s.length){let m=new Uint32Array(s.length*2);m.set(s),s=m}s[n]=p,t[p]=n,n++}},remove:p=>{if(!o(p))return;n--;let m=t[p],c=s[n];s[m]=c,t[c]=m},has:o,sparse:t,get dense(){return new Uint32Array(s.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var k=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var Ee=(e,t)=>t&e.entityMask,Oe=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,Ye=(e,t)=>{let s=Oe(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|s<<e.versionShift};var Se=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount],s=n;return e.sparse[s]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},We=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let s=e.aliveCount-1,o=e.dense[s];if(e.sparse[o]=n,e.dense[n]=o,e.sparse[t]=s,e.dense[s]=t,e.versioning){let r=Ye(e,t);e.dense[s]=r}e.aliveCount--},ee=(e,t)=>{let n=Ee(e,t),s=e.sparse[n];return s!==void 0&&s<e.aliveCount&&e.dense[s]===t};var y=Symbol.for("bitecs_internal");var $=()=>{let e=new Set;return{subscribe:s=>(e.add(s),()=>{e.delete(s)}),notify:(s,...o)=>Array.from(e).reduce((r,i)=>{let a=i(s,...o);return a&&typeof a=="object"?{...r,...a}:r},{})}};var h=Symbol("opType"),w=Symbol("opTerms"),ne=(...e)=>({[h]:"add",[w]:e}),oe=(...e)=>({[h]:"remove",[w]:e});function U(e,t,n){let s=e[y],{[h]:o,[w]:r}=t;if(o==="add"||o==="remove"){let i=me(e,r),a=s.queriesHashMap.get(i);return a||(a=te(e,r)),a[o==="add"?"addObservable":"removeObservable"].subscribe(n)}else if(o==="set"||o==="get"){if(r.length!==1)throw new Error("Set and Get hooks can only observe a single component");let i=r[0],a=s.componentMap.get(i);return a||(a=M(e,i)),a[o==="set"?"setObservable":"getObservable"].subscribe(n)}throw new Error(`Invalid hook type: ${o}`)}var me=(e,t)=>{let n=e[y],s=r=>(n.componentMap.has(r)||M(e,r),n.componentMap.get(r).id),o=r=>{if(h in r){let a=r[w].map(s).sort((m,c)=>m-c);return`${r[h].toLowerCase()}(${a.join(",")})`}else return s(r).toString()};return t.map(o).sort().join("-")},te=(e,t,n={})=>{let s=e[y],o=me(e,t),r=[],i=[],a=[],p=(l,b)=>{l.forEach(X=>{s.componentMap.has(X)||M(e,X),b.push(X)})};t.forEach(l=>{h in l?l[h]==="Not"?p(l[w],i):l[h]==="Or"&&p(l[w],a):(s.componentMap.has(l)||M(e,l),r.push(l))});let m=l=>s.componentMap.get(l),c=r.concat(i.flat()).concat(a.flat()).map(m),u=n.buffered?he():pe(),f=pe(),d=c.map(l=>l.generationId).reduce((l,b)=>(l.includes(b)||l.push(b),l),[]),x=(l,b)=>(l[b.generationId]||(l[b.generationId]=0),l[b.generationId]|=b.bitflag,l),ae=r.map(m).reduce(x,{}),je=i.map(m).reduce(x,{}),Pe=a.map(m).reduce(x,{}),qe=c.reduce(x,{}),He=$(),Be=$(),S=Object.assign(u,{components:r,notComponents:i,orComponents:a,allComponents:c,masks:ae,notMasks:je,orMasks:Pe,hasMasks:qe,generations:d,toRemove:f,addObservable:He,removeObservable:Be,queues:{}});s.queries.add(S),s.queriesHashMap.set(o,S),c.forEach(l=>{l.queries.add(S)}),i.length&&s.notQueries.add(S);let ye=s.entityIndex;for(let l=0;l<ye.aliveCount;l++){let b=ye.dense[l];if(g(e,b,j))continue;z(e,S,b)&&V(S,b)}return S};function ce(e,t,n={}){let s=e[y],o=me(e,t),r=s.queriesHashMap.get(o);return r?n.buffered&&!("buffer"in r.dense)&&(r=te(e,t,{buffered:!0})):r=te(e,t,n),r.dense}function z(e,t,n){let s=e[y],{masks:o,notMasks:r,orMasks:i,generations:a}=t;for(let p=0;p<a.length;p++){let m=a[p],c=o[m],u=r[m],f=i[m],d=s.entityMasks[m][n];if(u&&d&u||c&&(d&c)!==c||f&&!(d&f))return!1}return!0}var V=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var _=(e,t,n)=>{let s=e[y];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),s.dirtyQueries.add(t),t.removeObservable.notify(n))};var Q=Symbol("relation"),O=Symbol("pairTarget"),H=Symbol("isPairComponent"),T=Symbol("relationData"),ke=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let s=n==="*"?v:n;if(!e.pairsMap.has(s)){let o=e.initStore?e.initStore():{};k(o,Q,t),k(o,O,s),k(o,H,!0),e.pairsMap.set(s,o)}return e.pairsMap.get(s)};return k(t,T,e),t},Ae=e=>t=>{let n=t[T];return n.initStore=e,t},et=e=>{let t=e[T];return t.exclusiveRelation=!0,e},Me=e=>{let t=e[T];return t.autoRemoveSubject=!0,e},De=e=>t=>{let n=t[T];return n.onTargetRemoved=e,t};var E=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},v=ue(),P=ue(),q=(e,t,n)=>{let s=J(e,t),o=[];for(let r of s)r[Q]===n&&r[O]!==v&&o.push(r[O]);return o};function ue(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:s,onTargetRemoved:o}=e[0];return[t&&Ae(t),n&&et,s&&Me,o&&De(o)].filter(Boolean).reduce((i,a)=>a(i),ke())}else return e.reduce((n,s)=>s(n),ke())}var j={};var le=e=>{let t=e[y],n=Se(t.entityIndex);return t.notQueries.forEach(s=>{z(e,s,n)&&V(s,n)}),t.entityComponents.set(n,new Set),n},re=(e,t)=>{let n=e[y];if(!ee(n.entityIndex,t))return;let s=[t],o=new Set;for(;s.length>0;){let r=s.shift();if(o.has(r))continue;o.add(r);let i=[];for(let a of ce(e,[v(r)]))if(D(e,a))for(let p of n.entityComponents.get(a)){if(!p[H])continue;let c=p[Q][T];i.push(()=>C(e,a,E(v,r))),p[O]===r&&(i.push(()=>C(e,a,p)),c.autoRemoveSubject&&s.push(a),c.onTargetRemoved&&i.push(()=>c.onTargetRemoved(e,a,r)))}for(let a of i)a();for(let a of s)re(e,a);for(let a of n.queries)_(e,a,r);We(n.entityIndex,r),n.entityComponents.delete(r);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][r]=0}},J=(e,t)=>{let n=e[y];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!ee(n.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(n.entityComponents.get(t))},D=(e,t)=>ee(e[y].entityIndex,t);var M=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[y],s=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:s,setObservable:$(),getObservable:$()};return n.componentMap.set(t,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var g=(e,t,n)=>{let s=e[y],o=s.componentMap.get(n);if(!o)return!1;let{generationId:r,bitflag:i}=o;return(s.entityMasks[r][t]&i)===i},Qe=(e,t,n)=>{let o=e[y].componentMap.get(n);if(o&&g(e,t,n))return o.getObservable.notify(t)};var $e=(e,t,n,s=!0)=>{let o=e[y];R(e,t,P(n));for(let r of J(e,n))if(r!==j&&(R(e,t,r),s)){let i=o.componentMap.get(r);if(i?.setObservable){let a=Qe(e,n,r);i.setObservable.notify(t,a)}}for(let r of q(e,n,P))$e(e,t,r,!1)},R=(e,t,...n)=>{let s=e[y];if(!D(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);n.forEach(o=>{let r="component"in o?o.component:o,i="data"in o?o.data:void 0;s.componentMap.has(r)||M(e,r);let a=s.componentMap.get(r);if(i!==void 0&&a.setObservable.notify(t,i),g(e,t,r))return;let{generationId:p,bitflag:m,queries:c}=a;if(s.entityMasks[p][t]|=m,g(e,t,j)||c.forEach(u=>{u.toRemove.remove(t),z(e,u,t)?V(u,t):_(e,u,t)}),s.entityComponents.get(t).add(r),r[H]){let u=r[Q];R(e,t,E(u,v));let f=r[O];if(R(e,t,E(v,f)),u[T].exclusiveRelation===!0&&f!==v){let x=q(e,t,u)[0];x!=null&&x!==f&&C(e,t,u(x))}if(u===P){let x=q(e,t,P);for(let ae of x)$e(e,t,ae)}}})};var C=(e,t,...n)=>{let s=e[y];if(!D(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(o=>{if(!g(e,t,o))return;let r=s.componentMap.get(o),{generationId:i,bitflag:a,queries:p}=r;if(s.entityMasks[i][t]&=~a,p.forEach(m=>{m.toRemove.remove(t),z(e,m,t)?V(m,t):_(e,m,t)}),s.entityComponents.get(t).delete(o),o[H]){let m=o[O];C(e,t,E(v,m));let c=o[Q];q(e,t,c).length===0&&C(e,t,E(c,v))}})};var se=require("../core"),we=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let s=new DataView(n),o=0,r=a=>{let p=a.length;s.setUint32(o,p),o+=4;for(let m=0;m<p;m++){let c=a[m],u=0;s.setUint32(o,c),o+=4;let f=o;o+=1;for(let d=0;d<t.length;d++)g(e,c,t[d])&&(s.setUint8(o,d),o+=1,u++);s.setUint8(f,u)}},i=a=>{let m=Y(t,n.slice(o))(a);new Uint8Array(n).set(new Uint8Array(m),o),o+=m.byteLength};return()=>{o=0;let a=(0,se.getAllEntities)(e);return r(a),i(a),n.slice(0,o)}},Ue=(e,t)=>{let n=Z(t);return s=>{let o=new DataView(s),r=0,i=new Map,a=o.getUint32(r);r+=4;for(let p=0;p<a;p++){let m=o.getUint32(r);r+=4;let c=(0,se.addEntity)(e);i.set(m,c);let u=o.getUint8(r);r+=1;for(let f=0;f<u;f++){let d=o.getUint8(r);r+=1,R(e,c,t[d])}}return n(s.slice(r),i),i}};var ze=(e,t,n,s=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(s),r=0,i=[];return U(e,ne(t),a=>{i.push([a,0,-1])}),U(e,oe(t),a=>{i.push([a,1,-1])}),n.forEach((a,p)=>{U(e,ne(t,a),m=>{i.push([m,2,p])}),U(e,oe(t,a),m=>{i.push([m,3,p])})}),()=>{r=0;for(let a=0;a<i.length;a++){let[p,m,c]=i[a];o.setUint32(r,p),r+=4,o.setUint8(r,m),r+=1,(m===2||m===3)&&(o.setUint8(r,c),r+=1)}return i.length=0,s.slice(0,r)}},Ve=(e,t,n,s=new Map)=>o=>{let r=new DataView(o),i=0;for(;i<o.byteLength;){let a=r.getUint32(i);i+=4;let p=r.getUint8(i);i+=1;let m=-1;(p===2||p===3)&&(m=r.getUint8(i),i+=1);let c=n[m],u=s.get(a);if(p===0)if(u===void 0)u=le(e),s.set(a,u),R(e,u,t);else throw new Error(`Entity with ID ${a} already exists in the mapping.`);else u!==void 0&&D(e,u)&&(p===1?re(e,u):p===2?R(e,u,c):p===3&&C(e,u,c))}return s};
//# sourceMappingURL=index.min.cjs.map
