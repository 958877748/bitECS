var z=Symbol("u8"),j=Symbol("i8"),P=Symbol("u16"),V=Symbol("i16"),h=Symbol("u32"),q=Symbol("i32"),B=Symbol("f32"),W=Symbol("f64"),v=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),Ie=v(z),Se=v(j),Oe=v(P),Ae=v(V),Ee=v(h),Me=v(q),Qe=v(B),ke=v(W),pe={[z]:(e,t,n)=>(e.setUint8(t,n),1),[j]:(e,t,n)=>(e.setInt8(t,n),1),[P]:(e,t,n)=>(e.setUint16(t,n),2),[V]:(e,t,n)=>(e.setInt16(t,n),2),[h]:(e,t,n)=>(e.setUint32(t,n),4),[q]:(e,t,n)=>(e.setInt32(t,n),4),[B]:(e,t,n)=>(e.setFloat32(t,n),4),[W]:(e,t,n)=>(e.setFloat64(t,n),8)},ce={[z]:(e,t)=>({value:e.getUint8(t),size:1}),[j]:(e,t)=>({value:e.getInt8(t),size:1}),[P]:(e,t)=>({value:e.getUint16(t),size:2}),[V]:(e,t)=>({value:e.getInt16(t),size:2}),[h]:(e,t)=>({value:e.getUint32(t),size:4}),[q]:(e,t)=>({value:e.getInt32(t),size:4}),[B]:(e,t)=>({value:e.getFloat32(t),size:4}),[W]:(e,t)=>({value:e.getFloat64(t),size:8})},we=e=>{let t=Object.keys(e),r=t.map(o=>{let a=e[o];for(let s of[z,j,P,V,h,q,B,W])if(s in a)return s;return W}).map(o=>pe[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,s)=>{let p=0;p+=pe[h](o,a+p,s);for(let i=0;i<t.length;i++)p+=r[i](o,a+p,e[t[i]][s]);return p}},De=e=>{let t=Object.keys(e),r=t.map(o=>{let a=e[o];for(let s of[z,j,P,V,h,q,B,W])if(s in a)return s;return W}).map(o=>ce[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,s)=>{let p=0,{value:i,size:c}=ce[h](o,a+p);p+=c;let m=s?s.get(i)??i:i;for(let l=0;l<t.length;l++){let{value:y,size:d}=r[l](o,a+p);e[t[l]][m]=y,p+=d}return p}},_=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),r=e.map(we);return o=>{let a=0;for(let s=0;s<o.length;s++){let p=o[s];for(let i=0;i<r.length;i++)a+=r[i](n,a,p)}return t.slice(0,a)}},ee=e=>{let t=e.map(De);return(n,r)=>{let o=new DataView(n),a=0;for(;a<n.byteLength;)for(let s=0;s<t.length;s++)a+=t[s](o,a,r)}};var I=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var ue=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t};var te=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var f=Symbol("internal");var ne=e=>e[f].entityIndex.dense.slice(0);var oe=()=>{let e=[],t=[],n=s=>e[t[s]]===s;return{add:s=>{n(s)||(t[s]=e.push(s)-1)},remove:s=>{if(!n(s))return;let p=t[s],i=e.pop();i!==s&&(e[p]=i,t[i]=p)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},me=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(e),o=i=>i<t.length&&t[i]<n&&r[t[i]]===i;return{add:i=>{if(!o(i)){if(n>=r.length){let c=new Uint32Array(r.length*2);c.set(r),r=c}r[n]=i,t[i]=n,n++}},remove:i=>{if(!o(i))return;n--;let c=t[i],m=r[n];r[c]=m,t[m]=c},has:o,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var H=()=>{let e=new Set;return{subscribe:r=>(e.add(r),()=>{e.delete(r)}),notify:(r,...o)=>{e.forEach(a=>a(r,...o))}}};var E=Symbol("opType"),N=Symbol("opComponents"),re=(...e)=>({[E]:"add",[N]:e}),ae=(...e)=>({[E]:"remove",[N]:e});var X=(e,t,n)=>{let r=e[f],{[E]:o,[N]:a}=t,s=le(e,a),p=r.queriesHashMap.get(s);return p||(p=fe(e,a)),p[o==="add"?"addObservable":o==="remove"?"removeObservable":"setObservable"].subscribe(n)};var le=(e,t)=>{let n=e[f],r=a=>(n.componentMap.has(a)||M(e,a),n.componentMap.get(a).id),o=a=>{if("type"in a){let p=a.components.map(r).sort((c,m)=>c-m);return`${a.type.toLowerCase()}(${p.join(",")})`}else return r(a).toString()};return t.map(o).sort().join("-")},fe=(e,t,n={})=>{let r=e[f],o=le(e,t),a=[],s=[],p=[],i=(u,b)=>{u.forEach(J=>{r.componentMap.has(J)||M(e,J),b.push(J)})};t.forEach(u=>{E in u?u[E]==="Not"?i(u[N],s):u[E]==="Or"&&i(u[N],p):(r.componentMap.has(u)||M(e,u),a.push(u))});let c=u=>r.componentMap.get(u),m=a.concat(s).concat(p.flat()).map(c),l=n.buffered?me():oe(),y=oe(),d=m.map(u=>u.generationId).reduce((u,b)=>(u.includes(b)||u.push(b),u),[]),G=(u,b)=>(u[b.generationId]||(u[b.generationId]=0),u[b.generationId]|=b.bitflag,u),Re=a.map(c).reduce(G,{}),ve=s.map(c).reduce(G,{}),Ce=p.map(c).reduce(G,{}),Te=m.reduce(G,{}),he=H(),We=H(),T=Object.assign(l,{components:a,notComponents:s,orComponents:p,allComponents:m,masks:Re,notMasks:ve,orMasks:Ce,hasMasks:Te,generations:d,toRemove:y,addObservable:he,removeObservable:We});r.queries.add(T),r.queriesHashMap.set(o,T),m.forEach(u=>{u.queries.add(T)}),s.length&&r.notQueries.add(T);let ie=r.entityIndex;for(let u=0;u<ie.aliveCount;u++){let b=ie.dense[u];if(C(e,w,b))continue;Q(e,T,b)&&k(T,b)}return T};function Q(e,t,n){let r=e[f],{masks:o,notMasks:a,orMasks:s,generations:p}=t;for(let i=0;i<p.length;i++){let c=p[i],m=o[c],l=a[c],y=s[c],d=r.entityMasks[c][n];if(l&&d&l||m&&(d&m)!==m||y&&!(d&y))return!1}return!0}var k=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var Y=(e,t,n)=>{let r=e[f];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))};var D=Symbol("relation"),S=Symbol("pairTarget"),F=Symbol("isPairComponent"),R=Symbol("relationData"),de=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?x:n;if(!e.pairsMap.has(r)){let o={};I(o,D,t),I(o,S,r),I(o,F,!0),e.pairsMap.set(r,o)}return e.pairsMap.get(r)};return I(t,R,e),t},ye=e=>t=>{let n=t[R];return n.initStore=e,r=>{if(r===void 0)throw Error("Relation target is undefined");let o=r==="*"?x:r;if(!n.pairsMap.has(o)){let a=e();I(a,R,{pairTarget:o,...n}),n.pairsMap.set(o,a)}return n.pairsMap.get(o)}},Ue=e=>{let t=e[R];return t.exclusiveRelation=!0,e},be=e=>{let t=e[R];return t.autoRemoveSubject=!0,e},xe=e=>t=>{let n=t[R];return n.onTargetRemoved=e,t};var O=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},x=se(),$=se(),U=(e,t,n)=>{let r=K(e,n),o=[];for(let a of r)a[D]===t&&a[S]!==x&&o.push(a[S]);return o};function se(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:o}=e[0];return[t&&ye(t),n&&Ue,r&&be,o&&xe(o)].filter(Boolean).reduce((s,p)=>p(s),de())}else return e.reduce((n,r)=>r(n),de())}var M=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[f],r=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:H()};return n.componentMap.set(t,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var C=(e,t,n)=>{let r=e[f],o=r.componentMap.get(t);if(!o)return!1;let{generationId:a,bitflag:s}=o;return(r.entityMasks[a][n]&s)===s},ge=(e,t,n)=>{g(e,$(n),t);let r=K(e,n);for(let a of r){if(a===w)continue;g(e,a,t);let s=Object.keys(a);for(let p of s)a[p][t]=a[p][n]}let o=U(e,$,n);for(let a of o)ge(e,t,a)},g=(e,t,n)=>{let r=e[f];if(!Z(e,n))throw new Error("bitECS - entity does not exist in the world.");if(r.componentMap.has(t)||M(e,t),C(e,t,n))return;let o=r.componentMap.get(t),{generationId:a,bitflag:s,queries:p}=o;if(r.entityMasks[a][n]|=s,C(e,w,n)||p.forEach(i=>{i.toRemove.remove(n),Q(e,i,n)?k(i,n):Y(e,i,n)}),r.entityComponents.get(n).add(t),t[F]){let i=t[D];g(e,O(i,x),n);let c=t[S];if(g(e,O(x,c),n),i[R].exclusiveRelation===!0&&c!==x){let l=U(e,i,n)[0];l!=null&&l!==c&&A(e,i(l),n)}if(i===$){let l=U(e,$,n);for(let y of l)ge(e,n,y)}}};var A=(e,t,n)=>{let r=e[f];if(!Z(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!C(e,t,n))return;let o=r.componentMap.get(t),{generationId:a,bitflag:s,queries:p}=o;if(r.entityMasks[a][n]&=~s,p.forEach(i=>{i.toRemove.remove(n),Q(e,i,n)?k(i,n):Y(e,i,n)}),r.entityComponents.get(n).delete(t),t[F]){let i=t[S];A(e,O(x,i),n);let c=t[D];U(e,c,n).length===0&&A(e,O(c,x),n)}};var w={};var L=e=>{let t=e[f],n=ue(t.entityIndex);return t.notQueries.forEach(r=>{Q(e,r,n)&&k(r,n)}),t.entityComponents.set(n,new Set),n};var K=(e,t)=>{let n=e[f];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!te(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},Z=(e,t)=>te(e[f].entityIndex,t);var je=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(n),o=0,a=p=>{let i=p.length;r.setUint32(o,i),o+=4;for(let c=0;c<i;c++){let m=p[c],l=0;r.setUint32(o,m),o+=4;let y=o;o+=1;for(let d=0;d<t.length;d++)C(e,t[d],m)&&(r.setUint8(o,d),o+=1,l++);r.setUint8(y,l)}},s=p=>{let c=_(t,n.slice(o))(p);new Uint8Array(n).set(new Uint8Array(c),o),o+=c.byteLength};return()=>{o=0;let p=ne(e);return a(p),s(p),n.slice(0,o)}},Pe=(e,t)=>{let n=ee(t);return r=>{let o=new DataView(r),a=0,s=new Map,p=o.getUint32(a);a+=4;for(let i=0;i<p;i++){let c=o.getUint32(a);a+=4;let m=L(e);s.set(c,m);let l=o.getUint8(a);a+=1;for(let y=0;y<l;y++){let d=o.getUint8(a);a+=1,g(e,t[d],m)}}return n(r.slice(a),s),s}};var Ve=(e,t,n,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),a=0,s=[];return n.forEach((p,i)=>{X(e,re(t,p),c=>{s.push([c,0,i])}),X(e,ae(t,p),c=>{s.push([c,1,i])})}),()=>{a=0;for(let p=0;p<s.length;p++){let[i,c,m]=s[p];o.setUint32(a,i),a+=4,o.setUint8(a,c),a+=1,o.setUint8(a,m),a+=1}return s.length=0,r.slice(0,a)}},qe=(e,t,n)=>(r,o=new Map)=>{let a=new DataView(r),s=0;for(;s<r.byteLength;){let p=a.getUint32(s);s+=4;let i=a.getUint8(s);s+=1;let c=a.getUint8(s);s+=1;let m=n[c],l=o.get(p);l===void 0&&(l=L(e),o.set(p,l)),i===0?(g(e,m,l),g(e,t,l)):i===1&&A(e,m,l)}return o};export{qe as createObserverDeserializer,Ve as createObserverSerializer,Pe as createSnapshotDeserializer,je as createSnapshotSerializer,ee as createSoADeserializer,_ as createSoASerializer,Qe as f32,ke as f64,Ae as i16,Me as i32,Se as i8,Oe as u16,Ee as u32,Ie as u8};
//# sourceMappingURL=index.min.mjs.map
