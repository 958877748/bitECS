var B=Symbol("u8"),N=Symbol("i8"),F=Symbol("u16"),K=Symbol("i16"),W=Symbol("u32"),G=Symbol("i32"),L=Symbol("f32"),A=Symbol("f64"),I=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),Me=I(B),De=I(N),Qe=I(F),ke=I(K),$e=I(W),we=I(G),Ue=I(L),ze=I(A),ye={[B]:(e,t,n)=>(e.setUint8(t,n),1),[N]:(e,t,n)=>(e.setInt8(t,n),1),[F]:(e,t,n)=>(e.setUint16(t,n),2),[K]:(e,t,n)=>(e.setInt16(t,n),2),[W]:(e,t,n)=>(e.setUint32(t,n),4),[G]:(e,t,n)=>(e.setInt32(t,n),4),[L]:(e,t,n)=>(e.setFloat32(t,n),4),[A]:(e,t,n)=>(e.setFloat64(t,n),8)},fe={[B]:(e,t)=>({value:e.getUint8(t),size:1}),[N]:(e,t)=>({value:e.getInt8(t),size:1}),[F]:(e,t)=>({value:e.getUint16(t),size:2}),[K]:(e,t)=>({value:e.getInt16(t),size:2}),[W]:(e,t)=>({value:e.getUint32(t),size:4}),[G]:(e,t)=>({value:e.getInt32(t),size:4}),[L]:(e,t)=>({value:e.getFloat32(t),size:4}),[A]:(e,t)=>({value:e.getFloat64(t),size:8})},Ve=e=>{let t=Object.keys(e),r=t.map(o=>{let s=e[o];for(let a of[B,N,F,K,W,G,L,A])if(a in s)return a;return A}).map(o=>ye[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,s,a)=>{let i=0;i+=ye[W](o,s+i,a);for(let p=0;p<t.length;p++)i+=r[p](o,s+i,e[t[p]][a]);return i}},je=e=>{let t=Object.keys(e),r=t.map(o=>{let s=e[o];for(let a of[B,N,F,K,W,G,L,A])if(a in s)return a;return A}).map(o=>fe[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,s,a)=>{let i=0,{value:p,size:m}=fe[W](o,s+i);i+=m;let c=a?a.get(p)??p:p;for(let u=0;u<t.length;u++){let{value:f,size:d}=r[u](o,s+i);e[t[u]][c]=f,i+=d}return i}},se=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),r=e.map(Ve);return o=>{let s=0;for(let a=0;a<o.length;a++){let i=o[a];for(let p=0;p<r.length;p++)s+=r[p](n,s,i)}return t.slice(0,s)}},ae=e=>{let t=e.map(je);return(n,r)=>{let o=new DataView(n),s=0;for(;s<n.byteLength;)for(let a=0;a<t.length;a++)s+=t[a](o,s,r)}};var ie=()=>{let e=[],t=[],n=a=>e[t[a]]===a;return{add:a=>{n(a)||(t[a]=e.push(a)-1)},remove:a=>{if(!n(a))return;let i=t[a],p=e.pop();p!==a&&(e[i]=p,t[p]=i)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},de=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(e),o=p=>p<t.length&&t[p]<n&&r[t[p]]===p;return{add:p=>{if(!o(p)){if(n>=r.length){let m=new Uint32Array(r.length*2);m.set(r),r=m}r[n]=p,t[p]=n,n++}},remove:p=>{if(!o(p))return;n--;let m=t[p],c=r[n];r[m]=c,t[c]=m},has:o,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var k=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var _=(e,t)=>t&e.entityMask,be=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,Pe=(e,t)=>{let r=be(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|r<<e.versionShift};var ve=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount],r=_(e,n);return e.sparse[r]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},xe=(e,t)=>{let n=_(e,t),r=e.sparse[n];if(r===void 0||r>=e.aliveCount)return;let o=e.aliveCount-1,s=e.dense[o];if(e.sparse[_(e,s)]=r,e.dense[r]=s,e.sparse[n]=o,e.dense[o]=t,e.versioning){let a=Pe(e,t);e.dense[o]=a}e.aliveCount--},Z=(e,t)=>{let n=_(e,t),r=e.sparse[n];return r!==void 0&&r<e.aliveCount&&e.dense[r]===t};var y=Symbol.for("bitecs_internal");var $=()=>{let e=new Set;return{subscribe:r=>(e.add(r),()=>{e.delete(r)}),notify:(r,...o)=>Array.from(e).reduce((s,a)=>{let i=a(r,...o);return i&&typeof i=="object"?{...s,...i}:s},{})}};var h=Symbol("opType"),w=Symbol("opTerms"),te=(...e)=>({[h]:"add",[w]:e}),ne=(...e)=>({[h]:"remove",[w]:e});function U(e,t,n){let r=e[y],{[h]:o,[w]:s}=t;if(o==="add"||o==="remove"){let a=pe(e,s),i=r.queriesHashMap.get(a);return i||(i=ee(e,s)),i[o==="add"?"addObservable":"removeObservable"].subscribe(n)}else if(o==="set"||o==="get"){if(s.length!==1)throw new Error("Set and Get hooks can only observe a single component");let a=s[0],i=r.componentMap.get(a);return i||(i=M(e,a)),i[o==="set"?"setObservable":"getObservable"].subscribe(n)}throw new Error(`Invalid hook type: ${o}`)}var pe=(e,t)=>{let n=e[y],r=s=>(n.componentMap.has(s)||M(e,s),n.componentMap.get(s).id),o=s=>{if(h in s){let i=s[w].map(r).sort((m,c)=>m-c);return`${s[h].toLowerCase()}(${i.join(",")})`}else return r(s).toString()};return t.map(o).sort().join("-")},ee=(e,t,n={})=>{let r=e[y],o=pe(e,t),s=[],a=[],i=[],p=(l,b)=>{l.forEach(Y=>{r.componentMap.has(Y)||M(e,Y),b.push(Y)})};t.forEach(l=>{h in l?l[h]==="Not"?p(l[w],a):l[h]==="Or"&&p(l[w],i):(r.componentMap.has(l)||M(e,l),s.push(l))});let m=l=>r.componentMap.get(l),c=s.concat(a.flat()).concat(i.flat()).map(m),u=n.buffered?de():ie(),f=ie(),d=c.map(l=>l.generationId).reduce((l,b)=>(l.includes(b)||l.push(b),l),[]),x=(l,b)=>(l[b.generationId]||(l[b.generationId]=0),l[b.generationId]|=b.bitflag,l),re=s.map(m).reduce(x,{}),Ee=a.map(m).reduce(x,{}),Oe=i.map(m).reduce(x,{}),Se=c.reduce(x,{}),We=$(),Ae=$(),S=Object.assign(u,{components:s,notComponents:a,orComponents:i,allComponents:c,masks:re,notMasks:Ee,orMasks:Oe,hasMasks:Se,generations:d,toRemove:f,addObservable:We,removeObservable:Ae,queues:{}});r.queries.add(S),r.queriesHashMap.set(o,S),c.forEach(l=>{l.queries.add(S)}),a.length&&r.notQueries.add(S);let le=r.entityIndex;for(let l=0;l<le.aliveCount;l++){let b=le.dense[l];if(g(e,b,j))continue;z(e,S,b)&&V(S,b)}return S};function me(e,t,n={}){let r=e[y],o=pe(e,t),s=r.queriesHashMap.get(o);return s?n.buffered&&!("buffer"in s.dense)&&(s=ee(e,t,{buffered:!0})):s=ee(e,t,n),s.dense}function z(e,t,n){let r=e[y],{masks:o,notMasks:s,orMasks:a,generations:i}=t;for(let p=0;p<i.length;p++){let m=i[p],c=o[m],u=s[m],f=a[m],d=r.entityMasks[m][n];if(u&&d&u||c&&(d&c)!==c||f&&!(d&f))return!1}return!0}var V=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var J=(e,t,n)=>{let r=e[y];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))};var Q=Symbol("relation"),O=Symbol("pairTarget"),H=Symbol("isPairComponent"),T=Symbol("relationData"),Ie=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?v:n;if(!e.pairsMap.has(r)){let o=e.initStore?e.initStore():{};k(o,Q,t),k(o,O,r),k(o,H,!0),e.pairsMap.set(r,o)}return e.pairsMap.get(r)};return k(t,T,e),t},Re=e=>t=>{let n=t[T];return n.initStore=e,t},He=e=>{let t=e[T];return t.exclusiveRelation=!0,e},ge=e=>{let t=e[T];return t.autoRemoveSubject=!0,e},Ce=e=>t=>{let n=t[T];return n.onTargetRemoved=e,t};var E=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},v=ce(),P=ce(),q=(e,t,n)=>{let r=X(e,t),o=[];for(let s of r)s[Q]===n&&s[O]!==v&&o.push(s[O]);return o};function ce(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:o}=e[0];return[t&&Re(t),n&&He,r&&ge,o&&Ce(o)].filter(Boolean).reduce((a,i)=>i(a),Ie())}else return e.reduce((n,r)=>r(n),Ie())}var j={};var ue=e=>{let t=e[y],n=ve(t.entityIndex);return t.notQueries.forEach(r=>{z(e,r,n)&&V(r,n)}),t.entityComponents.set(n,new Set),n},oe=(e,t)=>{let n=e[y];if(!Z(n.entityIndex,t))return;let r=[t],o=new Set;for(;r.length>0;){let s=r.shift();if(o.has(s))continue;o.add(s);let a=[];for(let i of me(e,[v(s)]))if(D(e,i))for(let p of n.entityComponents.get(i)){if(!p[H])continue;let c=p[Q][T];a.push(()=>C(e,i,E(v,s))),p[O]===s&&(a.push(()=>C(e,i,p)),c.autoRemoveSubject&&r.push(i),c.onTargetRemoved&&a.push(()=>c.onTargetRemoved(e,i,s)))}for(let i of a)i();for(let i of r)oe(e,i);for(let i of n.queries)J(e,i,s);xe(n.entityIndex,s),n.entityComponents.delete(s);for(let i=0;i<n.entityMasks.length;i++)n.entityMasks[i][s]=0}},X=(e,t)=>{let n=e[y];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!Z(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},D=(e,t)=>Z(e[y].entityIndex,t);var M=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[y],r=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:$(),getObservable:$()};return n.componentMap.set(t,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var g=(e,t,n)=>{let r=e[y],o=r.componentMap.get(n);if(!o)return!1;let{generationId:s,bitflag:a}=o;return(r.entityMasks[s][t]&a)===a},Te=(e,t,n)=>{let o=e[y].componentMap.get(n);if(o&&g(e,t,n))return o.getObservable.notify(t)};var he=(e,t,n)=>{let r=e[y];R(e,t,P(n));let o=X(e,n);for(let a of o){if(a===j)continue;R(e,t,a);let i=r.componentMap.get(a);if(i&&i.setObservable){let p=Te(e,n,a);i.setObservable.notify(t,p)}}let s=q(e,n,P);for(let a of s)he(e,t,a)},R=(e,t,...n)=>{let r=e[y];if(!D(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);n.forEach(o=>{let s="component"in o?o.component:o,a="data"in o?o.data:void 0;if(r.componentMap.has(s)||M(e,s),g(e,t,s))return;let i=r.componentMap.get(s),{generationId:p,bitflag:m,queries:c}=i;if(r.entityMasks[p][t]|=m,g(e,t,j)||c.forEach(u=>{u.toRemove.remove(t),z(e,u,t)?V(u,t):J(e,u,t)}),r.entityComponents.get(t).add(s),a!==void 0&&i.setObservable.notify(t,a),s[H]){let u=s[Q];R(e,t,E(u,v));let f=s[O];if(R(e,t,E(v,f)),u[T].exclusiveRelation===!0&&f!==v){let x=q(e,t,u)[0];x!=null&&x!==f&&C(e,t,u(x))}if(u===P){let x=q(e,t,P);for(let re of x)he(e,t,re)}}})};var C=(e,t,...n)=>{let r=e[y];if(!D(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(o=>{if(!g(e,t,o))return;let s=r.componentMap.get(o),{generationId:a,bitflag:i,queries:p}=s;if(r.entityMasks[a][t]&=~i,p.forEach(m=>{m.toRemove.remove(t),z(e,m,t)?V(m,t):J(e,m,t)}),r.entityComponents.get(t).delete(o),o[H]){let m=o[O];C(e,t,E(v,m));let c=o[Q];q(e,t,c).length===0&&C(e,t,E(c,v))}})};import{getAllEntities as Be,addEntity as Ne}from"../core";var Fe=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(n),o=0,s=i=>{let p=i.length;r.setUint32(o,p),o+=4;for(let m=0;m<p;m++){let c=i[m],u=0;r.setUint32(o,c),o+=4;let f=o;o+=1;for(let d=0;d<t.length;d++)g(e,c,t[d])&&(r.setUint8(o,d),o+=1,u++);r.setUint8(f,u)}},a=i=>{let m=se(t,n.slice(o))(i);new Uint8Array(n).set(new Uint8Array(m),o),o+=m.byteLength};return()=>{o=0;let i=Be(e);return s(i),a(i),n.slice(0,o)}},Ke=(e,t)=>{let n=ae(t);return r=>{let o=new DataView(r),s=0,a=new Map,i=o.getUint32(s);s+=4;for(let p=0;p<i;p++){let m=o.getUint32(s);s+=4;let c=Ne(e);a.set(m,c);let u=o.getUint8(s);s+=1;for(let f=0;f<u;f++){let d=o.getUint8(s);s+=1,R(e,c,t[d])}}return n(r.slice(s),a),a}};var Ge=(e,t,n,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),s=0,a=[];return U(e,te(t),i=>{a.push([i,0,-1])}),U(e,ne(t),i=>{a.push([i,1,-1])}),n.forEach((i,p)=>{U(e,te(t,i),m=>{a.push([m,2,p])}),U(e,ne(t,i),m=>{a.push([m,3,p])})}),()=>{s=0;for(let i=0;i<a.length;i++){let[p,m,c]=a[i];o.setUint32(s,p),s+=4,o.setUint8(s,m),s+=1,(m===2||m===3)&&(o.setUint8(s,c),s+=1)}return a.length=0,r.slice(0,s)}},Le=(e,t,n,r=new Map)=>o=>{let s=new DataView(o),a=0;for(;a<o.byteLength;){let i=s.getUint32(a);a+=4;let p=s.getUint8(a);a+=1;let m=-1;(p===2||p===3)&&(m=s.getUint8(a),a+=1);let c=n[m],u=r.get(i);p===0?u===void 0?(u=ue(e),r.set(i,u),R(e,u,t)):console.error(`Entity with ID ${i} already exists in the mapping.`):u!==void 0&&D(e,u)&&(p===1?oe(e,u):p===2?R(e,u,c):p===3&&C(e,u,c))}return r};export{Le as createObserverDeserializer,Ge as createObserverSerializer,Ke as createSnapshotDeserializer,Fe as createSnapshotSerializer,ae as createSoADeserializer,se as createSoASerializer,Ue as f32,ze as f64,ke as i16,we as i32,De as i8,Qe as u16,$e as u32,Me as u8};
//# sourceMappingURL=index.min.mjs.map
