var V=Symbol("u8"),q=Symbol("i8"),H=Symbol("u16"),B=Symbol("i16"),E=Symbol("u32"),N=Symbol("i32"),F=Symbol("f32"),W=Symbol("f64"),C=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),We=C(V),Oe=C(q),Se=C(H),Me=C(B),Ae=C(E),De=C(N),Qe=C(F),we=C(W),ce={[V]:(e,t,n)=>(e.setUint8(t,n),1),[q]:(e,t,n)=>(e.setInt8(t,n),1),[H]:(e,t,n)=>(e.setUint16(t,n),2),[B]:(e,t,n)=>(e.setInt16(t,n),2),[E]:(e,t,n)=>(e.setUint32(t,n),4),[N]:(e,t,n)=>(e.setInt32(t,n),4),[F]:(e,t,n)=>(e.setFloat32(t,n),4),[W]:(e,t,n)=>(e.setFloat64(t,n),8)},me={[V]:(e,t)=>({value:e.getUint8(t),size:1}),[q]:(e,t)=>({value:e.getInt8(t),size:1}),[H]:(e,t)=>({value:e.getUint16(t),size:2}),[B]:(e,t)=>({value:e.getInt16(t),size:2}),[E]:(e,t)=>({value:e.getUint32(t),size:4}),[N]:(e,t)=>({value:e.getInt32(t),size:4}),[F]:(e,t)=>({value:e.getFloat32(t),size:4}),[W]:(e,t)=>({value:e.getFloat64(t),size:8})},ke=e=>{let t=Object.keys(e),r=t.map(o=>{let a=e[o];for(let s of[V,q,H,B,E,N,F,W])if(s in a)return s;return W}).map(o=>ce[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,s)=>{let i=0;i+=ce[E](o,a+i,s);for(let p=0;p<t.length;p++)i+=r[p](o,a+i,e[t[p]][s]);return i}},$e=e=>{let t=Object.keys(e),r=t.map(o=>{let a=e[o];for(let s of[V,q,H,B,E,N,F,W])if(s in a)return s;return W}).map(o=>me[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,a,s)=>{let i=0,{value:p,size:c}=me[E](o,a+i);i+=c;let l=s?s.get(p)??p:p;for(let m=0;m<t.length;m++){let{value:y,size:f}=r[m](o,a+i);e[t[m]][l]=y,i+=f}return i}},ee=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),r=e.map(ke);return o=>{let a=0;for(let s=0;s<o.length;s++){let i=o[s];for(let p=0;p<r.length;p++)a+=r[p](n,a,i)}return t.slice(0,a)}},te=e=>{let t=e.map($e);return(n,r)=>{let o=new DataView(n),a=0;for(;a<n.byteLength;)for(let s=0;s<t.length;s++)a+=t[s](o,a,r)}};var O=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var le=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t};var ne=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var d=Symbol("internal");var oe=e=>e[d].entityIndex.dense.slice(0);var re=()=>{let e=[],t=[],n=s=>e[t[s]]===s;return{add:s=>{n(s)||(t[s]=e.push(s)-1)},remove:s=>{if(!n(s))return;let i=t[s],p=e.pop();p!==s&&(e[i]=p,t[p]=i)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},ue=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(e),o=p=>p<t.length&&t[p]<n&&r[t[p]]===p;return{add:p=>{if(!o(p)){if(n>=r.length){let c=new Uint32Array(r.length*2);c.set(r),r=c}r[n]=p,t[p]=n,n++}},remove:p=>{if(!o(p))return;n--;let c=t[p],l=r[n];r[c]=l,t[l]=c},has:o,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var Q=()=>{let e=new Set;return{subscribe:r=>(e.add(r),()=>{e.delete(r)}),notify:(r,...o)=>Array.from(e).reduce((a,s)=>{let i=s(r,...o);return i&&typeof i=="object"?{...a,...i}:a},{})}};var h=Symbol("opType"),w=Symbol("opTerms"),ae=(...e)=>({[h]:"add",[w]:e}),se=(...e)=>({[h]:"remove",[w]:e});function X(e,t,n){let r=e[d],{[h]:o,[w]:a}=t;if(o==="add"||o==="remove"){let s=de(e,a),i=r.queriesHashMap.get(s);return i||(i=ye(e,a)),i[o==="add"?"addObservable":"removeObservable"].subscribe(n)}else if(o==="set"||o==="get"){if(a.length!==1)throw new Error("Set and Get hooks can only observe a single component");let s=a[0],i=r.componentMap.get(s);if(!i&&(S(e,s),!r.componentMap.get(s)))throw new Error(`Failed to register component ${s.name}`);return i[o==="set"?"setObservable":"getObservable"].subscribe(n)}throw new Error(`Invalid hook type: ${o}`)}var de=(e,t)=>{let n=e[d],r=a=>(n.componentMap.has(a)||S(e,a),n.componentMap.get(a).id),o=a=>{if(h in a){let i=a[w].map(r).sort((c,l)=>c-l);return`${a[h].toLowerCase()}(${i.join(",")})`}else return r(a).toString()};return t.map(o).sort().join("-")},ye=(e,t,n={})=>{let r=e[d],o=de(e,t),a=[],s=[],i=[],p=(u,b)=>{u.forEach(J=>{r.componentMap.has(J)||S(e,J),b.push(J)})};t.forEach(u=>{h in u?u[h]==="Not"?p(u[w],s):u[h]==="Or"&&p(u[w],i):(r.componentMap.has(u)||S(e,u),a.push(u))});let c=u=>r.componentMap.get(u),l=a.concat(s.flat()).concat(i.flat()).map(c),m=n.buffered?ue():re(),y=re(),f=l.map(u=>u.generationId).reduce((u,b)=>(u.includes(b)||u.push(b),u),[]),x=(u,b)=>(u[b.generationId]||(u[b.generationId]=0),u[b.generationId]|=b.bitflag,u),_=a.map(c).reduce(x,{}),Re=s.map(c).reduce(x,{}),Ce=i.map(c).reduce(x,{}),he=l.reduce(x,{}),Ie=Q(),Ee=Q(),I=Object.assign(m,{components:a,notComponents:s,orComponents:i,allComponents:l,masks:_,notMasks:Re,orMasks:Ce,hasMasks:he,generations:f,toRemove:y,addObservable:Ie,removeObservable:Ee,queues:{}});r.queries.add(I),r.queriesHashMap.set(o,I),l.forEach(u=>{u.queries.add(I)}),s.length&&r.notQueries.add(I);let pe=r.entityIndex;for(let u=0;u<pe.aliveCount;u++){let b=pe.dense[u];if(T(e,b,U))continue;k(e,I,b)&&$(I,b)}return I};function k(e,t,n){let r=e[d],{masks:o,notMasks:a,orMasks:s,generations:i}=t;for(let p=0;p<i.length;p++){let c=i[p],l=o[c],m=a[c],y=s[c],f=r.entityMasks[c][n];if(m&&f&m||l&&(f&l)!==l||y&&!(f&y))return!1}return!0}var $=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var Y=(e,t,n)=>{let r=e[d];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))};var j=Symbol("relation"),M=Symbol("pairTarget"),K=Symbol("isPairComponent"),R=Symbol("relationData"),fe=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?g:n;if(!e.pairsMap.has(r)){let o={};O(o,j,t),O(o,M,r),O(o,K,!0),e.pairsMap.set(r,o)}return e.pairsMap.get(r)};return O(t,R,e),t},be=e=>t=>{let n=t[R];return n.initStore=e,r=>{if(r===void 0)throw Error("Relation target is undefined");let o=r==="*"?g:r;if(!n.pairsMap.has(o)){let a=e();O(a,R,{pairTarget:o,...n}),n.pairsMap.set(o,a)}return n.pairsMap.get(o)}},je=e=>{let t=e[R];return t.exclusiveRelation=!0,e},xe=e=>{let t=e[R];return t.autoRemoveSubject=!0,e},ge=e=>t=>{let n=t[R];return n.onTargetRemoved=e,t};var A=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},g=ie(),z=ie(),P=(e,t,n)=>{let r=G(e,t),o=[];for(let a of r)a[j]===n&&a[M]!==g&&o.push(a[M]);return o};function ie(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:o}=e[0];return[t&&be(t),n&&je,r&&xe,o&&ge(o)].filter(Boolean).reduce((s,i)=>i(s),fe())}else return e.reduce((n,r)=>r(n),fe())}var S=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[d],r=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:Q(),getObservable:Q()};return n.componentMap.set(t,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var T=(e,t,n)=>{let r=e[d],o=r.componentMap.get(n);if(!o)return!1;let{generationId:a,bitflag:s}=o;return(r.entityMasks[a][t]&s)===s},ve=(e,t,n)=>{let o=e[d].componentMap.get(n);if(o&&T(e,t,n))return o.getObservable.notify(t)};var Te=(e,t,n)=>{let r=e[d];v(e,t,z(n));let o=G(e,n);for(let s of o){if(s===U)continue;v(e,t,s);let i=r.componentMap.get(s);if(i&&i.setObservable){let p=ve(e,n,s);i.setObservable.notify(t,p)}}let a=P(e,n,z);for(let s of a)Te(e,t,s)},v=(e,t,...n)=>{let r=e[d];if(!Z(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);n.forEach(o=>{let a="component"in o?o.component:o,s="data"in o?o.data:void 0;if(r.componentMap.has(a)||S(e,a),T(e,t,a))return;let i=r.componentMap.get(a),{generationId:p,bitflag:c,queries:l}=i;if(r.entityMasks[p][t]|=c,T(e,t,U)||l.forEach(m=>{m.toRemove.remove(t),k(e,m,t)?$(m,t):Y(e,m,t)}),r.entityComponents.get(t).add(a),s!==void 0&&i.setObservable.notify(t,s),a[K]){let m=a[j];v(e,t,A(m,g));let y=a[M];if(v(e,t,A(g,y)),m[R].exclusiveRelation===!0&&y!==g){let x=P(e,t,m)[0];x!=null&&x!==y&&D(e,t,m(x))}if(m===z){let x=P(e,t,z);for(let _ of x)Te(e,t,_)}}})};var D=(e,t,...n)=>{let r=e[d];if(!Z(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(o=>{if(!T(e,t,o))return;let a=r.componentMap.get(o),{generationId:s,bitflag:i,queries:p}=a;if(r.entityMasks[s][t]&=~i,p.forEach(c=>{c.toRemove.remove(t),k(e,c,t)?$(c,t):Y(e,c,t)}),r.entityComponents.get(t).delete(o),o[K]){let c=o[M];D(e,t,A(g,c));let l=o[j];P(e,t,l).length===0&&D(e,t,A(l,g))}})};var U={};var L=e=>{let t=e[d],n=le(t.entityIndex);return t.notQueries.forEach(r=>{k(e,r,n)&&$(r,n)}),t.entityComponents.set(n,new Set),n};var G=(e,t)=>{let n=e[d];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!ne(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},Z=(e,t)=>ne(e[d].entityIndex,t);var Pe=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(n),o=0,a=i=>{let p=i.length;r.setUint32(o,p),o+=4;for(let c=0;c<p;c++){let l=i[c],m=0;r.setUint32(o,l),o+=4;let y=o;o+=1;for(let f=0;f<t.length;f++)T(e,l,t[f])&&(r.setUint8(o,f),o+=1,m++);r.setUint8(y,m)}},s=i=>{let c=ee(t,n.slice(o))(i);new Uint8Array(n).set(new Uint8Array(c),o),o+=c.byteLength};return()=>{o=0;let i=oe(e);return a(i),s(i),n.slice(0,o)}},Ve=(e,t)=>{let n=te(t);return r=>{let o=new DataView(r),a=0,s=new Map,i=o.getUint32(a);a+=4;for(let p=0;p<i;p++){let c=o.getUint32(a);a+=4;let l=L(e);s.set(c,l);let m=o.getUint8(a);a+=1;for(let y=0;y<m;y++){let f=o.getUint8(a);a+=1,v(e,l,t[f])}}return n(r.slice(a),s),s}};var qe=(e,t,n,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),a=0,s=[];return n.forEach((i,p)=>{X(e,ae(t,i),c=>{s.push([c,0,p])}),X(e,se(t,i),c=>{s.push([c,1,p])})}),()=>{a=0;for(let i=0;i<s.length;i++){let[p,c,l]=s[i];o.setUint32(a,p),a+=4,o.setUint8(a,c),a+=1,o.setUint8(a,l),a+=1}return s.length=0,r.slice(0,a)}},He=(e,t,n)=>(r,o=new Map)=>{let a=new DataView(r),s=0;for(;s<r.byteLength;){let i=a.getUint32(s);s+=4;let p=a.getUint8(s);s+=1;let c=a.getUint8(s);s+=1;let l=n[c],m=o.get(i);m===void 0&&(m=L(e),o.set(i,m)),p===0?(v(e,m,l),v(e,m,t)):p===1&&D(e,m,l)}return o};export{He as createObserverDeserializer,qe as createObserverSerializer,Ve as createSnapshotDeserializer,Pe as createSnapshotSerializer,te as createSoADeserializer,ee as createSoASerializer,Qe as f32,we as f64,Me as i16,De as i32,Oe as i8,Se as u16,Ae as u32,We as u8};
//# sourceMappingURL=index.min.mjs.map
