var w=Symbol("u8"),U=Symbol("i8"),z=Symbol("u16"),$=Symbol("i16"),T=Symbol("u32"),P=Symbol("i32"),V=Symbol("f32"),I=Symbol("f64"),R=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),Re=R(w),Ce=R(U),he=R(z),Te=R($),Ie=R(T),We=R(P),Oe=R(V),Se=R(I),se={[w]:(e,t,n)=>(e.setUint8(t,n),1),[U]:(e,t,n)=>(e.setInt8(t,n),1),[z]:(e,t,n)=>(e.setUint16(t,n),2),[$]:(e,t,n)=>(e.setInt16(t,n),2),[T]:(e,t,n)=>(e.setUint32(t,n),4),[P]:(e,t,n)=>(e.setInt32(t,n),4),[V]:(e,t,n)=>(e.setFloat32(t,n),4),[I]:(e,t,n)=>(e.setFloat64(t,n),8)},ae={[w]:(e,t)=>({value:e.getUint8(t),size:1}),[U]:(e,t)=>({value:e.getInt8(t),size:1}),[z]:(e,t)=>({value:e.getUint16(t),size:2}),[$]:(e,t)=>({value:e.getInt16(t),size:2}),[T]:(e,t)=>({value:e.getUint32(t),size:4}),[P]:(e,t)=>({value:e.getInt32(t),size:4}),[V]:(e,t)=>({value:e.getFloat32(t),size:4}),[I]:(e,t)=>({value:e.getFloat64(t),size:8})},Ee=e=>{let t=Object.keys(e),r=t.map(o=>{let s=e[o];for(let a of[w,U,z,$,T,P,V,I])if(a in s)return a;return I}).map(o=>se[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,s,a)=>{let p=0;p+=se[T](o,s+p,a);for(let i=0;i<t.length;i++)p+=r[i](o,s+p,e[t[i]][a]);return p}},Ae=e=>{let t=Object.keys(e),r=t.map(o=>{let s=e[o];for(let a of[w,U,z,$,T,P,V,I])if(a in s)return a;return I}).map(o=>ae[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,s,a)=>{let p=0,{value:i,size:c}=ae[T](o,s+p);p+=c;let m=a?a.get(i)??i:i;for(let l=0;l<t.length;l++){let{value:d,size:y}=r[l](o,s+p);e[t[l]][m]=d,p+=y}return p}},Y=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),r=e.map(Ee);return o=>{let s=0;for(let a=0;a<o.length;a++){let p=o[a];for(let i=0;i<r.length;i++)s+=r[i](n,s,p)}return t.slice(0,s)}},Z=e=>{let t=e.map(Ae);return(n,r)=>{let o=new DataView(n),s=0;for(;s<n.byteLength;)for(let a=0;a<t.length;a++)s+=t[a](o,s,r)}};var W=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var ie=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t};var _=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var f=Symbol("internal");var ee=e=>e[f].entityIndex.dense.slice(0);var te=()=>{let e=[],t=[],n=a=>e[t[a]]===a;return{add:a=>{n(a)||(t[a]=e.push(a)-1)},remove:a=>{if(!n(a))return;let p=t[a],i=e.pop();i!==a&&(e[p]=i,t[i]=p)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},pe=(e=1e3)=>{let t=[],n=0,r=new Uint32Array(e),o=i=>i<t.length&&t[i]<n&&r[t[i]]===i;return{add:i=>{if(!o(i)){if(n>=r.length){let c=new Uint32Array(r.length*2);c.set(r),r=c}r[n]=i,t[i]=n,n++}},remove:i=>{if(!o(i))return;n--;let c=t[i],m=r[n];r[c]=m,t[m]=c},has:o,sparse:t,get dense(){return new Uint32Array(r.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var j=()=>{let e=new Set;return{subscribe:r=>(e.add(r),()=>{e.delete(r)}),notify:(r,...o)=>{e.forEach(s=>s(r,...o))}}};var ne=(...e)=>({type:"add",components:e}),oe=(...e)=>({type:"remove",components:e});var G=(e,t,n)=>{let r=e[f],{type:o,components:s}=t,a=ce(e,s),p=r.queriesHashMap.get(a);return p||(p=ue(e,s)),p[o==="add"?"addObservable":o==="remove"?"removeObservable":"setObservable"].subscribe(n)};var ce=(e,t)=>{let n=e[f],r=s=>(n.componentMap.has(s)||E(e,s),n.componentMap.get(s).id),o=s=>{if("type"in s){let p=s.components.map(r).sort((c,m)=>c-m);return`${s.type.toLowerCase()}(${p.join(",")})`}else return r(s).toString()};return t.map(o).sort().join("-")},ue=(e,t,n={})=>{let r=e[f],o=ce(e,t),s=[],a=[],p=[],i=(u,b)=>{u.forEach(K=>{r.componentMap.has(K)||E(e,K),b.push(K)})};t.forEach(u=>{"type"in u?u.type==="Not"?i(u.components,a):u.type==="Or"&&i(u.components,p):(r.componentMap.has(u)||E(e,u),s.push(u))});let c=u=>r.componentMap.get(u),m=s.concat(a).concat(p.flat()).map(c),l=n.buffered?pe():te(),d=te(),y=m.map(u=>u.generationId).reduce((u,b)=>(u.includes(b)||u.push(b),u),[]),L=(u,b)=>(u[b.generationId]||(u[b.generationId]=0),u[b.generationId]|=b.bitflag,u),ye=s.map(c).reduce(L,{}),de=a.map(c).reduce(L,{}),be=p.map(c).reduce(L,{}),xe=m.reduce(L,{}),ge=j(),ve=j(),h=Object.assign(l,{components:s,notComponents:a,orComponents:p,allComponents:m,masks:ye,notMasks:de,orMasks:be,hasMasks:xe,generations:y,toRemove:d,addObservable:ge,removeObservable:ve});r.queries.add(h),r.queriesHashMap.set(o,h),m.forEach(u=>{u.queries.add(h)}),a.length&&r.notQueries.add(h);let re=r.entityIndex;for(let u=0;u<re.aliveCount;u++){let b=re.dense[u];if(C(e,Q,b))continue;A(e,h,b)&&M(h,b)}return h};function A(e,t,n){let r=e[f],{masks:o,notMasks:s,orMasks:a,generations:p}=t;for(let i=0;i<p.length;i++){let c=p[i],m=o[c],l=s[c],d=a[c],y=r.entityMasks[c][n];if(l&&y&l||m&&(y&m)!==m||d&&!(y&d))return!1}return!0}var M=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var J=(e,t,n)=>{let r=e[f];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),r.dirtyQueries.add(t),t.removeObservable.notify(n))};var k=Symbol("relation"),O=Symbol("pairTarget"),q=Symbol("isPairComponent"),v=Symbol("relationData"),me=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let r=n==="*"?g:n;if(!e.pairsMap.has(r)){let o={};W(o,k,t),W(o,O,r),W(o,q,!0),e.pairsMap.set(r,o)}return e.pairsMap.get(r)};return W(t,v,e),t},Qe=e=>t=>{let n=t[v];return n.initStore=e,r=>{if(r===void 0)throw Error("Relation target is undefined");let o=r==="*"?g:r;if(!n.pairsMap.has(o)){let s=e();W(s,v,{pairTarget:o,...n}),n.pairsMap.set(o,s)}return n.pairsMap.get(o)}},ke=e=>{let t=e[v];return t.exclusiveRelation=!0,e},De=e=>{let t=e[v];return t.autoRemoveSubject=!0,e},we=e=>t=>{let n=t[v];return n.onTargetRemoved=e,t};var D=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},g=le(),B=le(),H=(e,t,n)=>{let r=N(e,n),o=[];for(let s of r)s[k]===t&&s[O]!==g&&o.push(s[O]);return o};function le(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:r,onTargetRemoved:o}=e[0];return[t&&Qe(t),n&&ke,r&&De,o&&we(o)].filter(Boolean).reduce((a,p)=>p(a),me())}else return e.reduce((n,r)=>r(n),me())}var E=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[f],r=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:r,setObservable:j()};return n.componentMap.set(t,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var C=(e,t,n)=>{let r=e[f],o=r.componentMap.get(t);if(!o)return!1;let{generationId:s,bitflag:a}=o;return(r.entityMasks[s][n]&a)===a},fe=(e,t,n)=>{x(e,B(n),t);let r=N(e,n);for(let s of r){if(s===Q)continue;x(e,s,t);let a=Object.keys(s);for(let p of a)s[p][t]=s[p][n]}let o=H(e,B,n);for(let s of o)fe(e,t,s)},x=(e,t,n)=>{let r=e[f];if(!X(e,n))throw new Error("bitECS - entity does not exist in the world.");if(r.componentMap.has(t)||E(e,t),C(e,t,n))return;let o=r.componentMap.get(t),{generationId:s,bitflag:a,queries:p}=o;if(r.entityMasks[s][n]|=a,C(e,Q,n)||p.forEach(i=>{i.toRemove.remove(n),A(e,i,n)?M(i,n):J(e,i,n)}),r.entityComponents.get(n).add(t),t[q]){let i=t[k];x(e,D(i,g),n);let c=t[O];if(x(e,D(g,c),n),i[v].exclusiveRelation===!0&&c!==g){let l=H(e,i,n)[0];l!=null&&l!==c&&S(e,i(l),n)}if(i===B){let l=H(e,B,n);for(let d of l)fe(e,n,d)}}};var S=(e,t,n)=>{let r=e[f];if(!X(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!C(e,t,n))return;let o=r.componentMap.get(t),{generationId:s,bitflag:a,queries:p}=o;if(r.entityMasks[s][n]&=~a,p.forEach(i=>{i.toRemove.remove(n),A(e,i,n)?M(i,n):J(e,i,n)}),r.entityComponents.get(n).delete(t),t[q]){let i=t[O];S(e,D(g,i),n);let c=t[k];H(e,c,n).length===0&&S(e,D(c,g),n)}};var Q={};var F=e=>{let t=e[f],n=ie(t.entityIndex);return t.notQueries.forEach(r=>{A(e,r,n)&&M(r,n)}),t.entityComponents.set(n,new Set),n};var N=(e,t)=>{let n=e[f];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!_(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},X=(e,t)=>_(e[f].entityIndex,t);var ze=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(n),o=0,s=p=>{let i=p.length;r.setUint32(o,i),o+=4;for(let c=0;c<i;c++){let m=p[c],l=0;r.setUint32(o,m),o+=4;let d=o;o+=1;for(let y=0;y<t.length;y++)C(e,t[y],m)&&(r.setUint8(o,y),o+=1,l++);r.setUint8(d,l)}},a=p=>{let c=Y(t,n.slice(o))(p);new Uint8Array(n).set(new Uint8Array(c),o),o+=c.byteLength};return()=>{o=0;let p=ee(e);return s(p),a(p),n.slice(0,o)}},$e=(e,t)=>{let n=Z(t);return r=>{let o=new DataView(r),s=0,a=new Map,p=o.getUint32(s);s+=4;for(let i=0;i<p;i++){let c=o.getUint32(s);s+=4;let m=F(e);a.set(c,m);let l=o.getUint8(s);s+=1;for(let d=0;d<l;d++){let y=o.getUint8(s);s+=1,x(e,t[y],m)}}return n(r.slice(s),a),a}};var Pe=(e,t,n,r=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(r),s=0,a=[];return n.forEach((p,i)=>{G(e,ne(t,p),c=>{a.push([c,0,i])}),G(e,oe(t,p),c=>{a.push([c,1,i])})}),()=>{s=0;for(let p=0;p<a.length;p++){let[i,c,m]=a[p];o.setUint32(s,i),s+=4,o.setUint8(s,c),s+=1,o.setUint8(s,m),s+=1}return a.length=0,r.slice(0,s)}},Ve=(e,t,n)=>(r,o=new Map)=>{let s=new DataView(r),a=0;for(;a<r.byteLength;){let p=s.getUint32(a);a+=4;let i=s.getUint8(a);a+=1;let c=s.getUint8(a);a+=1;let m=n[c],l=o.get(p);l===void 0&&(l=F(e),o.set(p,l)),i===0?(x(e,m,l),x(e,t,l)):i===1&&S(e,m,l)}return o};export{Ve as createObserverDeserializer,Pe as createObserverSerializer,$e as createSnapshotDeserializer,ze as createSnapshotSerializer,Z as createSoADeserializer,Y as createSoASerializer,Oe as f32,Se as f64,Te as i16,We as i32,Ce as i8,he as u16,Ie as u32,Re as u8};
//# sourceMappingURL=index.min.mjs.map
