var B=Symbol("u8"),N=Symbol("i8"),F=Symbol("u16"),K=Symbol("i16"),W=Symbol("u32"),G=Symbol("i32"),L=Symbol("f32"),A=Symbol("f64"),I=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),Me=I(B),De=I(N),Qe=I(F),ke=I(K),$e=I(W),we=I(G),Ue=I(L),ze=I(A),le={[B]:(e,t,n)=>(e.setUint8(t,n),1),[N]:(e,t,n)=>(e.setInt8(t,n),1),[F]:(e,t,n)=>(e.setUint16(t,n),2),[K]:(e,t,n)=>(e.setInt16(t,n),2),[W]:(e,t,n)=>(e.setUint32(t,n),4),[G]:(e,t,n)=>(e.setInt32(t,n),4),[L]:(e,t,n)=>(e.setFloat32(t,n),4),[A]:(e,t,n)=>(e.setFloat64(t,n),8)},ye={[B]:(e,t)=>({value:e.getUint8(t),size:1}),[N]:(e,t)=>({value:e.getInt8(t),size:1}),[F]:(e,t)=>({value:e.getUint16(t),size:2}),[K]:(e,t)=>({value:e.getInt16(t),size:2}),[W]:(e,t)=>({value:e.getUint32(t),size:4}),[G]:(e,t)=>({value:e.getInt32(t),size:4}),[L]:(e,t)=>({value:e.getFloat32(t),size:4}),[A]:(e,t)=>({value:e.getFloat64(t),size:8})},Ve=e=>{let t=Object.keys(e),s=t.map(r=>{let o=e[r];for(let i of[B,N,F,K,W,G,L,A])if(i in o)return i;return A}).map(r=>le[r]||(()=>{throw new Error("Unsupported or unannotated type")}));return(r,o,i)=>{let a=0;a+=le[W](r,o+a,i);for(let p=0;p<t.length;p++)a+=s[p](r,o+a,e[t[p]][i]);return a}},je=e=>{let t=Object.keys(e),s=t.map(r=>{let o=e[r];for(let i of[B,N,F,K,W,G,L,A])if(i in o)return i;return A}).map(r=>ye[r]||(()=>{throw new Error("Unsupported or unannotated type")}));return(r,o,i)=>{let a=0,{value:p,size:m}=ye[W](r,o+a);a+=m;let c=i?i.get(p)??p:p;for(let u=0;u<t.length;u++){let{value:f,size:d}=s[u](r,o+a);e[t[u]][c]=f,a+=d}return a}},re=(e,t=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(t),s=e.map(Ve);return r=>{let o=0;for(let i=0;i<r.length;i++){let a=r[i];for(let p=0;p<s.length;p++)o+=s[p](n,o,a)}return t.slice(0,o)}},se=e=>{let t=e.map(je);return(n,s)=>{let r=new DataView(n),o=0;for(;o<n.byteLength;)for(let i=0;i<t.length;i++)o+=t[i](r,o,s)}};var ae=()=>{let e=[],t=[],n=i=>e[t[i]]===i;return{add:i=>{n(i)||(t[i]=e.push(i)-1)},remove:i=>{if(!n(i))return;let a=t[i],p=e.pop();p!==i&&(e[a]=p,t[p]=a)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},fe=(e=1e3)=>{let t=[],n=0,s=new Uint32Array(e),r=p=>p<t.length&&t[p]<n&&s[t[p]]===p;return{add:p=>{if(!r(p)){if(n>=s.length){let m=new Uint32Array(s.length*2);m.set(s),s=m}s[n]=p,t[p]=n,n++}},remove:p=>{if(!r(p))return;n--;let m=t[p],c=s[n];s[m]=c,t[c]=m},has:r,sparse:t,get dense(){return new Uint32Array(s.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var k=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var de=(e,t)=>t&e.entityMask,be=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,Pe=(e,t)=>{let s=be(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|s<<e.versionShift};var ve=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount],s=n;return e.sparse[s]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},xe=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let s=e.aliveCount-1,r=e.dense[s];if(e.sparse[r]=n,e.dense[n]=r,e.sparse[t]=s,e.dense[s]=t,e.versioning){let o=Pe(e,t);e.dense[s]=o}e.aliveCount--},Y=(e,t)=>{let n=de(e,t),s=e.sparse[n];return s!==void 0&&s<e.aliveCount&&e.dense[s]===t};var y=Symbol.for("bitecs_internal");var $=()=>{let e=new Set;return{subscribe:s=>(e.add(s),()=>{e.delete(s)}),notify:(s,...r)=>Array.from(e).reduce((o,i)=>{let a=i(s,...r);return a&&typeof a=="object"?{...o,...a}:o},{})}};var h=Symbol("opType"),w=Symbol("opTerms"),ee=(...e)=>({[h]:"add",[w]:e}),te=(...e)=>({[h]:"remove",[w]:e});function U(e,t,n){let s=e[y],{[h]:r,[w]:o}=t;if(r==="add"||r==="remove"){let i=ie(e,o),a=s.queriesHashMap.get(i);return a||(a=Z(e,o)),a[r==="add"?"addObservable":"removeObservable"].subscribe(n)}else if(r==="set"||r==="get"){if(o.length!==1)throw new Error("Set and Get hooks can only observe a single component");let i=o[0],a=s.componentMap.get(i);return a||(a=M(e,i)),a[r==="set"?"setObservable":"getObservable"].subscribe(n)}throw new Error(`Invalid hook type: ${r}`)}var ie=(e,t)=>{let n=e[y],s=o=>(n.componentMap.has(o)||M(e,o),n.componentMap.get(o).id),r=o=>{if(h in o){let a=o[w].map(s).sort((m,c)=>m-c);return`${o[h].toLowerCase()}(${a.join(",")})`}else return s(o).toString()};return t.map(r).sort().join("-")},Z=(e,t,n={})=>{let s=e[y],r=ie(e,t),o=[],i=[],a=[],p=(l,b)=>{l.forEach(X=>{s.componentMap.has(X)||M(e,X),b.push(X)})};t.forEach(l=>{h in l?l[h]==="Not"?p(l[w],i):l[h]==="Or"&&p(l[w],a):(s.componentMap.has(l)||M(e,l),o.push(l))});let m=l=>s.componentMap.get(l),c=o.concat(i.flat()).concat(a.flat()).map(m),u=n.buffered?fe():ae(),f=ae(),d=c.map(l=>l.generationId).reduce((l,b)=>(l.includes(b)||l.push(b),l),[]),x=(l,b)=>(l[b.generationId]||(l[b.generationId]=0),l[b.generationId]|=b.bitflag,l),oe=o.map(m).reduce(x,{}),Ee=i.map(m).reduce(x,{}),Oe=a.map(m).reduce(x,{}),Se=c.reduce(x,{}),We=$(),Ae=$(),S=Object.assign(u,{components:o,notComponents:i,orComponents:a,allComponents:c,masks:oe,notMasks:Ee,orMasks:Oe,hasMasks:Se,generations:d,toRemove:f,addObservable:We,removeObservable:Ae,queues:{}});s.queries.add(S),s.queriesHashMap.set(r,S),c.forEach(l=>{l.queries.add(S)}),i.length&&s.notQueries.add(S);let ue=s.entityIndex;for(let l=0;l<ue.aliveCount;l++){let b=ue.dense[l];if(g(e,b,j))continue;z(e,S,b)&&V(S,b)}return S};function pe(e,t,n={}){let s=e[y],r=ie(e,t),o=s.queriesHashMap.get(r);return o?n.buffered&&!("buffer"in o.dense)&&(o=Z(e,t,{buffered:!0})):o=Z(e,t,n),o.dense}function z(e,t,n){let s=e[y],{masks:r,notMasks:o,orMasks:i,generations:a}=t;for(let p=0;p<a.length;p++){let m=a[p],c=r[m],u=o[m],f=i[m],d=s.entityMasks[m][n];if(u&&d&u||c&&(d&c)!==c||f&&!(d&f))return!1}return!0}var V=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var _=(e,t,n)=>{let s=e[y];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),s.dirtyQueries.add(t),t.removeObservable.notify(n))};var Q=Symbol("relation"),O=Symbol("pairTarget"),H=Symbol("isPairComponent"),T=Symbol("relationData"),Ie=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let s=n==="*"?v:n;if(!e.pairsMap.has(s)){let r=e.initStore?e.initStore():{};k(r,Q,t),k(r,O,s),k(r,H,!0),e.pairsMap.set(s,r)}return e.pairsMap.get(s)};return k(t,T,e),t},Re=e=>t=>{let n=t[T];return n.initStore=e,t},He=e=>{let t=e[T];return t.exclusiveRelation=!0,e},ge=e=>{let t=e[T];return t.autoRemoveSubject=!0,e},Ce=e=>t=>{let n=t[T];return n.onTargetRemoved=e,t};var E=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},v=me(),P=me(),q=(e,t,n)=>{let s=J(e,t),r=[];for(let o of s)o[Q]===n&&o[O]!==v&&r.push(o[O]);return r};function me(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:s,onTargetRemoved:r}=e[0];return[t&&Re(t),n&&He,s&&ge,r&&Ce(r)].filter(Boolean).reduce((i,a)=>a(i),Ie())}else return e.reduce((n,s)=>s(n),Ie())}var j={};var ce=e=>{let t=e[y],n=ve(t.entityIndex);return t.notQueries.forEach(s=>{z(e,s,n)&&V(s,n)}),t.entityComponents.set(n,new Set),n},ne=(e,t)=>{let n=e[y];if(!Y(n.entityIndex,t))return;let s=[t],r=new Set;for(;s.length>0;){let o=s.shift();if(r.has(o))continue;r.add(o);let i=[];for(let a of pe(e,[v(o)]))if(D(e,a))for(let p of n.entityComponents.get(a)){if(!p[H])continue;let c=p[Q][T];i.push(()=>C(e,a,E(v,o))),p[O]===o&&(i.push(()=>C(e,a,p)),c.autoRemoveSubject&&s.push(a),c.onTargetRemoved&&i.push(()=>c.onTargetRemoved(e,a,o)))}for(let a of i)a();for(let a of s)ne(e,a);for(let a of n.queries)_(e,a,o);xe(n.entityIndex,o),n.entityComponents.delete(o);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][o]=0}},J=(e,t)=>{let n=e[y];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!Y(n.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(n.entityComponents.get(t))},D=(e,t)=>Y(e[y].entityIndex,t);var M=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[y],s=new Set,r={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:s,setObservable:$(),getObservable:$()};return n.componentMap.set(t,r),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),r};var g=(e,t,n)=>{let s=e[y],r=s.componentMap.get(n);if(!r)return!1;let{generationId:o,bitflag:i}=r;return(s.entityMasks[o][t]&i)===i},Te=(e,t,n)=>{let r=e[y].componentMap.get(n);if(r&&g(e,t,n))return r.getObservable.notify(t)};var he=(e,t,n,s=!0)=>{let r=e[y];R(e,t,P(n));for(let o of J(e,n))if(o!==j&&(R(e,t,o),s)){let i=r.componentMap.get(o);if(i?.setObservable){let a=Te(e,n,o);i.setObservable.notify(t,a)}}for(let o of q(e,n,P))he(e,t,o,!1)},R=(e,t,...n)=>{let s=e[y];if(!D(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);n.forEach(r=>{let o="component"in r?r.component:r,i="data"in r?r.data:void 0;s.componentMap.has(o)||M(e,o);let a=s.componentMap.get(o);if(i!==void 0&&a.setObservable.notify(t,i),g(e,t,o))return;let{generationId:p,bitflag:m,queries:c}=a;if(s.entityMasks[p][t]|=m,g(e,t,j)||c.forEach(u=>{u.toRemove.remove(t),z(e,u,t)?V(u,t):_(e,u,t)}),s.entityComponents.get(t).add(o),o[H]){let u=o[Q];R(e,t,E(u,v));let f=o[O];if(R(e,t,E(v,f)),u[T].exclusiveRelation===!0&&f!==v){let x=q(e,t,u)[0];x!=null&&x!==f&&C(e,t,u(x))}if(u===P){let x=q(e,t,P);for(let oe of x)he(e,t,oe)}}})};var C=(e,t,...n)=>{let s=e[y];if(!D(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);n.forEach(r=>{if(!g(e,t,r))return;let o=s.componentMap.get(r),{generationId:i,bitflag:a,queries:p}=o;if(s.entityMasks[i][t]&=~a,p.forEach(m=>{m.toRemove.remove(t),z(e,m,t)?V(m,t):_(e,m,t)}),s.entityComponents.get(t).delete(r),r[H]){let m=r[O];C(e,t,E(v,m));let c=r[Q];q(e,t,c).length===0&&C(e,t,E(c,v))}})};import{getAllEntities as Be,addEntity as Ne}from"../core";var Fe=(e,t,n=new ArrayBuffer(1024*1024*100))=>{let s=new DataView(n),r=0,o=a=>{let p=a.length;s.setUint32(r,p),r+=4;for(let m=0;m<p;m++){let c=a[m],u=0;s.setUint32(r,c),r+=4;let f=r;r+=1;for(let d=0;d<t.length;d++)g(e,c,t[d])&&(s.setUint8(r,d),r+=1,u++);s.setUint8(f,u)}},i=a=>{let m=re(t,n.slice(r))(a);new Uint8Array(n).set(new Uint8Array(m),r),r+=m.byteLength};return()=>{r=0;let a=Be(e);return o(a),i(a),n.slice(0,r)}},Ke=(e,t)=>{let n=se(t);return s=>{let r=new DataView(s),o=0,i=new Map,a=r.getUint32(o);o+=4;for(let p=0;p<a;p++){let m=r.getUint32(o);o+=4;let c=Ne(e);i.set(m,c);let u=r.getUint8(o);o+=1;for(let f=0;f<u;f++){let d=r.getUint8(o);o+=1,R(e,c,t[d])}}return n(s.slice(o),i),i}};var Ge=(e,t,n,s=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(s),o=0,i=[];return U(e,ee(t),a=>{i.push([a,0,-1])}),U(e,te(t),a=>{i.push([a,1,-1])}),n.forEach((a,p)=>{U(e,ee(t,a),m=>{i.push([m,2,p])}),U(e,te(t,a),m=>{i.push([m,3,p])})}),()=>{o=0;for(let a=0;a<i.length;a++){let[p,m,c]=i[a];r.setUint32(o,p),o+=4,r.setUint8(o,m),o+=1,(m===2||m===3)&&(r.setUint8(o,c),o+=1)}return i.length=0,s.slice(0,o)}},Le=(e,t,n,s=new Map)=>r=>{let o=new DataView(r),i=0;for(;i<r.byteLength;){let a=o.getUint32(i);i+=4;let p=o.getUint8(i);i+=1;let m=-1;(p===2||p===3)&&(m=o.getUint8(i),i+=1);let c=n[m],u=s.get(a);if(p===0)if(u===void 0)u=ce(e),s.set(a,u),R(e,u,t);else throw new Error(`Entity with ID ${a} already exists in the mapping.`);else u!==void 0&&D(e,u)&&(p===1?ne(e,u):p===2?R(e,u,c):p===3&&C(e,u,c))}return s};export{Le as createObserverDeserializer,Ge as createObserverSerializer,Ke as createSnapshotDeserializer,Fe as createSnapshotSerializer,se as createSoADeserializer,re as createSoASerializer,Ue as f32,ze as f64,ke as i16,we as i32,De as i8,Qe as u16,$e as u32,Me as u8};
//# sourceMappingURL=index.min.mjs.map
