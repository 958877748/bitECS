var v=Symbol.for("bitecs-u8"),x=Symbol.for("bitecs-i8"),I=Symbol.for("bitecs-u16"),T=Symbol.for("bitecs-i16"),g=Symbol.for("bitecs-u32"),C=Symbol.for("bitecs-i32"),h=Symbol.for("bitecs-f32"),U=Symbol.for("bitecs-f64"),S=e=>(t=[])=>Object.defineProperty(t,e,{value:!0,enumerable:!1,writable:!1,configurable:!1}),be=S(v),ge=S(x),Re=S(I),ve=S(T),xe=S(g),Ie=S(C),Te=S(h),Ce=S(U),ae={[v]:(e,t,r)=>(e.setUint8(t,r),1),[x]:(e,t,r)=>(e.setInt8(t,r),1),[I]:(e,t,r)=>(e.setUint16(t,r),2),[T]:(e,t,r)=>(e.setInt16(t,r),2),[g]:(e,t,r)=>(e.setUint32(t,r),4),[C]:(e,t,r)=>(e.setInt32(t,r),4),[h]:(e,t,r)=>(e.setFloat32(t,r),4),[U]:(e,t,r)=>(e.setFloat64(t,r),8)},pe={[v]:(e,t)=>({value:e.getUint8(t),size:1}),[x]:(e,t)=>({value:e.getInt8(t),size:1}),[I]:(e,t)=>({value:e.getUint16(t),size:2}),[T]:(e,t)=>({value:e.getInt16(t),size:2}),[g]:(e,t)=>({value:e.getUint32(t),size:4}),[C]:(e,t)=>({value:e.getInt32(t),size:4}),[h]:(e,t)=>({value:e.getFloat32(t),size:4}),[U]:(e,t)=>({value:e.getFloat64(t),size:8})},he=e=>{let t=Object.keys(e),n=t.map(i=>{let s=e[i];for(let o of[v,x,I,T,g,C,h,U])if(o in s)return o;return U}).map(i=>ae[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,s,o)=>{let a=0;a+=ae[g](i,s+a,o);for(let c=0;c<t.length;c++)a+=n[c](i,s+a,e[t[c]][o]);return a}},Ae=e=>{let t=Object.keys(e),n=t.map(i=>{let s=e[i];for(let o of[v,x,I,T,g,C,h,U])if(o in s)return o;return U}).map(i=>pe[i]||(()=>{throw new Error("Unsupported or unannotated type")}));return(i,s,o)=>{let a=0,{value:c,size:p}=pe[g](i,s+a);a+=p;let u=o?o.get(c)??c:c;for(let l=0;l<t.length;l++){let{value:m,size:y}=n[l](i,s+a);e[t[l]][u]=m,a+=y}return a}},X=(e,t=new ArrayBuffer(1024*1024*100))=>{let r=new DataView(t),n=e.map(he);return i=>{let s=0;for(let o=0;o<i.length;o++){let a=i[o];for(let c=0;c<n.length;c++)s+=n[c](r,s,a)}return t.slice(0,s)}},Y=e=>{let t=e.map(Ae);return(r,n)=>{let i=new DataView(r),s=0;for(;s<r.byteLength;)for(let o=0;o<t.length;o++)s+=t[o](i,s,n)}};var Q=(e,t,r)=>Object.defineProperty(e,t,{value:r,enumerable:!1,writable:!0,configurable:!0});var ce=(e,t)=>t&e.entityMask;var le=e=>{if(e.aliveCount<e.dense.length){let r=e.dense[e.aliveCount],n=r;return e.sparse[n]=e.aliveCount,e.aliveCount++,r}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t};var Z=(e,t)=>{let r=ce(e,t),n=e.sparse[r];return n!==void 0&&n<e.aliveCount&&e.dense[n]===t};var b=Symbol.for("bitecs_internal");var ee=e=>e[b].entityIndex.dense.slice(0);var G=()=>{let e=new Set;return{subscribe:n=>(e.add(n),()=>{e.delete(n)}),notify:(n,...i)=>Array.from(e).reduce((s,o)=>{let a=o(n,...i);return a&&typeof a=="object"?{...s,...a}:s},{})}};var lt=Symbol.for("bitecs-opType"),ut=Symbol.for("bitecs-opTerms");function B(e,t,r){let n=e[b],{masks:i,notMasks:s,orMasks:o,generations:a}=t;for(let c=0;c<a.length;c++){let p=a[c],u=i[p],l=s[p],m=o[p],y=n.entityMasks[p][r];if(l&&y&l||u&&(y&u)!==u||m&&!(y&m))return!1}return!0}var P=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)};var K=(e,t,r)=>{let n=e[b];!t.has(r)||t.toRemove.has(r)||(t.toRemove.add(r),n.dirtyQueries.add(t),t.removeObservable.notify(r))};var $=Symbol.for("bitecs-relation"),M=Symbol.for("bitecs-pairTarget"),F=Symbol.for("bitecs-isPairComponent"),w=Symbol.for("bitecs-relationData"),ue=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=r=>{if(r===void 0)throw Error("Relation target is undefined");let n=r==="*"?R:r;if(!e.pairsMap.has(n)){let i=e.initStore?e.initStore():{};Q(i,$,t),Q(i,M,n),Q(i,F,!0),e.pairsMap.set(n,i)}return e.pairsMap.get(n)};return Q(t,w,e),t};var D=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},k=(e,t,r)=>{let n=N(e,t),i=[];for(let s of n)s[$]===r&&s[M]!==R&&!H(s[M])&&i.push(s[M]);return i};var Oe=Symbol.for("bitecs-wildcard");function Se(){let e=ue();return Object.defineProperty(e,Oe,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function We(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=Se()),globalThis[e]}var R=We();function Me(){return ue()}function De(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=Me()),globalThis[e]}var j=De();function H(e){return e?Object.getOwnPropertySymbols(e).includes(w):!1}var te=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let r=e[b],n=new Set,i={id:r.componentCount++,generationId:r.entityMasks.length-1,bitflag:r.bitflag,ref:t,queries:n,setObservable:G(),getObservable:G()};return r.componentMap.set(t,i),r.bitflag*=2,r.bitflag>=2**31&&(r.bitflag=1,r.entityMasks.push([])),i};var W=(e,t,r)=>{let n=e[b],i=n.componentMap.get(r);if(!i)return!1;let{generationId:s,bitflag:o}=i;return(n.entityMasks[s][t]&o)===o},me=(e,t,r)=>{let i=e[b].componentMap.get(r);if(i&&W(e,t,r))return i.getObservable.notify(t)};var ye=(e,t,r,n=!0)=>{let i=e[b];E(e,t,j(r));for(let s of N(e,r))if(s!==q&&(E(e,t,s),n)){let o=i.componentMap.get(s);if(o?.setObservable){let a=me(e,r,s);o.setObservable.notify(t,a)}}for(let s of k(e,r,j))ye(e,t,s,!1)},E=(e,t,...r)=>{if(!_(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);let n=e[b];r.forEach(i=>{let s="component"in i?i.component:i,o="data"in i?i.data:void 0;n.componentMap.has(s)||te(e,s);let a=n.componentMap.get(s);if(o!==void 0&&a.setObservable.notify(t,o),W(e,t,s))return;let{generationId:c,bitflag:p,queries:u}=a;if(n.entityMasks[c][t]|=p,W(e,t,q)||u.forEach(l=>{l.toRemove.remove(t),B(e,l,t)?P(l,t):K(e,l,t)}),n.entityComponents.get(t).add(s),s[F]){let l=s[$],m=s[M];if(E(e,t,D(l,R)),E(e,t,D(R,m)),typeof m=="number"&&(E(e,m,D(R,l)),n.entitiesWithRelations.add(m)),n.entitiesWithRelations.add(m),l[w].exclusiveRelation===!0&&m!==R){let d=k(e,t,l)[0];d!=null&&d!==m&&V(e,t,l(d))}if(l===j){let d=k(e,t,j);for(let f of d)ye(e,t,f)}}})};var V=(e,t,...r)=>{let n=e[b];if(!_(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);r.forEach(i=>{if(!W(e,t,i))return;let s=n.componentMap.get(i),{generationId:o,bitflag:a,queries:c}=s;if(n.entityMasks[o][t]&=~a,c.forEach(p=>{p.toRemove.remove(t),B(e,p,t)?P(p,t):K(e,p,t)}),n.entityComponents.get(t).delete(i),i[F]){let p=i[M];V(e,t,D(R,p));let u=i[$];k(e,t,u).length===0&&V(e,t,D(u,R))}})};var q={};var J=e=>{let t=e[b],r=le(t.entityIndex);return t.notQueries.forEach(n=>{B(e,n,r)&&P(n,r)}),t.entityComponents.set(r,new Set),r};var N=(e,t)=>{let r=e[b];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!Z(r.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(r.entityComponents.get(t))},_=(e,t)=>Z(e[b].entityIndex,t);function Qe(e,t,r,n){if(!e)return n;if(Array.isArray(e)){let i=e[t];return i!==void 0?(r.setFloat64(n,i),n+8):n}if(typeof e=="object"){let i=Object.keys(e).sort();for(let s of i){let o=e[s],a=o[t];a!==void 0&&(o instanceof Int8Array||x in o?(r.setInt8(n,a),n+=1):o instanceof Uint8Array||v in o?(r.setUint8(n,a),n+=1):o instanceof Int16Array||T in o?(r.setInt16(n,a),n+=2):o instanceof Uint16Array||I in o?(r.setUint16(n,a),n+=2):o instanceof Int32Array||C in o?(r.setInt32(n,a),n+=4):o instanceof Uint32Array||g in o?(r.setUint32(n,a),n+=4):o instanceof Float32Array||h in o?(r.setFloat32(n,a),n+=4):(r.setFloat64(n,a),n+=8))}}return n}function $e(e,t,r,n){if(!e)return n;if(Array.isArray(e))return e[t]=r.getFloat64(n),n+8;if(typeof e=="object"){let i=Object.keys(e).sort();for(let s of i){let o=e[s];o instanceof Int8Array||x in o?(o[t]=r.getInt8(n),n+=1):o instanceof Uint8Array||v in o?(o[t]=r.getUint8(n),n+=1):o instanceof Int16Array||T in o?(o[t]=r.getInt16(n),n+=2):o instanceof Uint16Array||I in o?(o[t]=r.getUint16(n),n+=2):o instanceof Int32Array||C in o?(o[t]=r.getInt32(n),n+=4):o instanceof Uint32Array||g in o?(o[t]=r.getUint32(n),n+=4):o instanceof Float32Array||h in o?(o[t]=r.getFloat32(n),n+=4):(o[t]=r.getFloat64(n),n+=8)}}return n}var je=(e,t,r=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(r),i=0,s=a=>{let c=a.length;n.setUint32(i,c),i+=4;for(let p=0;p<c;p++){let u=a[p],l=0;n.setUint32(i,u),i+=4;let m=i;i+=1;for(let y=0;y<t.length;y++){let d=t[y];if(H(d)){let f=k(e,u,d);for(let A of f){n.setUint8(i,y),i+=1,n.setUint32(i,A),i+=4;let O=d(A);i=Qe(O,u,n,i),l++}}else W(e,u,d)&&(n.setUint8(i,y),i+=1,l++)}n.setUint8(m,l)}},o=a=>{let p=X(t,r.slice(i))(a);new Uint8Array(r).set(new Uint8Array(p),i),i+=p.byteLength};return()=>{i=0;let a=ee(e);return s(a),o(a),r.slice(0,i)}},ze=(e,t,r)=>{let n=r||new Map,i=Y(t);return(s,o)=>{let a=o||n,c=new DataView(s),p=0,u=c.getUint32(p);p+=4;for(let l=0;l<u;l++){let m=c.getUint32(p);p+=4;let y=a.get(m);y===void 0&&(y=J(e),a.set(m,y));let d=c.getUint8(p);p+=1;for(let f=0;f<d;f++){let A=c.getUint8(p);p+=1;let O=t[A];if(H(O)){let ie=c.getUint32(p);p+=4;let L=a.get(ie);L===void 0&&(L=J(e),a.set(ie,L));let se=O(L);E(e,y,se),p=$e(se,y,c,p)}else E(e,y,O)}}return i(s.slice(p),a),a}};import{addComponent as ne,removeComponent as fe,addEntity as Be,removeEntity as Pe,observe as z,onAdd as oe,onRemove as re,entityExists as qe,isRelation as Fe,getRelationTargets as we,Wildcard as de}from"bitecs";function He(e,t,r,n){if(!e)return n;if(Array.isArray(e)){let i=e[t];return i!==void 0?(r.setFloat64(n,i),n+8):n}if(typeof e=="object"){let i=Object.keys(e).sort();for(let s of i){let o=e[s],a=o[t];a!==void 0&&(o instanceof Int8Array||x in o?(r.setInt8(n,a),n+=1):o instanceof Uint8Array||v in o?(r.setUint8(n,a),n+=1):o instanceof Int16Array||T in o?(r.setInt16(n,a),n+=2):o instanceof Uint16Array||I in o?(r.setUint16(n,a),n+=2):o instanceof Int32Array||C in o?(r.setInt32(n,a),n+=4):o instanceof Uint32Array||g in o?(r.setUint32(n,a),n+=4):o instanceof Float32Array||h in o?(r.setFloat32(n,a),n+=4):(r.setFloat64(n,a),n+=8))}}return n}function Ne(e,t,r,n){if(!e)return n;if(Array.isArray(e))return e[t]=r.getFloat64(n),n+8;if(typeof e=="object"){let i=Object.keys(e).sort();for(let s of i){let o=e[s];o instanceof Int8Array||x in o?(o[t]=r.getInt8(n),n+=1):o instanceof Uint8Array||v in o?(o[t]=r.getUint8(n),n+=1):o instanceof Int16Array||T in o?(o[t]=r.getInt16(n),n+=2):o instanceof Uint16Array||I in o?(o[t]=r.getUint16(n),n+=2):o instanceof Int32Array||C in o?(o[t]=r.getInt32(n),n+=4):o instanceof Uint32Array||g in o?(o[t]=r.getUint32(n),n+=4):o instanceof Float32Array||h in o?(o[t]=r.getFloat32(n),n+=4):(o[t]=r.getFloat64(n),n+=8)}}return n}var Ve=(e,t,r,n=new ArrayBuffer(1024*1024*100))=>{let i=new DataView(n),s=0,o=[],a=new Map;return z(e,oe(t),c=>{o.push([c,0,-1])}),z(e,re(t),c=>{o.push([c,1,-1]),a.delete(c)}),r.forEach((c,p)=>{Fe(c)?(z(e,oe(t,c(de)),u=>{let l=we(e,u,c);for(let m of l){a.has(u)||a.set(u,new Map),a.get(u).set(p,m);let y=c(m);o.push([u,4,p,m,y])}}),z(e,re(t,c(de)),u=>{let l=a.get(u);if(l){let m=l.get(p);m!==void 0&&(o.push([u,5,p,m]),l.delete(p),l.size===0&&a.delete(u))}})):(z(e,oe(t,c),u=>{o.push([u,2,p])}),z(e,re(t,c),u=>{o.push([u,3,p])}))}),()=>{s=0;for(let c=0;c<o.length;c++){let[p,u,l,m,y]=o[c];i.setUint32(s,p),s+=4,i.setUint8(s,u),s+=1,(u===2||u===3||u===4||u===5)&&(i.setUint8(s,l),s+=1,(u===4||u===5)&&(i.setUint32(s,m),s+=4,u===4&&y&&(s=He(y,p,i,s))))}return o.length=0,n.slice(0,s)}},Le=(e,t,r,n)=>{let i=n||new Map;return(s,o)=>{let a=o||i,c=new DataView(s),p=0;for(;p<s.byteLength;){let u=c.getUint32(p);p+=4;let l=c.getUint8(p);p+=1;let m=-1,y=-1;(l===2||l===3||l===4||l===5)&&(m=c.getUint8(p),p+=1,(l===4||l===5)&&(y=c.getUint32(p),p+=4));let d=r[m],f=a.get(u);if(l===0)if(f===void 0)f=Be(e),a.set(u,f),ne(e,f,t);else throw new Error(`Entity with ID ${u} already exists in the mapping.`);else if(f!==void 0&&qe(e,f)){if(l===1)Pe(e,f);else if(l===2)ne(e,f,d);else if(l===3)fe(e,f,d);else if(l===4){let A=a.get(y);if(A!==void 0){let O=d(A);ne(e,f,O),p=Ne(O,f,c,p)}}else if(l===5){let A=a.get(y);A!==void 0&&fe(e,f,d(A))}}}return a}};export{Le as createObserverDeserializer,Ve as createObserverSerializer,ze as createSnapshotDeserializer,je as createSnapshotSerializer,Y as createSoADeserializer,X as createSoASerializer,Te as f32,Ce as f64,ve as i16,Ie as i32,ge as i8,Re as u16,xe as u32,be as u8};
//# sourceMappingURL=index.min.mjs.map
