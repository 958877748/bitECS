var O=Symbol("u8"),Q=Symbol("i8"),k=Symbol("u16"),M=Symbol("i16"),C=Symbol("u32"),D=Symbol("i32"),U=Symbol("f32"),T=Symbol("f64"),b=t=>(e=[])=>Object.defineProperty(e,t,{value:!0,enumerable:!1,writable:!1,configurable:!1}),ye=b(O),ce=b(Q),ue=b(k),le=b(M),de=b(C),fe=b(D),be=b(U),xe=b(T),X={[O]:(t,e,n)=>(t.setUint8(e,n),1),[Q]:(t,e,n)=>(t.setInt8(e,n),1),[k]:(t,e,n)=>(t.setUint16(e,n),2),[M]:(t,e,n)=>(t.setInt16(e,n),2),[C]:(t,e,n)=>(t.setUint32(e,n),4),[D]:(t,e,n)=>(t.setInt32(e,n),4),[U]:(t,e,n)=>(t.setFloat32(e,n),4),[T]:(t,e,n)=>(t.setFloat64(e,n),8)},Y={[O]:(t,e)=>({value:t.getUint8(e),size:1}),[Q]:(t,e)=>({value:t.getInt8(e),size:1}),[k]:(t,e)=>({value:t.getUint16(e),size:2}),[M]:(t,e)=>({value:t.getInt16(e),size:2}),[C]:(t,e)=>({value:t.getUint32(e),size:4}),[D]:(t,e)=>({value:t.getInt32(e),size:4}),[U]:(t,e)=>({value:t.getFloat32(e),size:4}),[T]:(t,e)=>({value:t.getFloat64(e),size:8})},Ce=t=>{let e=Object.keys(t),s=e.map(o=>{let r=t[o];for(let a of[O,Q,k,M,C,D,U,T])if(a in r)return a;return T}).map(o=>X[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,a)=>{let i=0;i+=X[C](o,r+i,a);for(let p=0;p<e.length;p++)i+=s[p](o,r+i,t[e[p]][a]);return i}},Te=t=>{let e=Object.keys(t),s=e.map(o=>{let r=t[o];for(let a of[O,Q,k,M,C,D,U,T])if(a in r)return a;return T}).map(o=>Y[o]||(()=>{throw new Error("Unsupported or unannotated type")}));return(o,r,a)=>{let i=0,{value:p,size:m}=Y[C](o,r+i);i+=m;let c=a?a.get(p)??p:p;for(let y=0;y<e.length;y++){let{value:u,size:d}=s[y](o,r+i);t[e[y]][c]=u,i+=d}return i}},P=(t,e=new ArrayBuffer(1024*1024*100))=>{let n=new DataView(e),s=t.map(Ce);return o=>{let r=0;for(let a=0;a<o.length;a++){let i=o[a];for(let p=0;p<s.length;p++)r+=s[p](n,r,i)}return e.slice(0,r)}},j=t=>{let e=t.map(Te);return(n,s)=>{let o=new DataView(n),r=0;for(;r<n.byteLength;)for(let a=0;a<e.length;a++)r+=e[a](o,r,s)}};var W=(t,e,n)=>Object.defineProperty(t,e,{value:n,enumerable:!1,writable:!0,configurable:!0});var L=(t,e)=>{let n=t.sparse[e];return n!==void 0&&t.dense[n]===e};var l=Symbol.for("bitecs_internal");var q=()=>{let t=new Set;return{subscribe:s=>(t.add(s),()=>{t.delete(s)}),notify:(s,...o)=>Array.from(t).reduce((r,a)=>{let i=a(s,...o);return i&&typeof i=="object"?{...r,...i}:r},{})}};var Ge=Symbol("opType"),Je=Symbol("opTerms");function B(t,e,n){let s=t[l],{masks:o,notMasks:r,orMasks:a,generations:i}=e;for(let p=0;p<i.length;p++){let m=i[p],c=o[m],y=r[m],u=a[m],d=s.entityMasks[m][n];if(y&&d&y||c&&(d&c)!==c||u&&!(d&u))return!1}return!0}var V=(t,e)=>{t.toRemove.remove(e),t.addObservable.notify(e),t.add(e)};var H=(t,e,n)=>{let s=t[l];!e.has(n)||e.toRemove.has(n)||(e.toRemove.add(n),s.dirtyQueries.add(e),e.removeObservable.notify(n))};import{observe as ut,onAdd as lt,onRemove as dt,query as ft}from"../core";import{addComponent as Ct,hasComponent as Tt,removeComponent as vt}from"../core";import{addComponent as _,removeComponent as Ie,addEntity as ge,removeEntity as Re,observe as F,onAdd as Z,onRemove as ee}from"../core";var te=(t,e,n,s=new ArrayBuffer(1024*1024*100))=>{let o=new DataView(s),r=0,a=[];return F(t,Z(e),i=>{a.push([i,0,-1])}),F(t,ee(e),i=>{a.push([i,1,-1])}),n.forEach((i,p)=>{F(t,Z(e,i),m=>{a.push([m,2,p])}),F(t,ee(e,i),m=>{a.push([m,3,p])})}),()=>{r=0;for(let i=0;i<a.length;i++){let[p,m,c]=a[i];o.setUint32(r,p),r+=4,o.setUint8(r,m),r+=1,o.setUint8(r,c),r+=1}return a.length=0,s.slice(0,r)}},ne=(t,e,n)=>(s,o=new Map)=>{let r=new DataView(s),a=0;for(;a<s.byteLength;){let i=r.getUint32(a);a+=4;let p=r.getUint8(a);a+=1;let m=r.getUint8(a);a+=1;let c=n[m],y=o.get(i);y===void 0&&(y=ge(t),o.set(i,y)),p===0?_(t,y,e):p===1?Re(t,y):p===2?_(t,y,c):p===3&&Ie(t,y,c)}return o};import{query as pt}from"../core";var he=Symbol("$modifier");var E=Symbol("relation"),g=Symbol("pairTarget"),$=Symbol("isPairComponent"),x=Symbol("relationData"),ie=()=>{let t={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},e=n=>{if(n===void 0)throw Error("Relation target is undefined");let s=n==="*"?f:n;if(!t.pairsMap.has(s)){let o=t.initStore?t.initStore():{};W(o,E,e),W(o,g,s),W(o,$,!0),t.pairsMap.set(s,o)}return t.pairsMap.get(s)};return W(e,x,t),e},oe=t=>e=>{let n=e[x];return n.initStore=t,e},Ae=t=>{let e=t[x];return e.exclusiveRelation=!0,t},re=t=>{let e=t[x];return e.autoRemoveSubject=!0,t},ae=t=>e=>{let n=e[x];return n.onTargetRemoved=t,e};var I=(t,e)=>{if(t===void 0)throw Error("Relation is undefined");return t(e)},f=J(),A=J(),S=(t,e,n)=>{let s=z(t,e),o=[];for(let r of s)r[E]===n&&r[g]!==f&&o.push(r[g]);return o};function J(...t){if(t.length===1&&typeof t[0]=="object"){let{store:e,exclusive:n,autoRemoveSubject:s,onTargetRemoved:o}=t[0];return[e&&oe(e),n&&Ae,s&&re,o&&ae(o)].filter(Boolean).reduce((a,i)=>i(a),ie())}else return t.reduce((n,s)=>s(n),ie())}var w={};var z=(t,e)=>{let n=t[l];if(e===void 0)throw new Error("bitECS - entity is undefined.");if(!L(n.entityIndex,e))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(e))},N=(t,e)=>L(t[l].entityIndex,e);var G=(t,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");let n=t[l],s=new Set,o={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:e,queries:s,setObservable:q(),getObservable:q()};return n.componentMap.set(e,o),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),o};var v=(t,e,n)=>{let s=t[l],o=s.componentMap.get(n);if(!o)return!1;let{generationId:r,bitflag:a}=o;return(s.entityMasks[r][e]&a)===a},se=(t,e,n)=>{let o=t[l].componentMap.get(n);if(o&&v(t,e,n))return o.getObservable.notify(e)};var pe=(t,e,n)=>{let s=t[l];R(t,e,A(n));let o=z(t,n);for(let a of o){if(a===w)continue;R(t,e,a);let i=s.componentMap.get(a);if(i&&i.setObservable){let p=se(t,n,a);i.setObservable.notify(e,p)}}let r=S(t,n,A);for(let a of r)pe(t,e,a)},R=(t,e,...n)=>{let s=t[l];if(!N(t,e))throw new Error(`Cannot add component - entity ${e} does not exist in the world.`);n.forEach(o=>{let r="component"in o?o.component:o,a="data"in o?o.data:void 0;if(s.componentMap.has(r)||G(t,r),v(t,e,r))return;let i=s.componentMap.get(r),{generationId:p,bitflag:m,queries:c}=i;if(s.entityMasks[p][e]|=m,v(t,e,w)||c.forEach(y=>{y.toRemove.remove(e),B(t,y,e)?V(y,e):H(t,y,e)}),s.entityComponents.get(e).add(r),a!==void 0&&i.setObservable.notify(e,a),r[$]){let y=r[E];R(t,e,I(y,f));let u=r[g];if(R(t,e,I(f,u)),y[x].exclusiveRelation===!0&&u!==f){let h=S(t,e,y)[0];h!=null&&h!==u&&K(t,e,y(h))}if(y===A){let h=S(t,e,A);for(let me of h)pe(t,e,me)}}})};var K=(t,e,...n)=>{let s=t[l];if(!N(t,e))throw new Error(`Cannot remove component - entity ${e} does not exist in the world.`);n.forEach(o=>{if(!v(t,e,o))return;let r=s.componentMap.get(o),{generationId:a,bitflag:i,queries:p}=r;if(s.entityMasks[a][e]&=~i,p.forEach(m=>{m.toRemove.remove(e),B(t,m,e)?V(m,e):H(t,m,e)}),s.entityComponents.get(e).delete(o),o[$]){let m=o[g];K(t,e,I(f,m));let c=o[E];S(t,e,c).length===0&&K(t,e,I(c,f))}})};import{getAllEntities as Se,addEntity as Ee}from"../core";var Oe=(t,e,n=new ArrayBuffer(1024*1024*100))=>{let s=new DataView(n),o=0,r=i=>{let p=i.length;s.setUint32(o,p),o+=4;for(let m=0;m<p;m++){let c=i[m],y=0;s.setUint32(o,c),o+=4;let u=o;o+=1;for(let d=0;d<e.length;d++)v(t,c,e[d])&&(s.setUint8(o,d),o+=1,y++);s.setUint8(u,y)}},a=i=>{let m=P(e,n.slice(o))(i);new Uint8Array(n).set(new Uint8Array(m),o),o+=m.byteLength};return()=>{o=0;let i=Se(t);return r(i),a(i),n.slice(0,o)}},Qe=(t,e)=>{let n=j(e);return s=>{let o=new DataView(s),r=0,a=new Map,i=o.getUint32(r);r+=4;for(let p=0;p<i;p++){let m=o.getUint32(r);r+=4;let c=Ee(t);a.set(m,c);let y=o.getUint8(r);r+=1;for(let u=0;u<y;u++){let d=o.getUint8(r);r+=1,R(t,c,e[d])}}return n(s.slice(r),a),a}};export{ne as createObserverDeserializer,te as createObserverSerializer,Qe as createSnapshotDeserializer,Oe as createSnapshotSerializer,j as createSoADeserializer,P as createSoASerializer,be as f32,xe as f64,le as i16,fe as i32,ce as i8,ue as u16,de as u32,ye as u8};
//# sourceMappingURL=index.min.mjs.map
