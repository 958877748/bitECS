var F=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var he=Object.prototype.hasOwnProperty;var We=(e,t)=>{for(var n in t)F(e,n,{get:t[n],enumerable:!0})},Oe=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ce(t))!he.call(e,r)&&r!==n&&F(e,r,{get:()=>t[r],enumerable:!(o=ge(t,r))||o.enumerable});return e};var Ie=e=>Oe(F({},"__esModule",{value:!0}),e);var Se={};We(Se,{$internal:()=>c,$isPairComponent:()=>M,$pairTarget:()=>x,$relation:()=>g,$relationData:()=>b,IsA:()=>S,Not:()=>oe,Pair:()=>C,Prefab:()=>I,Wildcard:()=>y,addComponent:()=>h,addComponents:()=>de,addEntity:()=>ye,addEntityId:()=>B,commitRemovals:()=>V,createEntityIndex:()=>D,createRelation:()=>G,createWorld:()=>X,entityExists:()=>q,getAllEntities:()=>_,getEntityComponents:()=>A,getRelationTargets:()=>k,getWorldComponents:()=>Z,hasComponent:()=>O,innerQuery:()=>H,isEntityIdAlive:()=>j,makeExclusive:()=>pe,observe:()=>ne,onAdd:()=>ee,onRemove:()=>te,pipe:()=>be,query:()=>re,registerComponent:()=>T,registerComponents:()=>ue,registerQuery:()=>U,removeComponent:()=>R,removeComponents:()=>fe,removeEntity:()=>J,removeEntityId:()=>z,removeQuery:()=>se,resetWorld:()=>Y,withAutoRemove:()=>ce,withOnRemove:()=>me,withStore:()=>ie});module.exports=Ie(Se);var v=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var D=()=>({aliveCount:0,dense:[],sparse:[],maxId:0}),B=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},z=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let o=n,r=e.aliveCount-1,s=e.dense[r];e.sparse[s]=o,e.dense[o]=s,e.sparse[t]=e.dense.length,e.dense[r]=t,e.aliveCount--},j=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var c=Symbol("internal"),Me=e=>{let t={entityIndex:D(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new WeakMap,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set},n=e||{};return v(n,c,t),n},Ee=e=>t=>{let n=t[c];return n.entityIndex=e,t};var X=(...e)=>{let t=s=>{let i,a=[];return s.forEach(p=>{if(typeof p=="object"&&!Array.isArray(p)&&!(p instanceof Function)){let{entityIndex:u,context:d}=p;u&&a.push(Ee(u)),d&&(i=d)}else typeof p=="function"&&a.push(p)}),{context:i,modifiers:a}},{context:n,modifiers:o}=t(e),r=Me(n);return o.reduce((s,i)=>i(s),r)},Y=e=>{let t=e[c];return t.entityIndex=D(),t.entityMasks=[[]],t.entityComponents=new Map,t.bitflag=1,t.componentMap=new Map,t.componentCount=0,t.queries=new Set,t.queriesHashMap=new Map,t.notQueries=new Set,t.dirtyQueries=new Set,e},Z=e=>Object.keys(e[c].componentMap),_=e=>e[c].entityIndex.dense.slice(0);var K=()=>{let e=[],t=[],n=i=>e[t[i]]===i;return{add:i=>{n(i)||(t[i]=e.push(i)-1)},remove:i=>{if(!n(i))return;let a=t[i],p=e.pop();p!==i&&(e[a]=p,t[p]=a)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}};var $=()=>{let e=new Set;return{subscribe:o=>(e.add(o),()=>{e.delete(o)}),notify:(o,...r)=>{e.forEach(s=>s(o,...r))}}};var ee=(...e)=>({type:"add",components:e}),te=(...e)=>({type:"remove",components:e});var ne=(e,t,n)=>{let o=e[c],{type:r,components:s}=t,i=N(e,s),a=o.queriesHashMap.get(i);return a||(a=U(e,s)),a[r==="add"?"addObservable":r==="remove"?"removeObservable":"setObservable"].subscribe(n)};var oe=(...e)=>({type:"Not",components:e});var N=(e,t)=>{let n=e[c],o=s=>(n.componentMap.has(s)||T(e,s),n.componentMap.get(s).id),r=s=>{if("type"in s){let i=s.components.map(o).sort((a,p)=>a-p);return`${s.type}(${i.join(",")})`}else return o(s).toString()};return t.map(r).sort().join("-")},U=(e,t)=>{let n=e[c],o=N(e,t);if(n.queriesHashMap.has(o))return n.queriesHashMap.get(o);let r=[],s=[];t.forEach(m=>{m.type==="Not"?m.components.forEach(l=>{n.componentMap.has(l)||T(e,l),s.push(l)}):(n.componentMap.has(m)||T(e,m),r.push(m))});let i=m=>n.componentMap.get(m),a=r.concat(s).map(i),p=K(),u=K(),d=a.map(m=>m.generationId).reduce((m,l)=>(m.includes(l)||m.push(l),m),[]),f=(m,l)=>(m[l.generationId]||(m[l.generationId]=0),m[l.generationId]|=l.bitflag,m),w=r.map(i).reduce(f,{}),xe=s.map(i).reduce(f,{}),Re=a.reduce(f,{}),ve=$(),Te=$(),W=Object.assign(p,{components:r,notComponents:s,allComponents:a,masks:w,notMasks:xe,hasMasks:Re,generations:d,toRemove:u,addObservable:ve,removeObservable:Te});n.queries.add(W),n.queriesHashMap.set(o,W),a.forEach(m=>{m.queries.add(W)}),s.length&&n.notQueries.add(W);let L=n.entityIndex;for(let m=0;m<L.aliveCount;m++){let l=L.dense[m];if(O(e,I,l))continue;E(e,W,l)&&Q(W,l)}return W};function H(e,t){let n=e[c],o=N(e,t),r=n.queriesHashMap.get(o);return r||(r=U(e,t)),r.dense}function re(e,t){return V(e),H(e,t)}var E=(e,t,n)=>{let o=e[c],{masks:r,notMasks:s,generations:i}=t;for(let a=0;a<i.length;a++){let p=i[a],u=r[p],d=s[p],f=o.entityMasks[p][n];if(d&&f&d||u&&(f&u)!==u)return!1}return!0};var Q=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},Qe=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},V=e=>{let t=e[c];t.dirtyQueries.size&&(t.dirtyQueries.forEach(Qe),t.dirtyQueries.clear())},P=(e,t,n)=>{let o=e[c];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),o.dirtyQueries.add(t),t.removeObservable.notify(n))},se=(e,t)=>{let n=e[c],o=N(e,t),r=n.queriesHashMap.get(o);r&&(n.queries.delete(r),n.queriesHashMap.delete(o))};var g=Symbol("relation"),x=Symbol("pairTarget"),M=Symbol("isPairComponent"),b=Symbol("internal"),ae=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let o=n==="*"?y:n;if(!e.pairsMap.has(o)){let r={};v(r,g,t),v(r,x,o),v(r,M,!0),e.pairsMap.set(o,r)}return e.pairsMap.get(o)};return v(t,b,e),t},ie=e=>t=>{let n=t[b];return n.initStore=e,o=>{if(o===void 0)throw Error("Relation target is undefined");let r=o==="*"?y:o;if(!n.pairsMap.has(r)){let s=e();v(s,b,{pairTarget:r,...n}),n.pairsMap.set(r,s)}return n.pairsMap.get(r)}},pe=e=>{let t=e[b];return t.exclusiveRelation=!0,e},ce=e=>{let t=e[b];return t.autoRemoveSubject=!0,e},me=e=>t=>{let n=t[b];return n.onTargetRemoved=e,t};var C=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},y=G(),S=G(),k=(e,t,n)=>{let o=A(e,n),r=[];for(let s of o)s[g]===t&&s[x]!==y&&r.push(s[x]);return r};function G(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:o,onTargetRemoved:r}=e[0];return[t&&ie(t),n&&pe,o&&ce,r&&me(r)].filter(Boolean).reduce((i,a)=>a(i),ae())}else return e.reduce((n,o)=>o(n),ae())}var T=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[c],o=new Set,r={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:o,setObservable:$()};return n.componentMap.set(t,r),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),r},ue=(e,t)=>{t.forEach(n=>T(e,n))},O=(e,t,n)=>{let o=e[c],r=o.componentMap.get(t);if(!r)return!1;let{generationId:s,bitflag:i}=r;return(o.entityMasks[s][n]&i)===i},le=(e,t,n)=>{h(e,S(n),t);let o=A(e,n);for(let s of o){if(s===I)continue;h(e,s,t);let i=Object.keys(s);for(let a of i)s[a][t]=s[a][n]}let r=k(e,S,n);for(let s of r)le(e,t,s)},h=(e,t,n)=>{let o=e[c];if(!q(e,n))throw new Error("bitECS - entity does not exist in the world.");if(o.componentMap.has(t)||T(e,t),O(e,t,n))return;let r=o.componentMap.get(t),{generationId:s,bitflag:i,queries:a}=r;if(o.entityMasks[s][n]|=i,O(e,I,n)||a.forEach(p=>{p.toRemove.remove(n),E(e,p,n)?Q(p,n):P(e,p,n)}),o.entityComponents.get(n).add(t),t[M]){let p=t[g];h(e,C(p,y),n);let u=t[x];if(h(e,C(y,u),n),p[b].exclusiveRelation===!0&&u!==y){let f=k(e,p,n)[0];f!=null&&f!==u&&R(e,p(f),n)}if(p===S){let f=k(e,S,n);for(let w of f)le(e,n,w)}}},de=(e,t,n)=>{t.forEach(o=>h(e,o,n))},R=(e,t,n)=>{let o=e[c];if(!q(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!O(e,t,n))return;let r=o.componentMap.get(t),{generationId:s,bitflag:i,queries:a}=r;if(o.entityMasks[s][n]&=~i,a.forEach(p=>{p.toRemove.remove(n),E(e,p,n)?Q(p,n):P(e,p,n)}),o.entityComponents.get(n).delete(t),t[M]){let p=t[x];R(e,C(y,p),n);let u=t[g];k(e,u,n).length===0&&R(e,C(u,y),n)}},fe=(e,t,n)=>{t.forEach(o=>R(e,o,n))};var I={};var ye=e=>{let t=e[c],n=B(t.entityIndex);return t.notQueries.forEach(o=>{E(e,o,n)&&Q(o,n)}),t.entityComponents.set(n,new Set),n},J=(e,t)=>{let n=e[c];if(!j(n.entityIndex,t))return;let o=[t],r=new Set;for(;o.length>0;){let s=o.shift();if(r.has(s))continue;r.add(s);let i=[];for(let a of H(e,[y(s)]))if(q(e,a))for(let p of n.entityComponents.get(a)){if(!p[M])continue;let d=p[g][b];i.push(()=>R(e,C(y,s),a)),p[x]===s&&(i.push(()=>R(e,p,a)),d.autoRemoveSubject&&o.push(a),d.onTargetRemoved&&i.push(()=>d.onTargetRemoved(e,a,s)))}for(let a of i)a();for(let a of o)J(e,a);for(let a of n.queries)P(e,a,s);z(n.entityIndex,s),n.entityComponents.delete(s);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][s]=0}},A=(e,t)=>{let n=e[c];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!j(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},q=(e,t)=>j(e[c].entityIndex,t);var be=(...e)=>(...t)=>e.reduce((n,o)=>[o(...n)],t)[0];
//# sourceMappingURL=index.min.cjs.map
