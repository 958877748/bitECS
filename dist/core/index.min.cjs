var K=Object.defineProperty;var je=Object.getOwnPropertyDescriptor;var $e=Object.getOwnPropertyNames;var Pe=Object.prototype.hasOwnProperty;var De=(e,t)=>{for(var n in t)K(e,n,{get:t[n],enumerable:!0})},He=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of $e(t))!Pe.call(e,s)&&s!==n&&K(e,s,{get:()=>t[s],enumerable:!(o=je(t,s))||o.enumerable});return e};var Ne=e=>He(K({},"__esModule",{value:!0}),e);var Fe={};De(Fe,{$internal:()=>u,$isPairComponent:()=>M,$pairTarget:()=>x,$relation:()=>T,$relationData:()=>b,All:()=>de,And:()=>J,Any:()=>le,IsA:()=>k,None:()=>fe,Not:()=>X,Or:()=>G,Pair:()=>g,Prefab:()=>I,Wildcard:()=>f,addComponent:()=>h,addComponents:()=>We,addEntity:()=>Ie,commitRemovals:()=>Y,createEntityIndex:()=>P,createRelation:()=>Z,createWorld:()=>re,entityExists:()=>j,getAllEntities:()=>ie,getEntityComponents:()=>q,getRelationTargets:()=>A,getWorldComponents:()=>ae,hasComponent:()=>O,innerQuery:()=>N,makeExclusive:()=>Ce,observe:()=>ue,onAdd:()=>ce,onRemove:()=>me,pipe:()=>Me,query:()=>ye,registerComponent:()=>v,registerComponents:()=>ge,registerQuery:()=>H,removeComponent:()=>R,removeComponents:()=>Oe,removeEntity:()=>_,removeQuery:()=>be,resetWorld:()=>se,withAutoRemove:()=>ve,withContext:()=>oe,withEntityIndex:()=>V,withOnRemove:()=>Te,withStore:()=>Re});module.exports=Ne(Fe);var C=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var P=()=>({aliveCount:0,dense:[],sparse:[],maxId:0}),te=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},ne=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let o=n,s=e.aliveCount-1,r=e.dense[s];e.sparse[r]=o,e.dense[o]=r,e.sparse[t]=e.dense.length,e.dense[s]=t,e.aliveCount--},B=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var u=Symbol("internal"),Ue=e=>{let t={entityIndex:P(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new WeakMap,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set},n=e||{};return C(n,u,t),n},V=e=>t=>{let n=t[u];return n.entityIndex=e,t},oe=e=>t=>Object.assign(e,t),re=(...e)=>{let t=r=>{let p,i=[];return r.forEach(a=>{if(typeof a=="object"&&!Array.isArray(a)&&!(a instanceof Function)){let{entityIndex:c,context:l}=a;c&&i.push(V(c)),l&&(p=l)}else typeof a=="function"&&i.push(a)}),{context:p,modifiers:i}},{context:n,modifiers:o}=t(e),s=Ue(n);return o.reduce((r,p)=>p(r),s)},se=e=>{let t=e[u];return t.entityIndex=P(),t.entityMasks=[[]],t.entityComponents=new Map,t.bitflag=1,t.componentMap=new Map,t.componentCount=0,t.queries=new Set,t.queriesHashMap=new Map,t.notQueries=new Set,t.dirtyQueries=new Set,e},ae=e=>Object.keys(e[u].componentMap),ie=e=>e[u].entityIndex.dense.slice(0);var L=()=>{let e=[],t=[],n=p=>e[t[p]]===p;return{add:p=>{n(p)||(t[p]=e.push(p)-1)},remove:p=>{if(!n(p))return;let i=t[p],a=e.pop();a!==p&&(e[i]=a,t[a]=i)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},pe=(e=1e3)=>{let t=[],n=0,o=new Uint32Array(e),s=a=>a<t.length&&t[a]<n&&o[t[a]]===a;return{add:a=>{if(!s(a)){if(n>=o.length){let c=new Uint32Array(o.length*2);c.set(o),o=c}o[n]=a,t[a]=n,n++}},remove:a=>{if(!s(a))return;n--;let c=t[a],l=o[n];o[c]=l,t[l]=c},has:s,sparse:t,get dense(){return new Uint32Array(o.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var D=()=>{let e=new Set;return{subscribe:o=>(e.add(o),()=>{e.delete(o)}),notify:(o,...s)=>{e.forEach(r=>r(o,...s))}}};var ce=(...e)=>({type:"add",components:e}),me=(...e)=>({type:"remove",components:e});var ue=(e,t,n)=>{let o=e[u],{type:s,components:r}=t,p=z(e,r),i=o.queriesHashMap.get(p);return i||(i=H(e,r)),i[s==="add"?"addObservable":s==="remove"?"removeObservable":"setObservable"].subscribe(n)},G=(...e)=>({type:"Or",components:e}),J=(...e)=>({type:"And",components:e}),X=(...e)=>({type:"Not",components:e}),le=G,de=J,fe=X,z=(e,t)=>{let n=e[u],o=r=>(n.componentMap.has(r)||v(e,r),n.componentMap.get(r).id),s=r=>{if("type"in r){let i=r.components.map(o).sort((c,l)=>c-l);return`${r.type.toLowerCase()}(${i.join(",")})`}else return o(r).toString()};return t.map(s).sort().join("-")},H=(e,t,n={})=>{let o=e[u],s=z(e,t),r=[],p=[],i=[],a=(m,d)=>{m.forEach(F=>{o.componentMap.has(F)||v(e,F),d.push(F)})};t.forEach(m=>{"type"in m?m.type==="Not"?a(m.components,p):m.type==="Or"&&a(m.components,i):(o.componentMap.has(m)||v(e,m),r.push(m))});let c=m=>o.componentMap.get(m),l=r.concat(p).concat(i.flat()).map(c),y=n.buffered?pe():L(),E=L(),$=l.map(m=>m.generationId).reduce((m,d)=>(m.includes(d)||m.push(d),m),[]),w=(m,d)=>(m[d.generationId]||(m[d.generationId]=0),m[d.generationId]|=d.bitflag,m),Ee=r.map(c).reduce(w,{}),Qe=p.map(c).reduce(w,{}),Se=i.map(c).reduce(w,{}),ke=l.reduce(w,{}),Ae=D(),qe=D(),W=Object.assign(y,{components:r,notComponents:p,orComponents:i,allComponents:l,masks:Ee,notMasks:Qe,orMasks:Se,hasMasks:ke,generations:$,toRemove:E,addObservable:Ae,removeObservable:qe});o.queries.add(W),o.queriesHashMap.set(s,W),l.forEach(m=>{m.queries.add(W)}),p.length&&o.notQueries.add(W);let ee=o.entityIndex;for(let m=0;m<ee.aliveCount;m++){let d=ee.dense[m];if(O(e,I,d))continue;Q(e,W,d)&&S(W,d)}return W};function N(e,t,n={}){let o=e[u],s=z(e,t),r=o.queriesHashMap.get(s);return r?n.buffered&&!("buffer"in r.dense)&&(r=H(e,t,{buffered:!0})):r=H(e,t,n),r.dense}function ye(e,t){return Y(e),N(e,t)}function Q(e,t,n){let o=e[u],{masks:s,notMasks:r,orMasks:p,generations:i}=t;for(let a=0;a<i.length;a++){let c=i[a],l=s[c],y=r[c],E=p[c],$=o.entityMasks[c][n];if(y&&$&y||l&&($&l)!==l||E&&!($&E))return!1}return!0}var S=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},we=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},Y=e=>{let t=e[u];t.dirtyQueries.size&&(t.dirtyQueries.forEach(we),t.dirtyQueries.clear())},U=(e,t,n)=>{let o=e[u];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),o.dirtyQueries.add(t),t.removeObservable.notify(n))},be=(e,t)=>{let n=e[u],o=z(e,t),s=n.queriesHashMap.get(o);s&&(n.queries.delete(s),n.queriesHashMap.delete(o))};var T=Symbol("relation"),x=Symbol("pairTarget"),M=Symbol("isPairComponent"),b=Symbol("relationData"),xe=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let o=n==="*"?f:n;if(!e.pairsMap.has(o)){let s={};C(s,T,t),C(s,x,o),C(s,M,!0),e.pairsMap.set(o,s)}return e.pairsMap.get(o)};return C(t,b,e),t},Re=e=>t=>{let n=t[b];return n.initStore=e,o=>{if(o===void 0)throw Error("Relation target is undefined");let s=o==="*"?f:o;if(!n.pairsMap.has(s)){let r=e();C(r,b,{pairTarget:s,...n}),n.pairsMap.set(s,r)}return n.pairsMap.get(s)}},Ce=e=>{let t=e[b];return t.exclusiveRelation=!0,e},ve=e=>{let t=e[b];return t.autoRemoveSubject=!0,e},Te=e=>t=>{let n=t[b];return n.onTargetRemoved=e,t};var g=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},f=Z(),k=Z(),A=(e,t,n)=>{let o=q(e,n),s=[];for(let r of o)r[T]===t&&r[x]!==f&&s.push(r[x]);return s};function Z(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:o,onTargetRemoved:s}=e[0];return[t&&Re(t),n&&Ce,o&&ve,s&&Te(s)].filter(Boolean).reduce((p,i)=>i(p),xe())}else return e.reduce((n,o)=>o(n),xe())}var v=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[u],o=new Set,s={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:o,setObservable:D()};return n.componentMap.set(t,s),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),s},ge=(e,t)=>{t.forEach(n=>v(e,n))},O=(e,t,n)=>{let o=e[u],s=o.componentMap.get(t);if(!s)return!1;let{generationId:r,bitflag:p}=s;return(o.entityMasks[r][n]&p)===p},he=(e,t,n)=>{h(e,k(n),t);let o=q(e,n);for(let r of o){if(r===I)continue;h(e,r,t);let p=Object.keys(r);for(let i of p)r[i][t]=r[i][n]}let s=A(e,k,n);for(let r of s)he(e,t,r)},h=(e,t,n)=>{let o=e[u];if(!j(e,n))throw new Error("bitECS - entity does not exist in the world.");if(o.componentMap.has(t)||v(e,t),O(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:p,queries:i}=s;if(o.entityMasks[r][n]|=p,O(e,I,n)||i.forEach(a=>{a.toRemove.remove(n),Q(e,a,n)?S(a,n):U(e,a,n)}),o.entityComponents.get(n).add(t),t[M]){let a=t[T];h(e,g(a,f),n);let c=t[x];if(h(e,g(f,c),n),a[b].exclusiveRelation===!0&&c!==f){let y=A(e,a,n)[0];y!=null&&y!==c&&R(e,a(y),n)}if(a===k){let y=A(e,k,n);for(let E of y)he(e,n,E)}}},We=(e,t,n)=>{t.forEach(o=>h(e,o,n))},R=(e,t,n)=>{let o=e[u];if(!j(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!O(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:p,queries:i}=s;if(o.entityMasks[r][n]&=~p,i.forEach(a=>{a.toRemove.remove(n),Q(e,a,n)?S(a,n):U(e,a,n)}),o.entityComponents.get(n).delete(t),t[M]){let a=t[x];R(e,g(f,a),n);let c=t[T];A(e,c,n).length===0&&R(e,g(c,f),n)}},Oe=(e,t,n)=>{t.forEach(o=>R(e,o,n))};var I={};var Ie=e=>{let t=e[u],n=te(t.entityIndex);return t.notQueries.forEach(o=>{Q(e,o,n)&&S(o,n)}),t.entityComponents.set(n,new Set),n},_=(e,t)=>{let n=e[u];if(!B(n.entityIndex,t))return;let o=[t],s=new Set;for(;o.length>0;){let r=o.shift();if(s.has(r))continue;s.add(r);let p=[];for(let i of N(e,[f(r)]))if(j(e,i))for(let a of n.entityComponents.get(i)){if(!a[M])continue;let l=a[T][b];p.push(()=>R(e,g(f,r),i)),a[x]===r&&(p.push(()=>R(e,a,i)),l.autoRemoveSubject&&o.push(i),l.onTargetRemoved&&p.push(()=>l.onTargetRemoved(e,i,r)))}for(let i of p)i();for(let i of o)_(e,i);for(let i of n.queries)U(e,i,r);ne(n.entityIndex,r),n.entityComponents.delete(r);for(let i=0;i<n.entityMasks.length;i++)n.entityMasks[i][r]=0}},q=(e,t)=>{let n=e[u];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!B(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},j=(e,t)=>B(e[u].entityIndex,t);var Me=(...e)=>(...t)=>e.reduce((n,o)=>[o(...n)],t)[0];
//# sourceMappingURL=index.min.cjs.map
