var x=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var K=()=>({aliveCount:0,dense:[],sparse:[],maxId:0}),X=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},Y=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let o=n,s=e.aliveCount-1,r=e.dense[s];e.sparse[r]=o,e.dense[o]=r,e.sparse[t]=e.dense.length,e.dense[s]=t,e.aliveCount--},B=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var l=Symbol("internal"),Z=e=>{let t={entityIndex:K(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new WeakMap,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set},n=e||{};return x(n,l,t),n},_=e=>t=>{let n=t[l];return n.entityIndex=e,t},ee=e=>t=>{let n=t[l];return Object.assign(e,t),x(e,l,n),e};function Te(e,...t){if(typeof e=="object"&&e!==null&&!Array.isArray(e)){let{context:n,entityIndex:o}=e,s=Z();return n&&(s=ee(n)(s)),o&&(s=_(o)(s)),s}else{let n=typeof e=="function"?[e,...t]:t,o=Z();return n.reduce((s,r)=>r(s),o)}}var Ce=e=>{let t=e[l];return t.entityIndex=K(),t.entityMasks=[[]],t.entityComponents=new Map,t.bitflag=1,t.componentMap=new Map,t.componentCount=0,t.queries=new Set,t.queriesHashMap=new Map,t.notQueries=new Set,t.dirtyQueries=new Set,e},ge=e=>{delete e[l]},ve=e=>Object.keys(e[l].componentMap),he=e=>e[l].entityIndex.dense.slice(0);var L=()=>{let e=[],t=[],n=p=>e[t[p]]===p;return{add:p=>{n(p)||(t[p]=e.push(p)-1)},remove:p=>{if(!n(p))return;let i=t[p],a=e.pop();a!==p&&(e[i]=a,t[a]=i)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},te=(e=1e3)=>{let t=[],n=0,o=new Uint32Array(e),s=a=>a<t.length&&t[a]<n&&o[t[a]]===a;return{add:a=>{if(!s(a)){if(n>=o.length){let m=new Uint32Array(o.length*2);m.set(o),o=m}o[n]=a,t[a]=n,n++}},remove:a=>{if(!s(a))return;n--;let m=t[a],u=o[n];o[m]=u,t[u]=m},has:s,sparse:t,get dense(){return new Uint32Array(o.buffer,0,n)},reset:()=>{n=0,t.length=0}}};var P=()=>{let e=new Set;return{subscribe:o=>(e.add(o),()=>{e.delete(o)}),notify:(o,...s)=>{e.forEach(r=>r(o,...s))}}};var R=Symbol("opType"),T=Symbol("opComponents"),We=(...e)=>({[R]:"add",[T]:e}),Ie=(...e)=>({[R]:"remove",[T]:e});var Oe=(e,t,n)=>{let o=e[l],{[R]:s,[T]:r}=t,p=z(e,r),i=o.queriesHashMap.get(p);return i||(i=F(e,r)),i[s==="add"?"addObservable":s==="remove"?"removeObservable":"setObservable"].subscribe(n)},ne=(...e)=>({[R]:"Or",[T]:e}),oe=(...e)=>({[R]:"And",[T]:e}),re=(...e)=>({[R]:"Not",[T]:e}),Ee=ne,Se=oe,Me=re,z=(e,t)=>{let n=e[l],o=r=>(n.componentMap.has(r)||I(e,r),n.componentMap.get(r).id),s=r=>{if("type"in r){let i=r.components.map(o).sort((m,u)=>m-u);return`${r.type.toLowerCase()}(${i.join(",")})`}else return o(r).toString()};return t.map(s).sort().join("-")},F=(e,t,n={})=>{let o=e[l],s=z(e,t),r=[],p=[],i=[],a=(c,d)=>{c.forEach(w=>{o.componentMap.has(w)||I(e,w),d.push(w)})};t.forEach(c=>{R in c?c[R]==="Not"?a(c[T],p):c[R]==="Or"&&a(c[T],i):(o.componentMap.has(c)||I(e,c),r.push(c))});let m=c=>o.componentMap.get(c),u=r.concat(p).concat(i.flat()).map(m),y=n.buffered?te():L(),S=L(),q=u.map(c=>c.generationId).reduce((c,d)=>(c.includes(d)||c.push(d),c),[]),U=(c,d)=>(c[d.generationId]||(c[d.generationId]=0),c[d.generationId]|=d.bitflag,c),de=r.map(m).reduce(U,{}),fe=p.map(m).reduce(U,{}),ye=i.map(m).reduce(U,{}),be=u.reduce(U,{}),xe=P(),Re=P(),W=Object.assign(y,{components:r,notComponents:p,orComponents:i,allComponents:u,masks:de,notMasks:fe,orMasks:ye,hasMasks:be,generations:q,toRemove:S,addObservable:xe,removeObservable:Re});o.queries.add(W),o.queriesHashMap.set(s,W),u.forEach(c=>{c.queries.add(W)}),p.length&&o.notQueries.add(W);let J=o.entityIndex;for(let c=0;c<J.aliveCount;c++){let d=J.dense[c];if(k(e,O,d))continue;M(e,W,d)&&Q(W,d)}return W};function V(e,t,n={}){let o=e[l],s=z(e,t),r=o.queriesHashMap.get(s);return r?n.buffered&&!("buffer"in r.dense)&&(r=F(e,t,{buffered:!0})):r=F(e,t,n),r.dense}function Qe(e,t){return se(e),V(e,t)}function M(e,t,n){let o=e[l],{masks:s,notMasks:r,orMasks:p,generations:i}=t;for(let a=0;a<i.length;a++){let m=i[a],u=s[m],y=r[m],S=p[m],q=o.entityMasks[m][n];if(y&&q&y||u&&(q&u)!==u||S&&!(q&S))return!1}return!0}var Q=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},ke=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},se=e=>{let t=e[l];t.dirtyQueries.size&&(t.dirtyQueries.forEach(ke),t.dirtyQueries.clear())},D=(e,t,n)=>{let o=e[l];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),o.dirtyQueries.add(t),t.removeObservable.notify(n))},Ae=(e,t)=>{let n=e[l],o=z(e,t),s=n.queriesHashMap.get(o);s&&(n.queries.delete(s),n.queriesHashMap.delete(o))};var E=Symbol("relation"),C=Symbol("pairTarget"),A=Symbol("isPairComponent"),b=Symbol("relationData"),ae=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let o=n==="*"?f:n;if(!e.pairsMap.has(o)){let s={};x(s,E,t),x(s,C,o),x(s,A,!0),e.pairsMap.set(o,s)}return e.pairsMap.get(o)};return x(t,b,e),t},ie=e=>t=>{let n=t[b];return n.initStore=e,o=>{if(o===void 0)throw Error("Relation target is undefined");let s=o==="*"?f:o;if(!n.pairsMap.has(s)){let r=e();x(r,b,{pairTarget:s,...n}),n.pairsMap.set(s,r)}return n.pairsMap.get(s)}},je=e=>{let t=e[b];return t.exclusiveRelation=!0,e},pe=e=>{let t=e[b];return t.autoRemoveSubject=!0,e},ce=e=>t=>{let n=t[b];return n.onTargetRemoved=e,t};var g=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},f=G(),j=G(),$=(e,t,n)=>{let o=H(e,n),s=[];for(let r of o)r[E]===t&&r[C]!==f&&s.push(r[C]);return s};function G(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:o,onTargetRemoved:s}=e[0];return[t&&ie(t),n&&je,o&&pe,s&&ce(s)].filter(Boolean).reduce((p,i)=>i(p),ae())}else return e.reduce((n,o)=>o(n),ae())}var I=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[l],o=new Set,s={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:o,setObservable:P()};return n.componentMap.set(t,s),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),s},$e=(e,t)=>{t.forEach(n=>I(e,n))},k=(e,t,n)=>{let o=e[l],s=o.componentMap.get(t);if(!s)return!1;let{generationId:r,bitflag:p}=s;return(o.entityMasks[r][n]&p)===p},me=(e,t,n)=>{v(e,j(n),t);let o=H(e,n);for(let r of o){if(r===O)continue;v(e,r,t);let p=Object.keys(r);for(let i of p)r[i][t]=r[i][n]}let s=$(e,j,n);for(let r of s)me(e,t,r)},v=(e,t,n)=>{let o=e[l];if(!N(e,n))throw new Error("bitECS - entity does not exist in the world.");if(o.componentMap.has(t)||I(e,t),k(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:p,queries:i}=s;if(o.entityMasks[r][n]|=p,k(e,O,n)||i.forEach(a=>{a.toRemove.remove(n),M(e,a,n)?Q(a,n):D(e,a,n)}),o.entityComponents.get(n).add(t),t[A]){let a=t[E];v(e,g(a,f),n);let m=t[C];if(v(e,g(f,m),n),a[b].exclusiveRelation===!0&&m!==f){let y=$(e,a,n)[0];y!=null&&y!==m&&h(e,a(y),n)}if(a===j){let y=$(e,j,n);for(let S of y)me(e,n,S)}}},qe=(e,t,n)=>{t.forEach(o=>v(e,o,n))},h=(e,t,n)=>{let o=e[l];if(!N(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!k(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:p,queries:i}=s;if(o.entityMasks[r][n]&=~p,i.forEach(a=>{a.toRemove.remove(n),M(e,a,n)?Q(a,n):D(e,a,n)}),o.entityComponents.get(n).delete(t),t[A]){let a=t[C];h(e,g(f,a),n);let m=t[E];$(e,m,n).length===0&&h(e,g(m,f),n)}},Pe=(e,t,n)=>{t.forEach(o=>h(e,o,n))};var O={},De=e=>{let t=le(e);return v(e,O,t),t},le=e=>{let t=e[l],n=X(t.entityIndex);return t.notQueries.forEach(o=>{M(e,o,n)&&Q(o,n)}),t.entityComponents.set(n,new Set),n},ue=(e,t)=>{let n=e[l];if(!B(n.entityIndex,t))return;let o=[t],s=new Set;for(;o.length>0;){let r=o.shift();if(s.has(r))continue;s.add(r);let p=[];for(let i of V(e,[f(r)]))if(N(e,i))for(let a of n.entityComponents.get(i)){if(!a[A])continue;let u=a[E][b];p.push(()=>h(e,g(f,r),i)),a[C]===r&&(p.push(()=>h(e,a,i)),u.autoRemoveSubject&&o.push(i),u.onTargetRemoved&&p.push(()=>u.onTargetRemoved(e,i,r)))}for(let i of p)i();for(let i of o)ue(e,i);for(let i of n.queries)D(e,i,r);Y(n.entityIndex,r),n.entityComponents.delete(r);for(let i=0;i<n.entityMasks.length;i++)n.entityMasks[i][r]=0}},H=(e,t)=>{let n=e[l];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!B(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},N=(e,t)=>B(e[l].entityIndex,t);var He=(...e)=>(...t)=>e.reduce((n,o)=>[o(...n)],t)[0];export{l as $internal,Se as All,oe as And,Ee as Any,j as IsA,Me as None,re as Not,ne as Or,g as Pair,O as Prefab,f as Wildcard,v as addComponent,qe as addComponents,le as addEntity,De as addPrefab,se as commitRemovals,K as createEntityIndex,G as createRelation,Te as createWorld,ge as deleteWorld,N as entityExists,he as getAllEntities,H as getEntityComponents,$ as getRelationTargets,ve as getWorldComponents,k as hasComponent,V as innerQuery,Oe as observe,We as onAdd,Ie as onRemove,He as pipe,Qe as query,I as registerComponent,$e as registerComponents,F as registerQuery,h as removeComponent,Pe as removeComponents,ue as removeEntity,Ae as removeQuery,Ce as resetWorld,pe as withAutoRemoveSubject,ee as withContext,_ as withEntityIndex,ce as withOnTargetRemoved,ie as withStore};
//# sourceMappingURL=index.min.mjs.map
