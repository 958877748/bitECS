var x=(e,t,n)=>Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0});var U=()=>({aliveCount:0,dense:[],sparse:[],maxId:0}),z=e=>{if(e.aliveCount<e.dense.length){let n=e.dense[e.aliveCount];return e.sparse[n]=e.aliveCount,e.aliveCount++,n}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},K=(e,t)=>{let n=e.sparse[t];if(n===void 0||n>=e.aliveCount)return;let o=n,s=e.aliveCount-1,r=e.dense[s];e.sparse[r]=o,e.dense[o]=r,e.sparse[t]=e.dense.length,e.dense[s]=t,e.aliveCount--},H=(e,t)=>{let n=e.sparse[t];return n!==void 0&&e.dense[n]===t};var m=Symbol("internal"),te=e=>{let t={entityIndex:U(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new WeakMap,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set},n=e||{};return x(n,m,t),n},ne=e=>t=>{let n=t[m];return n.entityIndex=e,t};var oe=(...e)=>{let t=r=>{let i,a=[];return r.forEach(p=>{if(typeof p=="object"&&!Array.isArray(p)&&!(p instanceof Function)){let{entityIndex:u,context:d}=p;u&&a.push(ne(u)),d&&(i=d)}else typeof p=="function"&&a.push(p)}),{context:i,modifiers:a}},{context:n,modifiers:o}=t(e),s=te(n);return o.reduce((r,i)=>i(r),s)},re=e=>{let t=e[m];return t.entityIndex=U(),t.entityMasks=[[]],t.entityComponents=new Map,t.bitflag=1,t.componentMap=new Map,t.componentCount=0,t.queries=new Set,t.queriesHashMap=new Map,t.notQueries=new Set,t.dirtyQueries=new Set,e},se=e=>Object.keys(e[m].componentMap),ae=e=>e[m].entityIndex.dense.slice(0);var w=()=>{let e=[],t=[],n=i=>e[t[i]]===i;return{add:i=>{n(i)||(t[i]=e.push(i)-1)},remove:i=>{if(!n(i))return;let a=t[i],p=e.pop();p!==i&&(e[a]=p,t[p]=a)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}};var S=()=>{let e=new Set;return{subscribe:o=>(e.add(o),()=>{e.delete(o)}),notify:(o,...s)=>{e.forEach(r=>r(o,...s))}}};var ie=(...e)=>({type:"add",components:e}),pe=(...e)=>({type:"remove",components:e});var ce=(e,t,n)=>{let o=e[m],{type:s,components:r}=t,i=P(e,r),a=o.queriesHashMap.get(i);return a||(a=F(e,r)),a[s==="add"?"addObservable":s==="remove"?"removeObservable":"setObservable"].subscribe(n)};var me=(...e)=>({type:"Not",components:e});var P=(e,t)=>{let n=e[m],o=r=>(n.componentMap.has(r)||g(e,r),n.componentMap.get(r).id),s=r=>{if("type"in r){let i=r.components.map(o).sort((a,p)=>a-p);return`${r.type}(${i.join(",")})`}else return o(r).toString()};return t.map(s).sort().join("-")},F=(e,t)=>{let n=e[m],o=P(e,t);if(n.queriesHashMap.has(o))return n.queriesHashMap.get(o);let s=[],r=[];t.forEach(c=>{c.type==="Not"?c.components.forEach(l=>{n.componentMap.has(l)||g(e,l),r.push(l)}):(n.componentMap.has(c)||g(e,c),s.push(c))});let i=c=>n.componentMap.get(c),a=s.concat(r).map(i),p=w(),u=w(),d=a.map(c=>c.generationId).reduce((c,l)=>(c.includes(l)||c.push(l),c),[]),f=(c,l)=>(c[l.generationId]||(c[l.generationId]=0),c[l.generationId]|=l.bitflag,c),N=s.map(i).reduce(f,{}),Y=r.map(i).reduce(f,{}),Z=a.reduce(f,{}),_=S(),ee=S(),T=Object.assign(p,{components:s,notComponents:r,allComponents:a,masks:N,notMasks:Y,hasMasks:Z,generations:d,toRemove:u,addObservable:_,removeObservable:ee});n.queries.add(T),n.queriesHashMap.set(o,T),a.forEach(c=>{c.queries.add(T)}),r.length&&n.notQueries.add(T);let B=n.entityIndex;for(let c=0;c<B.aliveCount;c++){let l=B.dense[c];if(M(e,E,l))continue;O(e,T,l)&&I(T,l)}return T};function D(e,t){let n=e[m],o=P(e,t),s=n.queriesHashMap.get(o);return s||(s=F(e,t)),s.dense}function ue(e,t){return V(e),D(e,t)}var O=(e,t,n)=>{let o=e[m],{masks:s,notMasks:r,generations:i}=t;for(let a=0;a<i.length;a++){let p=i[a],u=s[p],d=r[p],f=o.entityMasks[p][n];if(d&&f&d||u&&(f&u)!==u)return!1}return!0};var I=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},le=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let n=e.toRemove.dense[t];e.remove(n)}e.toRemove.reset()},V=e=>{let t=e[m];t.dirtyQueries.size&&(t.dirtyQueries.forEach(le),t.dirtyQueries.clear())},k=(e,t,n)=>{let o=e[m];!t.has(n)||t.toRemove.has(n)||(t.toRemove.add(n),o.dirtyQueries.add(t),t.removeObservable.notify(n))},de=(e,t)=>{let n=e[m],o=P(e,t),s=n.queriesHashMap.get(o);s&&(n.queries.delete(s),n.queriesHashMap.delete(o))};var C=Symbol("relation"),R=Symbol("pairTarget"),Q=Symbol("isPairComponent"),b=Symbol("internal"),G=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=n=>{if(n===void 0)throw Error("Relation target is undefined");let o=n==="*"?y:n;if(!e.pairsMap.has(o)){let s={};x(s,C,t),x(s,R,o),x(s,Q,!0),e.pairsMap.set(o,s)}return e.pairsMap.get(o)};return x(t,b,e),t},fe=e=>t=>{let n=t[b];return n.initStore=e,o=>{if(o===void 0)throw Error("Relation target is undefined");let s=o==="*"?y:o;if(!n.pairsMap.has(s)){let r=e();x(r,b,{pairTarget:s,...n}),n.pairsMap.set(s,r)}return n.pairsMap.get(s)}},ye=e=>{let t=e[b];return t.exclusiveRelation=!0,e},be=e=>{let t=e[b];return t.autoRemoveSubject=!0,e},xe=e=>t=>{let n=t[b];return n.onTargetRemoved=e,t};var h=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},y=J(),A=J(),q=(e,t,n)=>{let o=j(e,n),s=[];for(let r of o)r[C]===t&&r[R]!==y&&s.push(r[R]);return s};function J(...e){if(e.length===1&&typeof e[0]=="object"){let{store:t,exclusive:n,autoRemoveSubject:o,onTargetRemoved:s}=e[0];return[t&&fe(t),n&&ye,o&&be,s&&xe(s)].filter(Boolean).reduce((i,a)=>a(i),G())}else return e.reduce((n,o)=>o(n),G())}var g=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let n=e[m],o=new Set,s={id:n.componentCount++,generationId:n.entityMasks.length-1,bitflag:n.bitflag,ref:t,queries:o,setObservable:S()};return n.componentMap.set(t,s),n.bitflag*=2,n.bitflag>=2**31&&(n.bitflag=1,n.entityMasks.push([])),s},Re=(e,t)=>{t.forEach(n=>g(e,n))},M=(e,t,n)=>{let o=e[m],s=o.componentMap.get(t);if(!s)return!1;let{generationId:r,bitflag:i}=s;return(o.entityMasks[r][n]&i)===i},L=(e,t,n)=>{W(e,A(n),t);let o=j(e,n);for(let r of o){if(r===E)continue;W(e,r,t);let i=Object.keys(r);for(let a of i)r[a][t]=r[a][n]}let s=q(e,A,n);for(let r of s)L(e,t,r)},W=(e,t,n)=>{let o=e[m];if(!$(e,n))throw new Error("bitECS - entity does not exist in the world.");if(o.componentMap.has(t)||g(e,t),M(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:i,queries:a}=s;if(o.entityMasks[r][n]|=i,M(e,E,n)||a.forEach(p=>{p.toRemove.remove(n),O(e,p,n)?I(p,n):k(e,p,n)}),o.entityComponents.get(n).add(t),t[Q]){let p=t[C];W(e,h(p,y),n);let u=t[R];if(W(e,h(y,u),n),p[b].exclusiveRelation===!0&&u!==y){let f=q(e,p,n)[0];f!=null&&f!==u&&v(e,p(f),n)}if(p===A){let f=q(e,A,n);for(let N of f)L(e,n,N)}}},ve=(e,t,n)=>{t.forEach(o=>W(e,o,n))},v=(e,t,n)=>{let o=e[m];if(!$(e,n))throw new Error("bitECS - entity does not exist in the world.");if(!M(e,t,n))return;let s=o.componentMap.get(t),{generationId:r,bitflag:i,queries:a}=s;if(o.entityMasks[r][n]&=~i,a.forEach(p=>{p.toRemove.remove(n),O(e,p,n)?I(p,n):k(e,p,n)}),o.entityComponents.get(n).delete(t),t[Q]){let p=t[R];v(e,h(y,p),n);let u=t[C];q(e,u,n).length===0&&v(e,h(u,y),n)}},Te=(e,t,n)=>{t.forEach(o=>v(e,o,n))};var E={};var ge=e=>{let t=e[m],n=z(t.entityIndex);return t.notQueries.forEach(o=>{O(e,o,n)&&I(o,n)}),t.entityComponents.set(n,new Set),n},X=(e,t)=>{let n=e[m];if(!H(n.entityIndex,t))return;let o=[t],s=new Set;for(;o.length>0;){let r=o.shift();if(s.has(r))continue;s.add(r);let i=[];for(let a of D(e,[y(r)]))if($(e,a))for(let p of n.entityComponents.get(a)){if(!p[Q])continue;let d=p[C][b];i.push(()=>v(e,h(y,r),a)),p[R]===r&&(i.push(()=>v(e,p,a)),d.autoRemoveSubject&&o.push(a),d.onTargetRemoved&&i.push(()=>d.onTargetRemoved(e,a,r)))}for(let a of i)a();for(let a of o)X(e,a);for(let a of n.queries)k(e,a,r);K(n.entityIndex,r),n.entityComponents.delete(r);for(let a=0;a<n.entityMasks.length;a++)n.entityMasks[a][r]=0}},j=(e,t)=>{let n=e[m];if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!H(n.entityIndex,t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(n.entityComponents.get(t))},$=(e,t)=>H(e[m].entityIndex,t);var Ce=(...e)=>(...t)=>e.reduce((n,o)=>[o(...n)],t)[0];export{m as $internal,Q as $isPairComponent,R as $pairTarget,C as $relation,b as $relationData,A as IsA,me as Not,h as Pair,E as Prefab,y as Wildcard,W as addComponent,ve as addComponents,ge as addEntity,z as addEntityId,V as commitRemovals,U as createEntityIndex,J as createRelation,oe as createWorld,$ as entityExists,ae as getAllEntities,j as getEntityComponents,q as getRelationTargets,se as getWorldComponents,M as hasComponent,D as innerQuery,H as isEntityIdAlive,ye as makeExclusive,ce as observe,ie as onAdd,pe as onRemove,Ce as pipe,ue as query,g as registerComponent,Re as registerComponents,F as registerQuery,v as removeComponent,Te as removeComponents,X as removeEntity,K as removeEntityId,de as removeQuery,re as resetWorld,be as withAutoRemove,xe as withOnRemove,fe as withStore};
//# sourceMappingURL=index.min.mjs.map
